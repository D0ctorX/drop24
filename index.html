<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Générateur QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <!-- Lecteur QR Code -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* Import des polices variées pour le bouton */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&family=Oswald:wght@500&family=Courier+Prime&display=swap');

        :root {
            --primary-bg: #FAFAFA;
            --secondary-bg: #FFFFFF;
            --border-color: #DBDBDB;
            --text-color: #262626;
            --highlight-color: #3897f0;
            --last-seen-color: #8E8E8E;
            --button-border: #d4d4d4;
            --like-color: #3897f0;
            --dislike-color: #E74C3C;
            --action-color: #8e8e8e;
            --switch-off: #ccc;
            --switch-on: #5cb85c;
            --page-bg: #f0f2f5; 
            --google-btn: #4285F4;
        }

        /* Classes de polices pour JS */
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .font-oswald { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 1px; }
        .font-courier { font-family: 'Courier Prime', monospace; font-weight: bold; }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--page-bg); 
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- AUTH VIEW --- */
        #auth-view {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--primary-bg); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .auth-card {
            background: var(--secondary-bg); padding: 30px 20px;
            border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%; max-width: 350px; text-align: center;
        }
        .app-logo { font-family: 'Pacifico', cursive; font-size: 48px; margin-bottom: 30px; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--primary-bg); }
        .auth-btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary { background-color: var(--highlight-color); color: white; }
        .btn-google { background-color: var(--google-btn); color: white; }
        
        .or-divider { display: flex; align-items: center; color: var(--last-seen-color); font-size: 12px; margin: 15px 0; }
        .or-divider::before, .or-divider::after { content: ""; flex: 1; border-bottom: 1px solid var(--border-color); }
        .or-divider::before { margin-right: 10px; } .or-divider::after { margin-left: 10px; }
        
        .auth-switch-text { margin-top: 20px; font-size: 14px; }
        .auth-switch-link { color: var(--highlight-color); font-weight: 600; cursor: pointer; }

        /* --- APP CONTAINER --- */
        #app-container {
            display: none; width: 100%; height: 100%; max-width: 480px; margin: 0 auto;
            background-color: var(--primary-bg); flex-direction: column; position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;
        }
        #view-wrapper { display: flex; flex: 1; width: 100%; height: 100%; transition: transform 0.3s ease-in-out; }
        .view { display: flex; flex-direction: column; background: var(--primary-bg); width: 100%; height: 100%; flex-shrink: 0; overflow: hidden; }
        .view.secondary { position: absolute; top: 0; left: 0; right: 0; bottom: 0; transform: translateX(100%); transition: transform 0.3s; z-index: 20; visibility: hidden; }
        .view.secondary.visible { transform: translateX(0); visibility: visible; }

        .view-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--secondary-bg); border-bottom: 1px solid var(--border-color); min-height: 60px; flex-shrink: 0; z-index: 10; }
        .feed-view .view-header { flex-wrap: wrap; gap: 10px; }
        #feed-search-bar { width: 100%; display: flex; align-items: center; background: var(--page-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 0 10px; order: 3; }
        #feed-search-input { width: 100%; padding: 8px 5px; border: none; background: transparent; outline: none; }
        
        .header-title { font-size: 20px; font-weight: 600; margin: 0; text-align: center; flex-grow: 1; }
        .header-icon { font-size: 22px; cursor: pointer; width: 40px; text-align: right; }
        .header-placeholder { width: 40px; }
        .back-button { font-size: 20px; cursor: pointer; width: 40px; text-align: left; }

        /* Scroll Content */
        .feed-content, .contacts-content, .chat-content, .profile-content, #friend-requests-list {
            flex: 1 1 0; overflow-y: auto; padding-bottom: 80px;
            -webkit-overflow-scrolling: touch; -ms-overflow-style: none; scrollbar-width: none;
        }
        ::-webkit-scrollbar { display: none; }
        
        /* Nav Bar */
        .nav-bar { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background: var(--secondary-bg); border-top: 1px solid var(--border-color); z-index: 15; padding-bottom: env(safe-area-inset-bottom); height: 60px; }
        .nav-item { padding: 10px 15px; font-size: 24px; color: var(--action-color); cursor: pointer; text-align: center; transition: 0.2s; }
        .nav-item.active { color: var(--highlight-color); transform: scale(1.1); }
        .nav-item span { display: block; font-size: 10px; }

        /* Feed Items */
        .post-card { background: var(--secondary-bg); border-bottom: 1px solid var(--border-color); margin-bottom: 8px; }
        .post-header { display: flex; justify-content: space-between; padding: 10px 15px; }
        .post-publisher { font-weight: 600; }
        .post-countdown { font-size: 12px; color: var(--dislike-color); background: #fcebeb; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        .post-image-wrapper { width: 100%; padding-top: 100%; position: relative; }
        .post-content-inner { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .post-message { font-size: 22px; text-align: center; white-space: pre-wrap; word-wrap: break-word; }
        .post-actions { display: flex; padding: 8px 15px; gap: 20px; }
        .action-button { display: flex; gap: 8px; font-size: 18px; color: var(--action-color); cursor: pointer; }
        .action-button.liked i, .action-button.liked span { color: var(--like-color); }
        .action-button.disliked i, .action-button.disliked span { color: var(--dislike-color); }
        .share-btn { margin-left: auto; }

        /* Amis & FAB */
        .search-bar { padding: 10px; background: var(--primary-bg); flex-shrink: 0; }
        #search-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--secondary-bg); }
        .friend-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); }
        .friend-pp { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; }
        .friend-info { flex-grow: 1; }
        .dm-button { background: var(--highlight-color); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: 600; }
        
        #add-friend-fab {
            position: absolute; bottom: calc(80px + env(safe-area-inset-bottom)); right: 20px;
            width: 56px; height: 56px; background: var(--highlight-color); color: white;
            border-radius: 50%; border: none; font-size: 24px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 100;
        }
        .request-badge {
            position: absolute; top: -5px; right: -5px; background: var(--dislike-color); color: white;
            width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; border: 2px solid var(--secondary-bg); z-index: 101;
        }
        .request-count-badge {
            background: var(--dislike-color); color: white; font-size: 12px; font-weight: 700;
            padding: 2px 8px; border-radius: 12px; margin-left: 8px;
        }

        /* Profil */
        .profile-header { display: flex; align-items: center; padding: 15px; gap: 15px; background: var(--secondary-bg); border-bottom: 1px solid var(--border-color); }
        #profile-pic { width: 80px; height: 80px; border-radius: 50%; }
        .profile-info-main { flex-grow: 1; }
        #profile-username { font-size: 22px; font-weight: 600; margin: 0; }
        #edit-bio-btn { background: none; border: 1px solid var(--button-border); border-radius: 6px; padding: 6px 12px; margin-top: 10px; width: 100%; font-weight: 600; }
        #profile-actions { display: flex; gap: 10px; margin-top: 10px; }
        #toggle-friend-btn, #profile-dm-btn { background: none; border: 1px solid var(--button-border); border-radius: 6px; padding: 8px 12px; flex-grow: 1; font-weight: 600; }
        #profile-dm-btn { background: var(--highlight-color); color: white; border-color: var(--highlight-color); }
        .profile-stats { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .profile-details { padding: 15px; }
        #logout-btn { width: 100%; margin-top: 20px; padding: 12px; background: var(--primary-bg); color: var(--dislike-color); border: 1px solid var(--button-border); border-radius: 6px; font-weight: 600; }

        /* Create Post */
        .post-input-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: var(--secondary-bg); }
        #square-content { width: 100%; padding-top: 100%; position: relative; background: #f1f1f1; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: background-color 0.3s; }
        #post-textarea { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; background: transparent; border: none; resize: none; outline: none; text-align: center; font-size: 20px; color: var(--text-color); display: flex; align-items: center; justify-content: center; font-family: inherit; }
        .char-limit-indicator { margin-top: 10px; font-size: 12px; color: var(--last-seen-color); text-align: right; width: 100%; }
        .char-limit-indicator.error { color: var(--dislike-color); font-weight: 600; }
        .post-controls { padding: 15px 20px; background: var(--secondary-bg); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 15px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; }
        .color-swatches-container { display: flex; gap: 8px; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-swatch.selected { border-color: var(--highlight-color); box-shadow: 0 0 0 2px white; }
        .control-button { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--button-border); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        
        /* Switches */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-off); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--switch-on); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Modales */
        .modal-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 150; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: var(--secondary-bg); padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 15px; }
        .friend-option-button { display: flex; align-items: center; justify-content: space-between; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; font-weight: 600; background: white; width: 100%; margin-bottom: 8px; cursor: pointer; }
        .friend-option-button-text { display: flex; align-items: center; gap: 15px; }
        .friend-option-button i { width: 24px; text-align: center; color: var(--action-color); }
        .modal-actions { display: flex; gap: 10px; margin-top: 5px; }
        .modal-actions button { flex-grow: 1; padding: 10px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; }
        #cancel-friend-options-btn { background: #f0f0f0; }

        #toast-message { position: absolute; bottom: 80px; left: 50%; transform: translate(-50%, 100%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 200; opacity: 0; transition: 0.3s; pointer-events: none; }
        #toast-message.show { transform: translate(-50%, 0); opacity: 1; }
        
        /* Scanner UI */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; }
    </style>
</head>
<body>

    <!-- AUTH VIEW -->
    <div id="auth-view">
        <div class="auth-card">
            <h1 class="app-logo">Drop</h1>
            <div id="email-auth-form">
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-password" class="auth-input" placeholder="Mot de passe" required>
                <button id="login-btn" class="auth-btn btn-primary"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
                <div class="auth-switch-text">
                    <span id="auth-toggle-text">Pas de compte ?</span> <span id="auth-toggle-link" class="auth-switch-link">S'inscrire</span>
                </div>
            </div>
            <div class="or-divider">OU</div>
            <button id="google-btn" class="auth-btn btn-google"><i class="fab fa-google"></i> Continuer avec Google</button>
        </div>
    </div>

    <!-- APP PRINCIPALE -->
    <div id="app-container" class="container">
        <div id="view-wrapper">
            <!-- FEED -->
            <div id="feed-view" class="view feed-view">
                <div class="view-header">
                    <div class="header-placeholder"></div> 
                    <h1 class="header-title">Flux</h1>
                    <i id="create-post-header-btn" class="fas fa-feather-alt header-icon"></i>
                    <div id="feed-search-bar"><i id="feed-search-icon" class="fas fa-search"></i><input type="text" id="feed-search-input" placeholder="Rechercher des posts..."></div>
                </div>
                <div id="feed-content" class="feed-content"></div>
            </div>
            
            <!-- AMIS -->
            <div id="contacts-view" class="view contacts-view">
                <div class="view-header"><div class="header-placeholder"></div><h1 class="header-title">Amis</h1><div class="header-placeholder"></div></div>
                <div class="search-bar"><input type="text" id="search-input" placeholder="Rechercher un ami..."></div>
                <div id="friends-list" class="contacts-content"></div>
                <button id="add-friend-fab"><i class="fas fa-user-plus"></i></button>
            </div>

            <!-- PROFIL -->
            <div id="profile-view" class="view profile-view">
                <div class="view-header"><i id="my-profile-nav-item" class="fas fa-users header-icon"></i><h1 id="profile-username-header" class="header-title">Profil</h1><div class="header-placeholder"></div></div>
                <div class="profile-content">
                    <div class="profile-header">
                        <img id="profile-pic" src="" alt="Avatar">
                        <div class="profile-info-main">
                            <h2 id="profile-username">...</h2>
                            <div id="profile-actions-container">
                                <button id="edit-bio-btn">Modifier le profil</button>
                                <div id="profile-actions" style="display: none;">
                                    <button id="toggle-friend-btn">Ajouter</button>
                                    <button id="profile-dm-btn">Message</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item"><h3 id="posts-count">0</h3><p>Posts</p></div>
                        <div class="stat-item"><h3 id="followers-count">0</h3><p>Amis</p></div>
                    </div>
                    <div class="profile-details">
                        <h4>Bio</h4><p id="profile-bio">...</p>
                        <h4>Membre depuis</h4><p id="creation-date">...</p>
                        <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Se déconnecter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECONDAIRES -->
        <div id="chat-view" class="view chat-view secondary">
            <div class="view-header chat-header">
                <i id="chat-back-btn" class="fas fa-arrow-left back-button"></i>
                <img id="chat-user-pp" src="" alt="Avatar">
                <h1 id="chat-username" class="header-title">Chat</h1>
                <div class="header-placeholder"></div>
            </div>
            <div class="chat-content"><div id="chat-body"></div></div>
            <div class="chat-input"><input type="text" id="message-input" placeholder="..."><button id="send-button"><i class="fas fa-paper-plane"></i></button></div>
        </div>
        
        <div id="post-creation-view" class="view post-creation-view secondary">
            <div class="view-header">
                <i id="post-creation-back-btn" class="fas fa-arrow-left back-button"></i>
                <h1 class="header-title">Nouveau Post</h1>
                <button id="publish-button" disabled>Publier</button>
            </div>
            <div class="post-input-area">
                <div id="square-content">
                    <textarea id="post-textarea" placeholder="Exprimez-vous..." maxlength="70"></textarea>
                </div>
                <div class="char-limit-indicator"><span id="char-count">0</span> / 70</div>
            </div>
            <div class="post-controls">
                <div class="control-row"><label>Couleur</label><div class="color-swatches-container" id="post-color-swatches"></div></div>
                <div class="control-row"><label>Police</label><button class="control-button" id="font-style-button"><i class="fas fa-font"></i></button></div>
                <div class="control-row"><label>Anonyme</label><label class="switch"><input type="checkbox" id="anonymous-switch-input"><span class="slider"></span></label></div>
            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item active" data-view="feed-view"><i class="fas fa-home"></i><span>Flux</span></div>
            <div class="nav-item" data-view="contacts-view"><i class="fas fa-users"></i><span>Amis</span></div>
            <div class="nav-item" data-view="profile-view"><i class="fas fa-user"></i><span>Profil</span></div>
        </nav>
        <div id="toast-message">Message</div>
    </div>

    <!-- MODALES -->
    <div id="edit-profile-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Modifier le profil</h3>
            <input type="text" id="edit-username-input" placeholder="Nom">
            <textarea id="edit-bio-textarea" placeholder="Bio"></textarea>
            <div id="edit-color-swatches"></div>
            <div class="modal-actions"><button id="cancel-edit-btn">Annuler</button><button id="save-profile-btn">Enregistrer</button></div>
        </div>
    </div>
    
    <div id="friend-options-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Options d'amis</h3>
            <button id="show-friend-requests" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-bell"></i><span>Demandes</span></div><span id="pending-requests-count-badge" class="request-count-badge" style="display: none;">0</span></button>
            <button id="open-scanner-btn" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-camera"></i><span>Scanner QR</span></div></button>
            <button id="scan-qr-code" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-id-card"></i><span>Ajouter par ID</span></div></button>
            <button id="share-profile-link" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-share-alt"></i><span>Inviter (Lien)</span></div></button>
            <button id="show-my-qr" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-qrcode"></i><span>Mon QR Code</span></div></button>
            <div class="modal-actions"><button id="cancel-friend-options-btn">Annuler</button></div>
        </div>
    </div>
    
    <div id="qr-code-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Mon QR Code</h3><canvas id="qr-code-canvas"></canvas>
            <p style="text-align: center; font-size: 14px;">Scan pour m'ajouter !</p>
            <div class="modal-actions"><button id="close-qr-modal-btn">Fermer</button></div>
        </div>
    </div>

    <div id="scanner-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Scanner un QR</h3>
            <div id="reader"></div>
            <div class="modal-actions"><button id="close-scanner-btn">Fermer</button></div>
        </div>
    </div>
    
    <div id="paste-id-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Ajouter par ID</h3>
            <input type="text" id="paste-id-input" placeholder="ID de l'ami">
            <div class="modal-actions"><button id="cancel-paste-id-btn">Annuler</button><button id="send-friend-request-btn">Envoyer</button></div>
        </div>
    </div>
    
    <div id="friend-requests-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Demandes</h3>
            <div id="friend-requests-list"></div>
            <div class="modal-actions"><button id="cancel-friend-requests-btn">Fermer</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, orderBy, arrayUnion, arrayRemove, writeBatch, serverTimestamp, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyB_z5U4yKJERho93p9696NujcG5R5fvlD8",
            authDomain: "studio-3374032724-f28d6.firebaseapp.com",
            projectId: "studio-3374032724-f28d6",
            storageBucket: "studio-3374032724-f28d6.appspot.com",
            messagingSenderId: "541715107757",
            appId: "1:541715107757:web:0141b71ee3cd1ce5ec5b24"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const usersCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/users`);
        const postsCollectionRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/posts`);
        const dbPath = `artifacts/${firebaseConfig.appId}/public/data`;

        const PROFILE_COLORS = ['#e57373', '#81c784', '#64b5f6', '#f06292', '#ba68c8', '#ffd54f', '#7986cb', '#4db6ac', '#9575cd', '#4fc3f7'];
        // Modif 1: Polices différentes
        const POST_FONT_FAMILIES = ['font-inter', 'font-pacifico', 'font-oswald', 'font-courier'];
        const POST_COLOR_PALETTE = ['#f1f1f1', '#D6E9F7', '#D1F7D1', '#FFF7D1', '#F7D1D1', '#A0D4FE', '#84E084', '#FEEA84', '#FE8484'];
        // Modif 2: Limite 70
        const MAX_CHARS = 70;

        let currentUserId = null, activeProfileUserId = null, usersData = {}, postsData = [];
        let html5QrcodeScanner = null;
        let currentPostFontIndex = 0, currentPostColor = POST_COLOR_PALETTE[0], isAnonymousPost = false;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('auth-view').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                await upsertUserDocument(user);
                
                const urlParams = new URLSearchParams(window.location.search);
                const friendIdToAdd = urlParams.get('add_friend');
                if (friendIdToAdd && friendIdToAdd !== currentUserId) {
                    showMessage("Traitement du lien d'invitation...", true);
                    await sendFriendRequest(friendIdToAdd);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                listenToData();
                navigateTo('feed-view');
            } else {
                currentUserId = null;
                document.getElementById('auth-view').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        function listenToData() {
            onSnapshot(usersCollectionRef, (snap) => {
                snap.docChanges().forEach(change => usersData[change.doc.id] = {id: change.doc.id, ...change.doc.data()});
                renderFriendsList();
                if(activeProfileUserId) showProfile(activeProfileUserId);
            });
            onSnapshot(collection(db, dbPath, 'users', currentUserId, 'friendRequests'), (snap) => {
                let count = 0;
                const list = document.getElementById('friend-requests-list');
                list.innerHTML = '';
                if (snap.empty) list.innerHTML = "<p style='text-align:center;color:gray;padding:10px;'>Rien ici.</p>";
                snap.forEach(d => {
                    count++;
                    const req = d.data();
                    const u = usersData[req.senderId] || {username: '...'};
                    list.innerHTML += `<div class="friend-request-item"><div class="friend-request-info"><img src="${getAvatar(u)}"><span>${u.username}</span></div><div class="friend-request-actions"><button class="request-accept-btn" data-id="${req.senderId}"><i class="fas fa-check"></i></button><button class="request-reject-btn" data-id="${req.senderId}"><i class="fas fa-times"></i></button></div></div>`;
                });
                const badge = document.getElementById('pending-requests-count-badge');
                const fabBadge = document.querySelector('#add-friend-fab .request-badge');
                if (count > 0) {
                    badge.style.display = 'inline-block'; badge.textContent = count;
                    if(!fabBadge) document.getElementById('add-friend-fab').innerHTML += `<div class="request-badge">${count}</div>`;
                    else fabBadge.textContent = count;
                } else {
                    badge.style.display = 'none';
                    if(fabBadge) fabBadge.remove();
                }
            });
            onSnapshot(query(postsCollectionRef, orderBy('createdAt', 'desc')), (snap) => {
                postsData = [];
                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    if (p.createdAt?.toDate().getTime() > Date.now() - 86400000) {
                         p.expiresAt = new Date(p.createdAt.toDate().getTime() + 86400000);
                         postsData.push(p);
                    }
                });
                renderFeed();
            });
        }

        document.getElementById('login-btn').onclick = async () => {
            const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } catch { 
                try { await createUserWithEmailAndPassword(auth, e, p); showMessage("Compte créé", true); } 
                catch(err) { showMessage(err.message, false); }
            }
        };
        document.getElementById('google-btn').onclick = async () => {
             try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
             catch(e) { if(e.code==='auth/unauthorized-domain') prompt("Ajoutez ce domaine:", window.location.hostname); else showMessage(e.message, false); }
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        
        document.getElementById('share-profile-link').onclick = async () => {
            const url = `${window.location.origin}${window.location.pathname}?add_friend=${currentUserId}`;
            if (navigator.share) {
                try { await navigator.share({ title: 'Rejoins-moi sur Drop !', url: url }); } catch {}
            } else {
                navigator.clipboard.writeText(url);
                showMessage("Lien copié !", true);
            }
        };
        
        document.getElementById('show-my-qr').onclick = () => {
            const url = `${window.location.origin}${window.location.pathname}?add_friend=${currentUserId}`;
            QRCode.toCanvas(document.getElementById('qr-code-canvas'), url, {width: 200}, (err) => {
                if(!err) { hideModal('friend-options-modal'); showModal('qr-code-modal'); }
            });
        };
        
        document.getElementById('open-scanner-btn').onclick = () => {
            hideModal('friend-options-modal');
            showModal('scanner-modal');
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decodedText) => {
                    html5QrcodeScanner.stop().then(() => hideModal('scanner-modal'));
                    try {
                        const url = new URL(decodedText);
                        const id = url.searchParams.get('add_friend');
                        if (id) sendFriendRequest(id);
                        else showMessage("QR Code invalide", false);
                    } catch {
                        sendFriendRequest(decodedText); 
                    }
                },
                (errorMessage) => { }
            ).catch(err => {
                hideModal('scanner-modal');
                showMessage("Impossible d'accéder à la caméra", false);
            });
        };
        
        document.getElementById('close-scanner-btn').onclick = () => {
            if(html5QrcodeScanner) html5QrcodeScanner.stop().then(() => hideModal('scanner-modal'));
            else hideModal('scanner-modal');
        };

        document.getElementById('create-post-header-btn').onclick = () => {
            const div = document.getElementById('post-color-swatches'); div.innerHTML='';
            POST_COLOR_PALETTE.forEach(c => {
                const s = document.createElement('div'); s.className='color-swatch'; s.style.backgroundColor=c;
                s.onclick = () => { currentPostColor=c; document.getElementById('square-content').style.backgroundColor=c; };
                div.appendChild(s);
            });
            document.getElementById('square-content').style.backgroundColor = currentPostColor;
            document.querySelector('.post-creation-view').classList.add('visible');
        };
        
        document.getElementById('font-style-button').onclick = () => {
            const ta = document.getElementById('post-textarea');
            ta.classList.remove(POST_FONT_FAMILIES[currentPostFontIndex]);
            currentPostFontIndex = (currentPostFontIndex+1)%POST_FONT_FAMILIES.length;
            ta.classList.add(POST_FONT_FAMILIES[currentPostFontIndex]);
        };
        
        document.getElementById('publish-button').onclick = async () => {
            const txt = document.getElementById('post-textarea').value;
            if(!txt) return;
            await addDoc(postsCollectionRef, {
                message: txt,
                publisherId: document.getElementById('anonymous-switch-input').checked ? null : currentUserId,
                createdAt: serverTimestamp(),
                backgroundColor: currentPostColor,
                fontClass: POST_FONT_FAMILIES[currentPostFontIndex],
                likedBy: [], dislikedBy: []
            });
            const uRef = doc(usersCollectionRef, currentUserId);
            const uSnap = await getDoc(uRef);
            if(uSnap.exists()) await updateDoc(uRef, { postsCount: (uSnap.data().postsCount || 0) + 1 });

            document.getElementById('post-textarea').value='';
            document.querySelector('.post-creation-view').classList.remove('visible');
            showMessage("Publié !", true);
        };
        
        async function upsertUserDocument(user) {
            const ref = doc(usersCollectionRef, user.uid);
            if (!(await getDoc(ref)).exists()) {
                await setDoc(ref, { username: user.displayName||'User', bio: '...', profileColor: PROFILE_COLORS[0], friends: [], postsCount: 0, accountCreatedAt: serverTimestamp() });
            }
        }
        
        async function sendFriendRequest(targetId) {
            if(targetId === currentUserId || usersData[currentUserId].friends.includes(targetId)) return showMessage("Impossible", false);
            try {
                const ref = doc(db, dbPath, 'users', targetId, 'friendRequests', currentUserId);
                if ((await getDoc(ref)).exists()) return showMessage("Déjà envoyé", false);
                await setDoc(ref, { senderId: currentUserId, timestamp: serverTimestamp() });
                showMessage("Demande envoyée !", true);
            } catch { showMessage("Erreur (ID invalide ?)", false); }
        }

        function renderFeed() {
            const content = document.getElementById('feed-content');
            const term = document.getElementById('feed-search-input').value.toLowerCase();
            const filtered = term ? postsData.filter(p => p.message.toLowerCase().includes(term)) : postsData;
            content.innerHTML = filtered.map(p => {
                const u = p.publisherId ? (usersData[p.publisherId]?.username || '...') : 'Anonyme';
                const il = p.likedBy?.includes(currentUserId) ? 'liked' : '';
                const id = p.dislikedBy?.includes(currentUserId) ? 'disliked' : '';
                return `<div class="post-card" data-id="${p.id}">
                    <div class="post-header"><span class="post-publisher">${u}</span><span class="post-countdown">24h</span></div>
                    <div class="post-image-wrapper"><div class="post-content-inner" style="background:${p.backgroundColor}">
                        <p class="post-message ${p.fontClass}">${p.message}</p>
                    </div></div>
                    <div class="post-actions">
                        <div class="action-button ${il}" onclick="rate('${p.id}','like')"><i class="fas fa-thumbs-up"></i> ${p.likedBy?.length||0}</div>
                        <div class="action-button ${id}" onclick="rate('${p.id}','dislike')"><i class="fas fa-thumbs-down"></i> ${p.dislikedBy?.length||0}</div>
                        <div class="action-button share-btn" onclick="sharePost('${p.message}')"><i class="fas fa-share-square"></i></div>
                    </div>
                </div>`
            }).join('');
        }

        window.rate = async (pid, type) => {
            const ref = doc(postsCollectionRef, pid);
            const field = type === 'like' ? 'likedBy' : 'dislikedBy';
            const p = postsData.find(x => x.id === pid);
            if(p[field]?.includes(currentUserId)) await updateDoc(ref, { [field]: arrayRemove(currentUserId) });
            else await updateDoc(ref, { [field]: arrayUnion(currentUserId) });
        }
        window.sharePost = async (msg) => {
             if(navigator.share) try { await navigator.share({text: `Sur Drop : "${msg}"`}); } catch {}
        }

        document.getElementById('friend-requests-list').onclick = async (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            const sid = btn.dataset.id;
            const myRef = doc(usersCollectionRef, currentUserId), sRef = doc(usersCollectionRef, sid);
            const reqRef = doc(db, dbPath, 'users', currentUserId, 'friendRequests', sid);
            if (btn.classList.contains('request-accept-btn')) {
                const batch = writeBatch(db);
                batch.update(myRef, {friends: arrayUnion(sid)});
                batch.update(sRef, {friends: arrayUnion(currentUserId)});
                batch.delete(reqRef);
                await batch.commit(); showMessage("Ami ajouté", true);
            } else {
                await deleteDoc(reqRef); showMessage("Refusé", true);
            }
        };

        const nav = (id) => {
            document.querySelectorAll('.view').forEach(v => v.style.transform = 'translateX(100%)');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const idx = ['feed-view','contacts-view','profile-view'].indexOf(id);
            document.getElementById('view-wrapper').style.transform = `translateX(-${idx * 100}%)`;
            document.querySelector(`.nav-item[data-view="${id}"]`).classList.add('active');
            if(id === 'profile-view') showProfile(currentUserId);
        };
        document.querySelectorAll('.nav-item').forEach(n => n.onclick = () => nav(n.dataset.view));
        
        function getAvatar(u) { return `https://ui-avatars.com/api/?name=${u.username}&background=${u.profileColor?.replace('#','')||'000'}&color=fff`; }
        function showProfile(uid) {
            const u = usersData[uid]; if(!u) return;
            activeProfileUserId = uid;
            document.getElementById('profile-username').innerText = u.username;
            document.getElementById('profile-bio').innerText = u.bio;
            document.getElementById('profile-pic').src = getAvatar(u);
            document.getElementById('posts-count').innerText = u.postsCount || 0;
            document.getElementById('followers-count').innerText = u.friends?.length || 0;
            
            const isMe = uid === currentUserId;
            document.getElementById('edit-bio-btn').style.display = isMe ? 'block' : 'none';
            document.getElementById('logout-btn').style.display = isMe ? 'block' : 'none';
            document.getElementById('profile-actions').style.display = isMe ? 'none' : 'flex';
            if(!isMe) {
                const btn = document.getElementById('toggle-friend-btn');
                const isFriend = usersData[currentUserId].friends.includes(uid);
                btn.innerText = isFriend ? 'Retirer' : 'Ajouter (Demande)';
                btn.onclick = async () => {
                    if(isFriend) {
                         const batch = writeBatch(db);
                         batch.update(doc(usersCollectionRef, currentUserId), {friends: arrayRemove(uid)});
                         batch.update(doc(usersCollectionRef, uid), {friends: arrayRemove(currentUserId)});
                         await batch.commit();
                    } else sendFriendRequest(uid);
                }
            }
            nav('profile-view');
        }

        function showModal(id) { document.getElementById(id).style.display='flex'; }
        function hideModal(id) { document.getElementById(id).style.display='none'; }
        function showMessage(msg, success) {
            const t = document.getElementById('toast-message');
            t.innerText = msg; t.classList.add('show');
            t.style.background = success ? '#28a745' : '#dc3545';
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        document.getElementById('add-friend-fab').onclick = () => showModal('friend-options-modal');
        document.getElementById('cancel-friend-options-btn').onclick = () => hideModal('friend-options-modal');
        document.getElementById('show-friend-requests').onclick = () => { hideModal('friend-options-modal'); showModal('friend-requests-modal'); };
        document.getElementById('cancel-friend-requests-btn').onclick = () => hideModal('friend-requests-modal');
        document.getElementById('close-qr-modal-btn').onclick = () => hideModal('qr-code-modal');
        document.getElementById('scan-qr-code').onclick = () => { hideModal('friend-options-modal'); showModal('paste-id-modal'); };
        document.getElementById('cancel-paste-id-btn').onclick = () => hideModal('paste-id-modal');
        document.getElementById('send-friend-request-btn').onclick = () => { sendFriendRequest(document.getElementById('paste-id-input').value); hideModal('paste-id-modal'); };
        document.getElementById('post-creation-back-btn').onclick = () => document.querySelector('.post-creation-view').classList.remove('visible');
        
        // Validation caractères et bouton publier
        document.getElementById('post-textarea').oninput = function() { 
            const len = this.value.length;
            document.getElementById('char-count').innerText = len; 
            document.getElementById('publish-button').disabled = len > MAX_CHARS || len === 0; 
        };
        
        document.getElementById('edit-bio-btn').onclick = () => {
             const u = usersData[currentUserId];
             document.getElementById('edit-username-input').value = u.username;
             document.getElementById('edit-bio-textarea').value = u.bio;
             const d = document.getElementById('edit-color-swatches'); d.innerHTML='';
             PROFILE_COLORS.forEach(c => {
                 const s = document.createElement('div'); s.className='edit-color-swatch'; s.style.background=c;
                 s.onclick = () => { d.querySelectorAll('.selected').forEach(x=>x.classList.remove('selected')); s.classList.add('selected'); };
                 if(c === u.profileColor) s.classList.add('selected');
                 d.appendChild(s);
             });
             showModal('edit-profile-modal');
        };
        document.getElementById('cancel-edit-btn').onclick = () => hideModal('edit-profile-modal');
        document.getElementById('save-profile-btn').onclick = async () => {
            const name = document.getElementById('edit-username-input').value;
            const bio = document.getElementById('edit-bio-textarea').value;
            const col = document.querySelector('.edit-color-swatch.selected')?.style.backgroundColor;
            if(name.length < 3) return showMessage("Nom trop court", false);
            await updateDoc(doc(usersCollectionRef, currentUserId), { username: name, bio: bio, profileColor: col || PROFILE_COLORS[0] });
            hideModal('edit-profile-modal'); showMessage("Sauvegardé", true);
        };

    </script>
</body>
</html>
