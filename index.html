<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="google-site-verification" content="lULIZecjpMCUjs1v3f7cUVpNzZf0cceze-bv5Zkq9Qs" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <!-- HTML2Canvas pour la génération d'image -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@700&family=Pacifico&display=swap');

        :root {
            --primary-bg: #FAFAFA;
            --accent-color: #007AFF;
            --secondary-text: #8E8E93;
            --card-bg: #FFFFFF;
            --border-color: #E5E5EA;
            --danger-color: #FF3B30;
            --safe-color: #34C759;
            --nav-height: 65px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--primary-bg);
            color: #000;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- NAVIGATION --- */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #fff;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
        }

        #app-name {
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: -1px;
            color: var(--accent-color);
            cursor: pointer;
        }

        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: #fff;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            font-size: 0.7rem;
            cursor: pointer;
            transition: 0.2s;
            flex: 1;
        }

        .nav-item.active {
            color: var(--accent-color);
        }

        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }

        /* --- VUES --- */
        .view {
            position: absolute;
            top: 60px;
            bottom: var(--nav-height);
            left: 0;
            right: 0;
            overflow-y: auto;
            background: var(--primary-bg);
            display: none;
            padding-bottom: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .view.active {
            display: block;
        }

        /* --- POSTS --- */
        .posts-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
        }

        .post-card {
            background: #fff;
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .post-header {
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .post-user {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .post-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
        }

        .post-username {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .post-content {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            font-weight: 700;
            overflow: hidden;
        }

        .post-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .post-text-overlay {
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 4px rgba(0,0,0,0.2);
            width: 100%;
            word-wrap: break-word;
            font-size: 1.2rem;
        }

        .post-actions {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-top: 1px solid #f8f8f8;
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #555;
            padding: 5px;
            transition: 0.2s;
        }

        .action-btn.active-like { color: var(--accent-color); }
        .action-btn.active-dislike { color: var(--danger-color); }

        .view-count-pill {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: var(--secondary-text);
        }

        /* --- GRILLE PROFIL --- */
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            padding: 2px;
            background: #fff;
        }

        .grid-item {
            aspect-ratio: 1/1;
            background: #f0f0f0;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .grid-item-text {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            font-size: 0.6rem;
            text-align: center;
            color: #fff;
            word-break: break-all;
        }

        .grid-view-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.5);
            color: #fff;
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* --- PROFIL HEADER --- */
        .profile-header {
            padding: 20px;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-main-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-name { font-size: 1.3rem; font-weight: 700; margin: 0; }
        .profile-bio { font-size: 0.9rem; color: var(--secondary-text); margin: 8px 0 15px 0; max-width: 80%; line-height: 1.4; }
        .profile-stats { display: flex; gap: 40px; margin-bottom: 10px; }
        .stat-item { text-align: center; cursor: pointer; }
        .stat-val { font-weight: 700; font-size: 1.1rem; display: block; }
        .stat-label { font-size: 0.75rem; color: var(--secondary-text); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- MODALES / SECONDARY VIEWS --- */
        .secondary-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .secondary-view.active {
            transform: translateY(0);
        }

        .view-header {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 1px solid var(--border-color);
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .view-title { flex: 1; text-align: center; font-weight: 700; font-size: 1rem; }
        .close-btn { font-size: 1.4rem; cursor: pointer; width: 40px; color: #333; }

        /* --- GROUPES --- */
        .group-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f2f2f2;
            gap: 12px;
            cursor: pointer;
            background: #fff;
        }

        .group-avatar-circle {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: #eef3ff;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .group-info { flex: 1; }
        .group-name-text { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
        .group-last-msg { font-size: 0.8rem; color: var(--secondary-text); }

        .group-edit-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-ok {
            background: var(--safe-color);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        /* --- MINI MENU (ACTION SHEET) --- */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            z-index: 3000;
            padding: 20px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            transform: translateY(100%);
            transition: 0.3s;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
        }

        .action-sheet.active { transform: translateY(0); }
        .sheet-option { padding: 18px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; cursor: pointer; font-weight: 600; font-size: 1rem; }
        .sheet-option:last-child { border: none; }
        .sheet-option.danger { color: var(--danger-color); }
        .sheet-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2999; display: none; }

        /* --- PAGE INFOS --- */
        .info-page-body { padding: 20px; }
        .stat-card { background: #f9f9f9; border-radius: 15px; padding: 15px; margin-bottom: 20px; border: 1px solid #eee; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .stat-row:last-child { border: none; }
        .stat-label-info { color: var(--secondary-text); font-size: 0.9rem; }
        .stat-value-info { font-weight: 700; }
        .suspect-list { margin-top: 15px; }
        .suspect-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f2f2f2; }
        .suspect-avatar { width: 35px; height: 35px; border-radius: 50%; }

        /* --- MISC --- */
        .primary-btn { width: 100%; background: var(--accent-color); color: #fff; border: none; padding: 15px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .secondary-btn { width: 100%; background: #f0f0f0; color: #333; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; outline: none; background: #fff; }
        
        #toast {
            position: fixed;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 10px 22px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .creation-square {
            width: 100%;
            aspect-ratio: 1/1;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        #post-textarea {
            border: none;
            background: transparent;
            text-align: center;
            font-weight: 800;
            font-size: 1.4rem;
            resize: none;
            width: 90%;
            height: auto;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            z-index: 2;
        }

        .friends-list { padding: 10px; }
        .friend-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 10px;
            background: #fff;
            gap: 15px;
            cursor: pointer;
            border: 1px solid #f0f0f0;
            transition: 0.2s;
        }

        .friend-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .friend-name { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
        .friend-bio-snippet { font-size: 0.8rem; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .font-opt {
            padding: 8px 15px;
            border-radius: 20px;
            border: 1.5px solid #eee;
            background: #fff;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .font-opt.selected { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

        .color-dot {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 3px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.15);
            cursor: pointer;
        }
        .color-dot.selected { border-color: #333; }
    </style>
</head>
<body>

    <!-- BARRE HAUTE -->
    <div id="top-bar">
        <div id="app-name" onclick="switchView('flux')">Drop</div>
        <div style="display: flex; gap: 18px; align-items: center;">
            <i class="fas fa-plus-square" style="font-size: 1.6rem; color: #333;" onclick="showPostCreation()"></i>
            <i class="fas fa-search" style="font-size: 1.4rem; color: #333;" onclick="showSearchView()"></i>
        </div>
    </div>

    <!-- NAVIGATION BASSE -->
    <div id="bottom-nav">
        <div class="nav-item active" onclick="switchView('flux', this)">
            <i class="fas fa-home"></i>
            <span>Flux</span>
        </div>
        <div class="nav-item" onclick="switchView('friends', this)">
            <i class="fas fa-user-friends"></i>
            <span>Amis</span>
        </div>
        <div class="nav-item" onclick="switchView('groups', this)">
            <i class="fas fa-layer-group"></i>
            <span>Groupes</span>
        </div>
        <div class="nav-item" onclick="switchView('profile', this)">
            <i class="fas fa-user-circle"></i>
            <span>Profil</span>
        </div>
    </div>

    <!-- VUES PRINCIPALES -->
    <div id="view-flux" class="view active">
        <div class="posts-container" id="posts-feed"></div>
    </div>

    <div id="view-friends" class="view">
        <div id="friends-view-content">
            <div style="padding: 30px; text-align: center; color: var(--secondary-text);">Chargement...</div>
        </div>
    </div>

    <div id="view-groups" class="view">
        <div style="padding: 15px;">
            <button class="primary-btn" onclick="showCreateGroup()" style="margin-bottom: 20px;">+ Nouveau Groupe</button>
            <div id="groups-list"></div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <div id="profile-content"></div>
    </div>

    <!-- VUES SECONDAIRES -->
    
    <!-- Création de Post -->
    <div id="post-creation-view" class="secondary-view">
        <div class="view-header">
            <i class="fas fa-times close-btn" onclick="hideSecondaryView(postCreationView)"></i>
            <div class="view-title">Nouveau Drop</div>
            <button id="publish-btn" style="color: var(--accent-color); background: none; border: none; font-weight: 800; font-size: 1rem;" onclick="handlePublish()">Publier</button>
        </div>
        <div style="padding: 20px; flex: 1; overflow-y: auto;">
            <div class="creation-square" id="post-square-content">
                <textarea id="post-textarea" placeholder="Exprime-toi..." maxlength="180"></textarea>
                <img id="post-img-preview" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index: 1;">
            </div>
            
            <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px;" id="font-list"></div>
            <div style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 20px;" id="color-palette"></div>
            
            <div style="display: flex; gap: 12px;">
                <button class="secondary-btn" onclick="document.getElementById('post-img-input').click()"><i class="fas fa-image"></i> Photo</button>
                <input type="file" id="post-img-input" accept="image/*" style="display:none" onchange="previewImage(this)">
                <button class="secondary-btn" onclick="resetPostContent()"><i class="fas fa-trash-alt"></i></button>
            </div>

            <div style="margin-top: 25px; display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f5f5f7; border-radius: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-user-secret" style="font-size: 1.2rem;"></i>
                    <span style="font-weight: 600;">Publication anonyme</span>
                </div>
                <input type="checkbox" id="anonymous-switch" style="width: 25px; height: 25px;">
            </div>
        </div>
    </div>

    <!-- Recherche -->
    <div id="search-view" class="secondary-view">
        <div class="view-header">
            <i class="fas fa-times close-btn" onclick="hideSecondaryView(searchView)"></i>
            <div class="view-title">Découvrir</div>
        </div>
        <div style="padding: 15px;">
            <input type="text" id="search-input" placeholder="Rechercher un membre..." oninput="handleSearch(this.value)">
            <div id="search-results" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Chat de Groupe -->
    <div id="chat-view" class="secondary-view">
        <div class="view-header" id="chat-header"></div>
        <div id="chat-messages" style="flex:1; overflow-y:auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #fcfcfc;"></div>
        <div style="padding: 12px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; background: #fff; padding-bottom: calc(12px + env(safe-area-inset-bottom));">
            <input type="text" id="chat-input" placeholder="Écrire un message..." style="flex:1;">
            <button onclick="sendChatMessage()" style="background: var(--accent-color); color: #fff; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 1.1rem;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- Paramètres Profil -->
    <div id="settings-view" class="secondary-view">
        <div class="view-header">
            <i class="fas fa-times close-btn" onclick="hideSecondaryView(settingsView)"></i>
            <div class="view-title">Modifier Profil</div>
            <button onclick="saveSettings()" style="color: var(--accent-color); background: none; border: none; font-weight: 800;">OK</button>
        </div>
        <div style="padding: 20px;">
            <div style="text-align: center; margin-bottom: 25px;">
                <img id="settings-avatar-preview" src="" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color);">
                <p style="color: var(--accent-color); font-size: 0.8rem; margin-top: 5px; font-weight: 600;" onclick="promptAvatar()">Changer la photo</p>
            </div>
            <label style="font-size: 0.8rem; font-weight: 700; color: #666; margin-left: 5px;">NOM D'UTILISATEUR</label>
            <input type="text" id="set-username" style="margin-bottom: 20px; margin-top: 5px;">
            
            <label style="font-size: 0.8rem; font-weight: 700; color: #666; margin-left: 5px;">BIO</label>
            <textarea id="set-bio" rows="4" style="margin-bottom: 20px; margin-top: 5px;"></textarea>
            
            <button class="secondary-btn" style="color: var(--danger-color);" onclick="auth.signOut()">Déconnexion</button>
        </div>
    </div>

    <!-- Page Infos Publication -->
    <div id="post-info-view" class="secondary-view">
        <div class="view-header">
            <i class="fas fa-arrow-left close-btn" onclick="hideSecondaryView(postInfoView)"></i>
            <div class="view-title">Stats de la publication</div>
        </div>
        <div id="post-info-body" class="info-page-body"></div>
    </div>

    <!-- Action Sheet / Menu -->
    <div class="sheet-overlay" id="sheet-overlay" onclick="closeActionSheet()"></div>
    <div class="action-sheet" id="action-sheet">
        <div id="sheet-content"></div>
    </div>

    <div id="toast">C'est fait !</div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'drop-social-app';

        // Collections
        const usersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
        const postsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
        const groupsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'groups');

        // État Local
        let currentUserId = null;
        let userData = null;
        let activeView = 'flux';
        let currentPostColor = '#FF5E5E';
        let currentPostFontIndex = 0;
        let currentImageBase64 = null;
        let currentChatGroupId = null;

        const POST_COLORS = ['#FF5E5E', '#FFBB5C', '#5CFF7B', '#5CCFFF', '#9C5CFF', '#FF5CAD', '#333333', '#FFFFFF'];
        const POST_FONT_FAMILIES = ['Inter', 'Roboto', 'Montserrat', 'Pacifico', 'monospace'];

        // Éléments DOM
        const views = {
            flux: document.getElementById('view-flux'),
            friends: document.getElementById('view-friends'),
            groups: document.getElementById('view-groups'),
            profile: document.getElementById('view-profile')
        };
        const postCreationView = document.getElementById('post-creation-view');
        const searchView = document.getElementById('search-view');
        const chatView = document.getElementById('chat-view');
        const settingsView = document.getElementById('settings-view');
        const postInfoView = document.getElementById('post-info-view');
        const postsFeed = document.getElementById('posts-feed');
        const postTextarea = document.getElementById('post-textarea');
        const postImgInput = document.getElementById('post-img-input');
        const postImgPreview = document.getElementById('post-img-preview');
        const anonymousSwitch = document.getElementById('anonymous-switch');
        const publishButton = document.getElementById('publish-btn');
        const squareContent = document.getElementById('post-square-content');
        const sheetOverlay = document.getElementById('sheet-overlay');
        const actionSheet = document.getElementById('action-sheet');
        const sheetContent = document.getElementById('sheet-content');

        // Initialisation Authentification
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                await checkUserProfile();
                setupRealtimeListeners();
            } else {
                initAuth();
            }
        });

        async function checkUserProfile() {
            const uRef = doc(usersCollectionRef, currentUserId);
            const snap = await getDoc(uRef);
            if (!snap.exists()) {
                const initial = {
                    username: "Anonyme_" + Math.floor(Math.random() * 9999),
                    bio: "Je suis nouveau sur Drop !",
                    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=" + currentUserId,
                    friends: [],
                    blocked: [],
                    postsCount: 0,
                    joinedAt: serverTimestamp()
                };
                await setDoc(uRef, initial);
                userData = initial;
            } else {
                userData = snap.data();
            }
        }

        function setupRealtimeListeners() {
            // Écoute des posts
            onSnapshot(postsCollectionRef, (snap) => {
                const allPosts = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderFlux(allPosts);
            });

            // Écoute du profil personnel
            onSnapshot(doc(usersCollectionRef, currentUserId), (snap) => {
                if(snap.exists()) {
                    userData = snap.data();
                    if(activeView === 'profile') renderMyProfile();
                    if(activeView === 'friends') renderFriendsView();
                }
            });

            // Écoute des groupes
            onSnapshot(groupsCollectionRef, (snap) => {
                const groups = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderGroups(groups);
            });
        }

        // --- NAVIGATION ---
        window.switchView = (v, el) => {
            activeView = v;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            else {
                // Si pas d'élément passé, on cherche celui correspondant au texte
                const items = document.querySelectorAll('.nav-item');
                items.forEach(item => {
                    if(item.textContent.toLowerCase().includes(v)) item.classList.add('active');
                });
            }
            
            Object.keys(views).forEach(k => views[k].classList.remove('active'));
            views[v].classList.add('active');

            if(v === 'profile') renderMyProfile();
            if(v === 'friends') renderFriendsView();
            if(v === 'groups') {}
        };

        window.showSecondaryView = (view) => { view.classList.add('active'); };
        window.hideSecondaryView = (view) => { view.classList.remove('active'); };

        window.showMessage = (msg, isSuccess = true) => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = isSuccess ? 'rgba(52, 199, 89, 0.95)' : 'rgba(255, 59, 48, 0.95)';
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        };

        // --- FLUX & PUBLICATIONS ---
        function renderFlux(posts) {
            postsFeed.innerHTML = "";
            const sorted = posts.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            
            sorted.forEach(p => {
                // Cacher si bloqué
                if(userData.blocked && (userData.blocked.includes(p.publisherId) || userData.blocked.includes(currentUserId))) return;

                const card = document.createElement('div');
                card.className = "post-card";
                card.dataset.id = p.id;
                
                let userBlock = `<div class="post-user">
                    <img class="post-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=anon">
                    <span class="post-username">Anonyme</span>
                </div>`;

                if(!p.isAnon && p.publisherId) {
                    userBlock = `<div class="post-user" onclick="openProfile('${p.publisherId}')">
                        <img class="post-avatar avatar-${p.publisherId}" src="">
                        <span class="post-username name-${p.publisherId}">Chargement...</span>
                    </div>`;
                    fetchUserData(p.publisherId).then(u => {
                        if(u) {
                            const avs = card.querySelectorAll(`.avatar-${p.publisherId}`);
                            const nms = card.querySelectorAll(`.name-${p.publisherId}`);
                            avs.forEach(a => a.src = u.avatar);
                            nms.forEach(n => n.textContent = u.username);
                        }
                    });
                }

                // Enregistrer la vue si pas déjà fait
                trackView(p.id, p.viewedBy);

                const hasLiked = p.likedBy?.includes(currentUserId);
                const hasDisliked = p.dislikedBy?.includes(currentUserId);
                const viewsCount = p.viewedBy ? p.viewedBy.length : 0;

                card.innerHTML = `
                    <div class="post-header">
                        ${userBlock}
                        <i class="fas fa-ellipsis-h" style="color:#aaa; cursor:pointer;" onclick="showPostOptions('${p.id}', '${p.publisherId}')"></i>
                    </div>
                    <div class="post-content" style="background-color: ${p.backgroundColor || '#eee'};">
                        ${p.imageBase64 ? `<img src="${p.imageBase64}" class="post-image">` : ''}
                        <div class="post-text-overlay" style="font-family: '${p.fontClass || 'Inter'}'; color: ${isDark(p.backgroundColor) ? '#fff' : '#333'}">${p.message || ''}</div>
                    </div>
                    <div class="post-actions">
                        <button class="action-btn ${hasLiked ? 'active-like' : ''}" onclick="toggleLike('${p.id}', 'like')">
                            <i class="${hasLiked ? 'fas' : 'far'} fa-heart"></i> ${p.likedBy?.length || 0}
                        </button>
                        <button class="action-btn ${hasDisliked ? 'active-dislike' : ''}" onclick="toggleLike('${p.id}', 'dislike')">
                            <i class="${hasDisliked ? 'fas' : 'far'} fa-thumbs-down"></i> ${p.dislikedBy?.length || 0}
                        </button>
                        <div class="view-count-pill">
                            <i class="far fa-eye"></i> ${viewsCount}
                        </div>
                    </div>
                `;
                postsFeed.appendChild(card);
            });
        }

        async function trackView(postId, viewedBy = []) {
            if(!viewedBy.includes(currentUserId)) {
                await updateDoc(doc(postsCollectionRef, postId), {
                    viewedBy: arrayUnion(currentUserId)
                });
            }
        }

        async function toggleLike(postId, type) {
            const pRef = doc(postsCollectionRef, postId);
            const pDoc = await getDoc(pRef);
            if(!pDoc.exists()) return;
            const data = pDoc.data();

            if(type === 'like') {
                if(data.likedBy?.includes(currentUserId)) {
                    await updateDoc(pRef, { likedBy: arrayRemove(currentUserId) });
                } else {
                    await updateDoc(pRef, { likedBy: arrayUnion(currentUserId), dislikedBy: arrayRemove(currentUserId) });
                }
            } else {
                if(data.dislikedBy?.includes(currentUserId)) {
                    await updateDoc(pRef, { dislikedBy: arrayRemove(currentUserId) });
                } else {
                    await updateDoc(pRef, { dislikedBy: arrayUnion(currentUserId), likedBy: arrayRemove(currentUserId) });
                }
            }
        }

        // --- PROFILS & GRILLES ---
        window.openProfile = (uid) => {
            if(!uid) return;
            if(uid === currentUserId) {
                switchView('profile');
            } else {
                switchView('friends');
                renderUserDetail(uid);
            }
        };

        async function renderMyProfile() {
            const pView = views.profile;
            pView.innerHTML = `
                <div class="profile-header">
                    <i class="fas fa-edit" style="position:absolute; right:20px; top:20px; font-size:1.3rem; color: #555;" onclick="showSettings()"></i>
                    <img class="profile-main-avatar" src="${userData.avatar}">
                    <h2 class="profile-name">${userData.username}</h2>
                    <p class="profile-bio">${userData.bio}</p>
                    <div class="profile-stats">
                        <div class="stat-item"><span class="stat-val">${userData.postsCount || 0}</span><span class="stat-label">Drops</span></div>
                        <div class="stat-item" onclick="switchView('friends')"><span class="stat-val">${userData.friends?.length || 0}</span><span class="stat-label">Amis</span></div>
                    </div>
                </div>
                <div id="my-posts-grid" class="profile-grid"></div>
            `;
            loadPostsGrid(currentUserId, 'my-posts-grid');
        }

        async function renderUserDetail(uid) {
            const u = await fetchUserData(uid);
            if(!u) return;
            const isFriend = userData.friends?.includes(uid);
            const container = document.getElementById('friends-view-content');
            
            container.innerHTML = `
                <div class="view-header">
                    <i class="fas fa-arrow-left close-btn" onclick="renderFriendsView()"></i>
                    <div class="view-title">${u.username}</div>
                </div>
                <div class="profile-header">
                    <img class="profile-main-avatar" src="${u.avatar}">
                    <h2 class="profile-name">${u.username}</h2>
                    <p class="profile-bio">${u.bio}</p>
                    <div class="profile-stats">
                        <div class="stat-item"><span class="stat-val">${u.postsCount || 0}</span><span class="stat-label">Drops</span></div>
                    </div>
                    <div style="display:flex; gap:12px; width:100%; padding:0 20px;">
                        <button class="primary-btn" onclick="toggleFriend('${uid}')">${isFriend ? 'Ami ✓' : 'Ajouter'}</button>
                        <button class="secondary-btn" style="background:#fff; color:var(--danger-color); border:1px solid #ff3b30;" onclick="blockUser('${uid}')">Bloquer</button>
                    </div>
                </div>
                <div id="user-posts-grid" class="profile-grid"></div>
            `;
            loadPostsGrid(uid, 'user-posts-grid');
        }

        function loadPostsGrid(uid, containerId) {
            const grid = document.getElementById(containerId);
            onSnapshot(postsCollectionRef, (snap) => {
                const posts = snap.docs.map(d => ({id: d.id, ...d.data()}))
                                  .filter(p => p.publisherId === uid && !p.isAnon)
                                  .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                grid.innerHTML = "";
                posts.forEach(p => {
                    const item = document.createElement('div');
                    item.className = "grid-item";
                    
                    if(p.imageBase64) {
                        item.innerHTML = `<img src="${p.imageBase64}">`;
                    } else {
                        item.innerHTML = `<div class="grid-item-text" style="background:${p.backgroundColor}; font-family:${p.fontClass}">${p.message.substring(0,35)}...</div>`;
                    }
                    item.innerHTML += `<div class="grid-view-badge"><i class="fas fa-eye"></i> ${p.viewedBy?.length || 0}</div>`;
                    
                    item.onclick = () => {
                        if(uid === currentUserId) {
                            showMyPostGridMenu(p);
                        } else {
                            // Rediriger vers flux et scroller
                            switchView('flux');
                            setTimeout(() => {
                                const card = document.querySelector(`.post-card[data-id="${p.id}"]`);
                                if(card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 100);
                        }
                    };
                    grid.appendChild(item);
                });
            });
        }

        // --- MENU PUBLICATION PERSONNELLE ---
        function showMyPostGridMenu(post) {
            sheetContent.innerHTML = `
                <div class="sheet-option" onclick="closeActionSheet(); switchView('flux'); setTimeout(() => document.querySelector('.post-card[data-id=\\'${post.id}\\']').scrollIntoView({block:'center'}), 150)"><i class="fas fa-eye"></i> Voir la publication</div>
                <div class="sheet-option" onclick="openPostInfoPage('${post.id}')"><i class="fas fa-info-circle"></i> Infos de la publication</div>
                <div class="sheet-option danger" onclick="deletePost('${post.id}')"><i class="fas fa-trash-alt"></i> Supprimer définitivement</div>
            `;
            openActionSheet();
        }

        window.openPostInfoPage = async (postId) => {
            closeActionSheet();
            const snap = await getDoc(doc(postsCollectionRef, postId));
            if(!snap.exists()) return;
            const p = snap.data();
            
            showSecondaryView(postInfoView);
            const body = document.getElementById('post-info-body');
            
            // Calculer ceux qui n'ont pas vu
            const viewers = p.viewedBy || [];
            const friends = userData.friends || [];
            const missing = friends.filter(fId => !viewers.includes(fId));

            body.innerHTML = `
                <div class="stat-card">
                    <div class="stat-row"><span class="stat-label-info">Vues</span> <span class="stat-value-info">${viewers.length}</span></div>
                    <div class="stat-row"><span class="stat-label-info">Likes</span> <span class="stat-value-info">${p.likedBy?.length || 0}</span></div>
                    <div class="stat-row"><span class="stat-label-info">Dislikes</span> <span class="stat-value-info">${p.dislikedBy?.length || 0}</span></div>
                </div>
                
                <h3 style="font-size: 1rem; margin-top: 30px;">Ils n'ont pas vu ton Drop (${missing.length})</h3>
                <div class="suspect-list" id="missing-viewers-list"></div>
            `;

            const listContainer = document.getElementById('missing-viewers-list');
            if(missing.length === 0) {
                listContainer.innerHTML = "<p style='color:#aaa; text-align:center;'>Tous tes amis ont vu ce Drop !</p>";
            } else {
                for(let mId of missing) {
                    const mData = await fetchUserData(mId);
                    if(mData) {
                        const div = document.createElement('div');
                        div.className = "suspect-item";
                        div.innerHTML = `<img src="${mData.avatar}" class="suspect-avatar"> <span>${mData.username}</span>`;
                        listContainer.appendChild(div);
                    }
                }
            }
        };

        window.deletePost = async (postId) => {
            if(confirm("Supprimer ce Drop ? Cette action est irréversible.")) {
                await deleteDoc(doc(postsCollectionRef, postId));
                const uRef = doc(usersCollectionRef, currentUserId);
                const uDoc = await getDoc(uRef);
                updateDoc(uRef, { postsCount: Math.max(0, (uDoc.data().postsCount || 1) - 1) });
                closeActionSheet();
                showMessage("Drop supprimé");
            }
        };

        // --- AMIS & BLOCAGE ---
        async function renderFriendsView() {
            const container = document.getElementById('friends-view-content');
            container.innerHTML = `<div style="padding:15px; font-weight:800; font-size:1.2rem;">Mes Amis (${userData.friends?.length || 0})</div><div class="friends-list" id="friends-list-container"></div>`;
            const list = document.getElementById('friends-list-container');
            
            if(!userData.friends || userData.friends.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#aaa; margin-top:40px;"><i class="fas fa-ghost" style="font-size:3rem; display:block; margin-bottom:10px;"></i>C'est un peu vide ici...</div>`;
                return;
            }

            for(let fId of userData.friends) {
                const fData = await fetchUserData(fId);
                if(fData) {
                    const div = document.createElement('div');
                    div.className = "friend-item";
                    div.onclick = () => openProfile(fId);
                    div.innerHTML = `
                        <img src="${fData.avatar}" class="friend-avatar">
                        <div style="flex:1">
                            <div class="friend-name">${fData.username}</div>
                            <div class="friend-bio-snippet">${fData.bio}</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:#ddd"></i>
                    `;
                    list.appendChild(div);
                }
            }
        }

        window.toggleFriend = async (uid) => {
            const isFriend = userData.friends?.includes(uid);
            const uRef = doc(usersCollectionRef, currentUserId);
            if(isFriend) {
                await updateDoc(uRef, { friends: arrayRemove(uid) });
            } else {
                await updateDoc(uRef, { friends: arrayUnion(uid) });
            }
            renderUserDetail(uid);
        };

        window.blockUser = async (uid) => {
            if(confirm("Bloquer cet utilisateur ? Il ne verra plus vos posts et vous ne verrez plus les siens.")) {
                const uRef = doc(usersCollectionRef, currentUserId);
                await updateDoc(uRef, { 
                    blocked: arrayUnion(uid),
                    friends: arrayRemove(uid)
                });
                showMessage("Utilisateur bloqué");
                renderFriendsView();
            }
        };

        // --- GROUPES ---
        function renderGroups(groups) {
            const list = document.getElementById('groups-list');
            list.innerHTML = "";
            groups.forEach(g => {
                if(!g.members?.includes(currentUserId)) return;
                const div = document.createElement('div');
                div.className = "group-item";
                div.onclick = () => openGroupChat(g.id);
                div.innerHTML = `
                    <div class="group-avatar-circle"><i class="fas fa-users"></i></div>
                    <div class="group-info">
                        <div class="group-name-text">${g.name} <span style="font-size:0.7rem; color:var(--accent-color); background:#eef3ff; padding:2px 6px; border-radius:10px;">${g.members.length}</span></div>
                        <div class="group-last-msg">${g.bio || 'Aucune description'}</div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        window.showCreateGroup = async () => {
            const name = prompt("Nom du groupe :");
            if(!name) return;
            await addDoc(groupsCollectionRef, {
                name: name,
                bio: "Bienvenue dans ce nouveau groupe !",
                owner: currentUserId,
                members: [currentUserId],
                createdAt: serverTimestamp(),
                messages: []
            });
        };

        window.openGroupChat = async (gid) => {
            currentChatGroupId = gid;
            showSecondaryView(chatView);
            const header = document.getElementById('chat-header');
            
            onSnapshot(doc(groupsCollectionRef, gid), (snap) => {
                const g = snap.data();
                if(!g) return;
                header.innerHTML = `
                    <i class="fas fa-arrow-left close-btn" onclick="hideSecondaryView(chatView)"></i>
                    <div class="view-title" onclick="showGroupSettings('${gid}')">${g.name} <i class="fas fa-info-circle" style="font-size:0.8rem; margin-left:5px;"></i></div>
                `;
                renderChatMessages(g.messages || []);
            });
        };

        window.showGroupSettings = async (gid) => {
            const snap = await getDoc(doc(groupsCollectionRef, gid));
            const g = snap.data();
            const isOwner = g.owner === currentUserId;

            const modal = document.createElement('div');
            modal.className = "secondary-view active";
            modal.innerHTML = `
                <div class="view-header">
                    <i class="fas fa-times close-btn" onclick="this.parentElement.parentElement.remove()"></i>
                    <div class="view-title">Infos Groupe</div>
                </div>
                <div style="padding:20px;">
                    <label style="font-weight:700; font-size:0.8rem; color:#666;">NOM DU GROUPE</label>
                    <div class="group-edit-section">
                        <input type="text" id="edit-group-name" value="${g.name}" ${!isOwner ? 'disabled' : ''}>
                        ${isOwner ? `<button class="btn-ok" onclick="updateGroupField('${gid}', 'name')">OK</button>` : ''}
                    </div>
                    
                    <label style="font-weight:700; font-size:0.8rem; color:#666;">DESCRIPTION</label>
                    <div class="group-edit-section">
                        <textarea id="edit-group-bio" ${!isOwner ? 'disabled' : ''}>${g.bio || ''}</textarea>
                        ${isOwner ? `<button class="btn-ok" onclick="updateGroupField('${gid}', 'bio')">OK</button>` : ''}
                    </div>
                    
                    <button class="secondary-btn" style="color:var(--danger-color);" onclick="leaveGroup('${gid}')">Quitter le groupe</button>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.updateGroupField = async (gid, field) => {
            const val = field === 'name' ? document.getElementById('edit-group-name').value : document.getElementById('edit-group-bio').value;
            await updateDoc(doc(groupsCollectionRef, gid), { [field]: val });
            showMessage("Mise à jour réussie");
        };

        window.leaveGroup = async (gid) => {
            if(confirm("Quitter ce groupe ?")) {
                await updateDoc(doc(groupsCollectionRef, gid), { members: arrayRemove(currentUserId) });
                hideSecondaryView(chatView);
                document.querySelector('.secondary-view.active')?.remove();
            }
        };

        function renderChatMessages(msgs) {
            const container = document.getElementById('chat-messages');
            container.innerHTML = "";
            msgs.forEach(m => {
                const isMe = m.senderId === currentUserId;
                const div = document.createElement('div');
                div.style.cssText = `max-width:80%; padding:10px 14px; border-radius:18px; font-size:0.95rem; align-self: ${isMe ? 'flex-end' : 'flex-start'}; background: ${isMe ? 'var(--accent-color)' : '#fff'}; color: ${isMe ? '#fff' : '#333'}; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: ${isMe ? 'none' : '1px solid #eee'}`;
                div.innerHTML = `
                    <div style="font-size:0.65rem; opacity:0.7; margin-bottom:4px; font-weight:700;">${m.senderName}</div>
                    <div>${m.text}</div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        window.sendChatMessage = async () => {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt || !currentChatGroupId) return;
            const msg = { senderId: currentUserId, senderName: userData.username, text: txt, sentAt: Date.now() };
            await updateDoc(doc(groupsCollectionRef, currentChatGroupId), { messages: arrayUnion(msg) });
            inp.value = "";
        };

        // --- CRÉATION DE POST ---
        window.showPostCreation = () => {
            resetPostContent();
            renderCreationTools();
            showSecondaryView(postCreationView);
        };

        function renderCreationTools() {
            // Fonts
            const fList = document.getElementById('font-list');
            fList.innerHTML = "";
            POST_FONT_FAMILIES.forEach((f, i) => {
                const opt = document.createElement('div');
                opt.className = `font-opt ${i === currentPostFontIndex ? 'selected' : ''}`;
                opt.textContent = f;
                opt.style.fontFamily = f;
                opt.onclick = () => {
                    currentPostFontIndex = i;
                    postTextarea.style.fontFamily = f;
                    renderCreationTools();
                };
                fList.appendChild(opt);
            });

            // Colors
            const cPalette = document.getElementById('color-palette');
            cPalette.innerHTML = "";
            POST_COLORS.forEach(c => {
                const dot = document.createElement('div');
                dot.className = `color-dot ${c === currentPostColor ? 'selected' : ''}`;
                dot.style.background = c;
                dot.onclick = () => {
                    currentPostColor = c;
                    if(!currentImageBase64) squareContent.style.backgroundColor = c;
                    postTextarea.style.color = isDark(c) ? '#fff' : '#333';
                    renderCreationTools();
                };
                cPalette.appendChild(dot);
            });
        }

        window.previewImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImageBase64 = e.target.result;
                    postImgPreview.src = currentImageBase64;
                    postImgPreview.style.display = 'block';
                    squareContent.style.backgroundColor = 'transparent';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.resetPostContent = () => {
            postTextarea.value = "";
            currentImageBase64 = null;
            postImgPreview.style.display = 'none';
            currentPostColor = '#FF5E5E';
            squareContent.style.backgroundColor = currentPostColor;
            postTextarea.style.color = '#fff';
            currentPostFontIndex = 0;
            postTextarea.style.fontFamily = 'Inter';
        };

        window.handlePublish = async () => {
            const txt = postTextarea.value.trim();
            if(!txt && !currentImageBase64) return;
            
            publishButton.disabled = true;
            try {
                await addDoc(postsCollectionRef, {
                    message: txt,
                    publisherId: anonymousSwitch.checked ? null : currentUserId,
                    isAnon: anonymousSwitch.checked,
                    createdAt: serverTimestamp(),
                    backgroundColor: currentImageBase64 ? 'transparent' : currentPostColor,
                    fontClass: POST_FONT_FAMILIES[currentPostFontIndex],
                    likedBy: [],
                    dislikedBy: [],
                    viewedBy: [currentUserId],
                    imageBase64: currentImageBase64
                });
                const uRef = doc(usersCollectionRef, currentUserId);
                const uDoc = await getDoc(uRef);
                updateDoc(uRef, { postsCount: (uDoc.data().postsCount || 0) + 1 });
                hideSecondaryView(postCreationView);
                showMessage("Drop publié !");
            } catch(e) { showMessage("Erreur de publication", false); }
            publishButton.disabled = false;
        };

        // --- PARAMÈTRES ---
        window.showSettings = () => {
            document.getElementById('settings-avatar-preview').src = userData.avatar;
            document.getElementById('set-username').value = userData.username;
            document.getElementById('set-bio').value = userData.bio;
            showSecondaryView(settingsView);
        };

        window.promptAvatar = () => {
            const url = prompt("URL de l'image (ou base64) :");
            if(url) {
                document.getElementById('settings-avatar-preview').src = url;
            }
        };

        window.saveSettings = async () => {
            const av = document.getElementById('settings-avatar-preview').src;
            const un = document.getElementById('set-username').value.trim();
            const bi = document.getElementById('set-bio').value.trim();
            if(!un) return;
            await updateDoc(doc(usersCollectionRef, currentUserId), { avatar: av, username: un, bio: bi });
            hideSecondaryView(settingsView);
            showMessage("Profil mis à jour");
        };

        // --- RECHERCHE ---
        window.showSearchView = () => { showSecondaryView(searchView); };
        window.handleSearch = async (val) => {
            const resDiv = document.getElementById('search-results');
            if(!val || val.length < 2) { resDiv.innerHTML = ""; return; }
            onSnapshot(usersCollectionRef, (snap) => {
                const users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const filtered = users.filter(u => u.username.toLowerCase().includes(val.toLowerCase()) && u.id !== currentUserId);
                resDiv.innerHTML = "";
                filtered.forEach(u => {
                    const div = document.createElement('div');
                    div.className = "friend-item";
                    div.onclick = () => { hideSecondaryView(searchView); openProfile(u.id); };
                    div.innerHTML = `<img src="${u.avatar}" class="friend-avatar"><div><div class="friend-name">${u.username}</div><div class="friend-bio-snippet">${u.bio}</div></div>`;
                    resDiv.appendChild(div);
                });
            });
        };

        // --- HELPERS ---
        async function fetchUserData(uid) {
            const snap = await getDoc(doc(usersCollectionRef, uid));
            return snap.exists() ? snap.data() : null;
        }

        window.showPostOptions = (pid, ownerId) => {
            sheetContent.innerHTML = `
                <div class="sheet-option" onclick="copyToClipboard('${pid}'); closeActionSheet()"><i class="fas fa-link"></i> Copier l'ID du Drop</div>
                <div class="sheet-option" onclick="showMessage('Signalement reçu'); closeActionSheet()"><i class="fas fa-flag"></i> Signaler</div>
                ${ownerId && ownerId !== currentUserId ? `<div class="sheet-option danger" onclick="blockUser('${ownerId}'); closeActionSheet()"><i class="fas fa-ban"></i> Bloquer l'utilisateur</div>` : ''}
            `;
            openActionSheet();
        };

        function openActionSheet() {
            sheetOverlay.style.display = 'block';
            setTimeout(() => actionSheet.classList.add('active'), 10);
        }
        window.closeActionSheet = () => {
            actionSheet.classList.remove('active');
            setTimeout(() => sheetOverlay.style.display = 'none', 300);
        };

        function isDark(color) {
            if(!color || color === 'transparent') return false;
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness < 155;
        }

        window.copyToClipboard = (text) => {
            const dummy = document.createElement("input");
            document.body.appendChild(dummy);
            dummy.value = text;
            dummy.select();
            document.execCommand("copy");
            document.body.removeChild(dummy);
            showMessage("ID copié !");
        };

        initAuth();
    </script>
</body>
</html>
