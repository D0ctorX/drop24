<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="google-site-verification" content="lULIZecjpMCUjs1v3f7cUVpNzZf0cceze-bv5Zkq9Qs" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <!-- HTML2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- LEAFLET MAP CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- LEAFLET MAP JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@700&family=Pacifico&display=swap');

        :root {
            --primary-bg: #FAFAFA;
            --secondary-bg: #FFFFFF;
            --border-color: #DBDBDB;
            --text-color: #262626;
            --highlight-color: #3897f0;
            --last-seen-color: #8E8E8E;
            --button-border: #d4d4d4;
            --like-color: #3897f0;
            --dislike-color: #E74C3C;
            --action-color: #8e8e8e;
            --switch-off: #ccc;
            --switch-on: #5cb85c;
            --page-bg: #f0f2f5; 
            --google-btn: #4285F4;
            --chat-bubble-sent: #3897f0;
            --chat-bubble-received: #EFEFEF;
            --hashtag-color: #64b5f6;
            --online-color: #2ecc71;
            --offline-color: #e74c3c;
        }

        .font-inter { font-family: 'Inter', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .font-mono { font-family: 'Courier New', Courier, monospace; }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--page-bg); 
            color: var(--text-color);
            overflow: hidden;
            overscroll-behavior-y: none;
        }

        /* --- VUE AUTHENTIFICATION --- */
        #auth-view {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--primary-bg); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .auth-card {
            background: var(--secondary-bg); padding: 30px 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center;
        }
        .app-logo { font-family: 'Pacifico', cursive; font-size: 48px; color: var(--text-color); margin-bottom: 30px; }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color);
            border-radius: 6px; background-color: var(--primary-bg); font-size: 14px;
        }
        .auth-btn {
            width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; font-size: 14px;
            cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: opacity 0.2s;
        }
        .auth-btn:hover { opacity: 0.9; }
        .btn-primary { background-color: var(--highlight-color); color: white; }
        .btn-google { background-color: var(--google-btn); color: white; }
        
        .or-divider { display: flex; align-items: center; color: var(--last-seen-color); font-size: 12px; font-weight: 600; margin: 15px 0; }
        .or-divider::before, .or-divider::after { content: ""; flex: 1; border-bottom: 1px solid var(--border-color); }
        .or-divider::before { margin-right: 10px; } .or-divider::after { margin-left: 10px; }
        .auth-switch-text { margin-top: 20px; font-size: 14px; }
        .auth-switch-link { color: var(--highlight-color); font-weight: 600; cursor: pointer; }

        /* --- APPLICATION PRINCIPALE --- */
        #app-container {
            display: none; width: 100%; height: 100%; max-width: 480px; margin: 0 auto;
            background-color: var(--primary-bg); flex-direction: column; position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;
        }
        #view-wrapper { 
            display: flex; flex: 1; width: 100%; height: 100%; 
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            will-change: transform; 
        }
        .view {
            display: flex; flex-direction: column; background-color: var(--primary-bg);
            width: 100%; height: 100%; flex-shrink: 0; overflow: hidden;
        }
        
        .view.secondary {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 20; visibility: hidden; background-color: var(--secondary-bg); will-change: transform;
        }
        .view.chat-view, .view.group-info-view, .view.post-creation-view, .view.post-info-view, .view.map-view { z-index: 40; }
        .view.secondary.visible { transform: translateX(0); visibility: visible; }

        .view-header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color);
            min-height: 60px; flex-shrink: 0; z-index: 10; gap: 10px; 
        }
        .feed-view .view-header { flex-wrap: wrap; }
        #feed-search-bar {
            width: 100%; display: flex; align-items: center; background-color: var(--page-bg);
            border: 1px solid var(--border-color); border-radius: 8px; padding: 0 10px; order: 3; 
        }
        #feed-search-icon { color: var(--last-seen-color); font-size: 14px; }
        #feed-search-input { width: 100%; padding: 8px 5px; border: none; background: transparent; outline: none; font-size: 14px; }

        .header-title { font-size: 20px; font-weight: 600; margin: 0; text-align: center; flex-grow: 1; }
        .header-icon { font-size: 22px; cursor: pointer; color: var(--text-color); width: 40px; text-align: right; }
        .header-placeholder { width: 40px; } 
        .back-button { font-size: 20px; cursor: pointer; width: 40px; text-align: left; }

        .feed-content, .contacts-content, .chat-content, .profile-content, #friend-requests-list, .group-info-content, .post-info-content {
            flex: 1 1 0; overflow-y: auto; padding-bottom: 140px;
            -webkit-overflow-scrolling: touch; -ms-overflow-style: none; scrollbar-width: none;  
        }
        #user-profile-view .profile-content { padding-bottom: 80px; }
        ::-webkit-scrollbar { display: none; }
        #friend-requests-list { max-height: 300px; flex: initial; }

        .nav-bar {
            position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around;
            background-color: var(--secondary-bg); border-top: 1px solid var(--border-color);
            z-index: 30; padding-bottom: env(safe-area-inset-bottom); height: 60px;
        }
        .nav-item { position: relative; padding: 10px 15px; font-size: 24px; color: var(--action-color); cursor: pointer; text-align: center; transition: color 0.2s, transform 0.2s; }
        .nav-item.active { color: var(--highlight-color); transform: scale(1.1); }
        .nav-item span { display: block; font-size: 10px; margin-top: 2px; }
        .notification-badge {
            position: absolute; top: 2px; right: 8px; background-color: var(--dislike-color); color: white;
            border-radius: 50%; padding: 2px 5px; font-size: 10px; font-weight: bold;
            min-width: 16px; text-align: center; border: 1px solid white; z-index: 100;
        }

        .post-card { background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color); margin-bottom: 8px; contain: content; }
        .post-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; font-size: 14px; }
        .post-publisher { font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .post-countdown { font-size: 12px; color: var(--dislike-color); font-family: 'Roboto Mono', monospace; font-weight: 700; background-color: #fcebeb; padding: 2px 6px; border-radius: 4px; }
        .post-image-wrapper { width: 100%; padding-top: 100%; position: relative; background-size: cover; background-position: center; background-repeat: no-repeat; }
        .post-content-inner { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .post-message { font-size: 22px; text-align: center; white-space: pre-wrap; word-wrap: break-word; }
        .post-message.snap-text { display: inline; background-color: rgba(0, 0, 0, 0.5); color: white; padding: 2px 6px; line-height: 1.6; -webkit-box-decoration-break: clone; border-radius: 4px; text-shadow: none; }
        .post-hashtag { color: var(--hashtag-color); font-weight: 600; cursor: pointer; z-index: 10; position: relative; }
        .post-message.snap-text .post-hashtag { color: #81d4fa; text-decoration: underline; }
        .post-actions { display: flex; padding: 8px 15px; gap: 20px; align-items: center; }
        .action-button { display: flex; align-items: center; gap: 8px; font-size: 18px; color: var(--action-color); cursor: pointer; }
        .action-button span { font-size: 14px; font-weight: 600; }
        .action-button.liked i, .action-button.liked span { color: var(--like-color); }
        .action-button.disliked i, .action-button.disliked span { color: var(--dislike-color); }
        .action-button.share-btn { margin-left: auto; } 
        .action-button.view-count { cursor: default; margin-left: 10px; }

        /* SONDAGES 1:1 */
        .poll-square-container {
            width: 100%; padding-top: 100%; position: relative;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .poll-square-inner {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column; justify-content: center;
            padding: 20px;
        }
        .poll-question {
            font-size: 22px; text-align: center; margin-bottom: 25px;
            font-weight: 700; word-wrap: break-word;
            font-family: 'Inter', sans-serif;
        }
        .poll-option-btn {
            display: block; width: 100%; padding: 14px; margin-bottom: 10px;
            background: #f0f2f5; border: 1px solid var(--border-color); border-radius: 12px;
            text-align: center; font-weight: 600; cursor: pointer; transition: background 0.2s;
            font-size: 16px;
        }
        .poll-option-btn:hover { background: #e4e6eb; }
        .poll-result-row { margin-bottom: 15px; }
        .poll-result-header { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; color: #555; }
        .poll-bar-bg { background: #f0f2f5; border-radius: 8px; height: 40px; position: relative; overflow: hidden; }
        .poll-bar-fill { height: 100%; background: var(--highlight-color); width: 0; transition: width 0.5s ease; opacity: 0.2; }
        .poll-bar-text { position: absolute; top: 0; left: 15px; height: 100%; display: flex; align-items: center; font-weight: 700; font-size: 14px; }
        .poll-check { float: right; color: var(--highlight-color); margin-left: 10px; }

        /* CONTACTS & MAP */
        .contacts-view { position: relative !important; } 
        .search-bar-container { display: flex; gap: 10px; padding: 10px; background-color: var(--primary-bg); flex-shrink: 0; align-items: center; }
        #search-input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--secondary-bg); font-size: 14px; }
        #create-group-btn { width: 40px; height: 40px; background-color: black; color: white; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
        
        .friend-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; contain: content; }
        .friend-item:hover { background-color: #f9f9f9; }
        
        /* AVATAR AVEC STATUT */
        .pp-container { position: relative; width: 50px; height: 50px; margin-right: 15px; }
        .friend-pp { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .status-dot {
            width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;
            position: absolute; bottom: 0; right: 0;
        }
        .status-online { background-color: var(--online-color); }
        .status-offline { background-color: var(--offline-color); }

        .friend-info { flex-grow: 1; min-width: 0; }
        .friend-info h4 { margin: 0 0 4px 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display:flex; align-items:center; gap:5px;}
        .friend-info p { margin: 0; font-size: 12px; color: var(--last-seen-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dm-button-container { position: relative; }
        .dm-button { background-color: var(--highlight-color); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .dm-unread-badge { position: absolute; top: -5px; right: -5px; background-color: var(--dislike-color); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; border: 2px solid white; }
        
        /* FAB Buttons */
        .fab-btn {
            position: absolute; right: 20px; width: 56px; height: 56px;
            border-radius: 50%; border: none; font-size: 24px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 100;
        }
        #add-friend-fab { bottom: calc(80px + env(safe-area-inset-bottom)); background-color: var(--highlight-color); color: white; }
        #open-map-btn { bottom: calc(150px + env(safe-area-inset-bottom)); background-color: black; color: white; }
        
        .request-badge { position: absolute; top: -5px; right: -5px; background-color: var(--dislike-color); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; border: 2px solid var(--secondary-bg); z-index: 101; }
        .request-count-badge { background-color: var(--dislike-color); color: white; font-size: 12px; font-weight: 700; padding: 2px 8px; border-radius: 12px; margin-left: 8px; }
        
        /* MAP VIEW */
        #map-container { width: 100%; height: 100%; background: #f0f0f0; }
        /* Map Marker Styles */
        .map-avatar-icon { border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .map-avatar-icon.offline { filter: grayscale(100%) opacity(0.8); border-color: #ccc; }
        .map-avatar-icon.online { border-color: var(--online-color); }
        
        .chat-view .view-header { gap: 10px; }
        #chat-user-pp { width: 40px; height: 40px; border-radius: 50%; object-fit: cover;}
        .chat-view .header-title { flex-grow: 1; text-align: left; }
        .chat-content { background-color: #FFFFFF; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .message-container { display: flex; flex-direction: column; width: 100%; margin-bottom: 5px; }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .chat-sticker { width: 150px; height: 150px; object-fit: contain; display: block; margin: 5px 0; }
        .message-time { font-size: 10px; margin-top: 4px; display: block; opacity: 0.6; text-align: right; font-weight: 600; }
        .message-container.sent { align-items: flex-end; }
        .message-bubble.sent { background-color: var(--chat-bubble-sent); color: white; border-bottom-right-radius: 4px; }
        .message-container.received { align-items: flex-start; }
        .message-bubble.received { background-color: var(--chat-bubble-received); color: black; border-bottom-left-radius: 4px; }
        .message-read-status { font-size: 10px; margin-left: 5px; opacity: 0.8; }
        .message-sender-pseudo { font-size: 12px; color: #666; margin-bottom: 4px; margin-left: 12px; font-weight: 700; }
        .chat-footer { display: flex; align-items: center; padding: 10px; background-color: var(--secondary-bg); border-top: 1px solid var(--border-color); gap: 10px; position: relative; }
        #emoji-btn { font-size: 24px; color: var(--text-color); cursor: pointer; background: none; border: none; padding: 5px; }
        #chat-input-wrapper { flex-grow: 1; background-color: var(--primary-bg); border-radius: 24px; padding: 0 15px; border: 1px solid var(--border-color); display: flex; align-items: center; }
        #message-input { flex-grow: 1; border: none; background: transparent; padding: 12px 0; font-size: 15px; outline: none; }
        #send-button { width: 40px; height: 40px; border-radius: 50%; background-color: var(--highlight-color); border: none; font-size: 16px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #send-button:disabled { opacity: 0.5; cursor: default; }
        #emoji-picker { position: absolute; bottom: 70px; left: 10px; background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); padding: 15px; display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 320px; max-width: 90vw; z-index: 50; max-height: 250px; overflow-y: auto; }
        #emoji-picker.show { display: grid; }
        .picker-sticker { width: 60px; height: 60px; cursor: pointer; object-fit: contain; transition: transform 0.2s; }
        .picker-sticker:hover { transform: scale(1.1); }

        .profile-header { display: flex; align-items: center; padding: 15px; gap: 15px; background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color); }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; position: relative; z-index: 1;}
        .profile-info-main { flex-grow: 1; }
        .profile-username { font-size: 22px; font-weight: 600; margin: 0; display:flex; align-items:center; gap:5px; }
        #edit-bio-btn { background: none; border: 1px solid var(--button-border); border-radius: 6px; padding: 6px 12px; margin-top: 10px; cursor: pointer; font-weight: 600; width: 100%; }
        #profile-actions { display: flex; gap: 10px; margin-top: 10px; }
        .profile-action-btn { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--button-border); border-radius: 6px; font-weight: 600; cursor: pointer; background: none; }
        .profile-action-btn.primary { background-color: var(--highlight-color); color: white; border-color: var(--highlight-color); }
        .profile-action-btn.danger { background-color: var(--dislike-color); color: white; border-color: var(--dislike-color); }
        .profile-stats { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .stat-item h3 { margin: 0; font-size: 18px; }
        .stat-item p { margin: 2px 0 0; font-size: 12px; color: var(--last-seen-color); }
        .profile-details { padding: 15px; }
        .profile-details h4 { margin: 0 0 5px 0; font-size: 16px; }
        .profile-details p { margin: 0 0 15px 0; line-height: 1.5; }
        #logout-btn { width: 100%; margin-top: 20px; padding: 12px; background-color: var(--primary-bg); color: var(--dislike-color); border: 1px solid var(--button-border); border-radius: 6px; font-weight: 600; cursor: pointer; display: none; } 
        
        .profile-posts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding-top: 2px; }
        .post-thumbnail { position: relative; width: 100%; padding-top: 100%; background-color: #eee; background-size: cover; background-position: center; cursor: pointer; contain: strict; }
        .post-thumbnail-views { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 4px; }

        #toast-message { position: absolute; bottom: 80px; left: 50%; transform: translate(-50%, 100%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 2000; opacity: 0; transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; pointer-events: none; }
        #toast-message.show { transform: translate(-50%, 0); opacity: 1; }
        #toast-message.success { background-color: #28a745; }
        #toast-message.error { background-color: #dc3545; }
        
        .modal-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 150; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: var(--secondary-bg); padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 15px; }
        .modal-content h3 { margin: 0 0 10px 0; text-align: center; }
        .modal-content label { font-size: 14px; font-weight: 600; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; }
        .modal-content textarea { resize: vertical; min-height: 60px; }
        #edit-color-swatches { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .edit-color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .edit-color-swatch.selected { border-color: var(--highlight-color); }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
        .modal-actions button { flex-grow: 1; padding: 10px; border-radius: 6px; border: none; font-weight: 600; font-size: 16px; cursor: pointer; }
        #save-profile-btn { background-color: var(--highlight-color); color: white; }
        #cancel-edit-btn, #cancel-friend-options-btn, #cancel-friend-requests-btn, #cancel-paste-id-btn, #cancel-add-group-member-btn, #cancel-member-options-btn, #cancel-trending-btn, #cancel-post-options-btn, #close-post-info-btn { background-color: #f0f0f0; color: var(--text-color); }

        #friend-options-modal .modal-content { gap: 10px; }
        .friend-option-button { display: flex; align-items: center; justify-content: space-between; gap: 15px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .friend-option-button:hover { background-color: #f9f9f9; }
        .friend-option-button i { width: 20px; text-align: center; color: var(--action-color); }
        .friend-option-button-text { display: flex; align-items: center; gap: 15px; }
        
        #qr-code-modal .modal-content { align-items: center; gap: 20px; }
        #qr-code-canvas { border: 5px solid var(--secondary-bg); border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        #friend-requests-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        .friend-request-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; }
        .friend-request-info { display: flex; align-items: center; gap: 10px; }
        .friend-request-info img { width: 40px; height: 40px; border-radius: 50%; }
        .friend-request-info span { font-weight: 600; }
        .friend-request-actions { display: flex; gap: 8px; }
        .friend-request-actions button { border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 16px; cursor: pointer; }
        .request-accept-btn { background-color: var(--switch-on); color: white; }
        .request-reject-btn { background-color: var(--dislike-color); color: white; }

        #create-group-modal .modal-content, #add-group-member-modal .modal-content { max-height: 80vh; }
        #group-friends-list, #add-member-friends-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; }
        .group-friend-select-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .group-friend-select-item input { width: auto; margin-right: 10px; }
        #cancel-group-modal-btn { background-color: #f0f0f0; color: var(--text-color); }

        .group-info-header-icon { width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #888; }
        .group-field-container { padding: 15px; border-bottom: 1px solid #f0f0f0; background: white; display: flex; flex-direction: column; }
        .group-input-wrapper { display: flex; align-items: center; gap: 10px; }
        .group-input-clean { flex-grow: 1; border: none; border-bottom: 1px solid var(--border-color); padding: 10px 0; font-size: 16px; outline: none; background: transparent; transition: border-color 0.3s; }
        .group-input-clean:focus { border-bottom-color: var(--highlight-color); }
        .group-input-clean:disabled { color: var(--text-color); border-bottom: none; background: transparent; }
        .group-save-btn { background: var(--highlight-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; display: none; }
        
        .section-label { font-size: 12px; font-weight: bold; color: var(--highlight-color); margin-bottom: 5px; text-transform: uppercase; }
        .group-members-list { margin-top: 0; background: white; }
        .group-member-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background: #fff; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .group-member-item:hover { background-color: #f9f9f9; }
        .group-member-info { display: flex; align-items: center; gap: 10px; }
        .group-member-info img { width: 40px; height: 40px; border-radius: 50%; }
        .admin-badge { background: #e0f2f1; color: #00695c; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .founder-badge { background: #fff8e1; color: #f57f17; border: 1px solid #ffecb3; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .group-danger-zone { padding: 30px 15px; text-align: center; }
        .btn-danger-outline { border: 1px solid var(--dislike-color); color: var(--dislike-color); background: transparent; padding: 12px 20px; border-radius: 8px; font-weight: 600; width: 100%; cursor: pointer; }
        .btn-add-member { width: 100%; padding: 12px; background: var(--secondary-bg); border: 1px dashed var(--highlight-color); color: var(--highlight-color); border-radius: 8px; margin-top: 10px; cursor: pointer; font-weight: 600; }

        #post-creation-view .view-header { justify-content: space-between; }
        #publish-button { font-size: 16px; font-weight: 600; color: var(--highlight-color); background: none; border: none; cursor: pointer; }
        #publish-button:disabled { color: var(--last-seen-color); cursor: not-allowed; }
        .post-input-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; overflow-y: hidden; background-color: var(--secondary-bg); }
        #square-content { width: 100%; padding-top: 100%; position: relative; background-color: #f1f1f1; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); transition: background-color 0.3s ease-in-out; cursor: text; background-size: cover; background-position: center; overflow: hidden; }
        
        #post-textarea, #input-highlighter { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; padding: 20px; border: none; text-align: center; font-size: 20px; line-height: 1.4; font-family: inherit; font-weight: inherit; overflow: auto; white-space: pre-wrap; word-wrap: break-word; margin: 0; }
        #input-highlighter { z-index: 1; pointer-events: none; color: var(--text-color); background: transparent; }
        #input-highlighter.has-image-overlay { color: white; text-shadow: 0 1px 4px rgba(0,0,0,0.8); }
        #input-highlighter.has-image-overlay .hashtag-highlight { color: #81d4fa; text-shadow: none; }
        .hashtag-highlight { color: var(--hashtag-color); }
        #post-textarea { z-index: 2; background: transparent; color: transparent; caret-color: var(--text-color); resize: none; outline: none; }
        #post-textarea::placeholder { color: #aaa; }
        #post-textarea.has-image { color: transparent; text-shadow: none; caret-color: white; } 
        #input-highlighter span.normal-text { color: var(--text-color); }
        #input-highlighter.has-image-overlay span.normal-text { color: white; }

        .char-limit-indicator { margin-top: 10px; font-size: 12px; color: var(--last-seen-color); text-align: right; width: 100%; }
        .char-limit-indicator.error { color: var(--dislike-color); font-weight: 600; }
        .post-controls { padding: 15px 20px; background-color: var(--secondary-bg); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 15px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; }
        .control-row label { font-size: 14px; font-weight: 600; }
        .color-swatches-container { display: flex; gap: 8px; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: border-color 0.2s; }
        .color-swatch.selected { border-color: var(--highlight-color); box-shadow: 0 0 0 2px white; }
        .control-button { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--button-border); background-color: var(--primary-bg); display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: background-color 0.2s; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-off); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--switch-on); }
        input:checked + .slider:before { transform: translateX(20px); }

        #share-capture-container { position: fixed; top: -9999px; left: -9999px; width: 400px; height: 400px; z-index: -1; }
        .capture-card { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; background-size: cover; background-position: center; }
        .capture-publisher { position: absolute; top: 20px; left: 0; width: 100%; text-align: center; font-weight: 700; font-size: 24px; color: rgba(0,0,0,0.5); z-index: 10; }
        .capture-watermark { position: absolute; bottom: 10px; right: 15px; font-size: 12px; font-weight: 600; color: rgba(0,0,0,0.3); font-family: 'Pacifico', cursive; }

        #cropper-modal .modal-content { max-width: 90vw; width: 400px; align-items: center; background: #222; color: white; }
        #cropper-canvas { max-width: 100%; border: 1px solid var(--border-color); background: #000; touch-action: none; }

        #trending-sidebar { position: absolute; top: 0; left: 0; bottom: 0; width: 280px; max-width: 80%; background-color: var(--secondary-bg); z-index: 1100; transform: translateX(-100%); transition: transform 0.3s ease-in-out; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #trending-sidebar.open { transform: translateX(0); }
        .trending-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .trending-header h2 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .trending-list { padding: 20px; flex-grow: 1; overflow-y: auto; }
        .trending-item { padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .trending-item:last-child { border-bottom: none; }
        .trending-rank { font-weight: bold; margin-right: 10px; color: var(--highlight-color); }
        .trending-tag { font-weight: 600; font-size: 16px; }
        .trending-count { display: block; font-size: 12px; color: var(--last-seen-color); margin-top: 4px; margin-left: 20px; }
        .sidebar-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 1050; display: none; }
        .sidebar-overlay.show { display: block; }
        
        .info-stat-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; background: white; }
        .info-stat-box { text-align: center; flex: 1; }
        .info-stat-val { font-size: 20px; font-weight: bold; display: block; }
        .info-stat-label { font-size: 12px; color: var(--last-seen-color); }
        .not-seen-list { background: white; margin-top: 10px; }

        .user-badge { margin-left: 4px; font-size: 12px; vertical-align: middle; }
        .badge-staff { color: #3897f0; } 
        .badge-vip { color: #F1C40F; } 
        .badge-certif { color: #2ECC71; } 
        .badge-patron { color: #8e44ad; } 

    </style>
</head>
<body>

    <!-- VUE D'AUTHENTIFICATION -->
    <div id="auth-view">
        <div class="auth-card">
            <h1 class="app-logo">Drop</h1>
            <div id="email-auth-form">
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-password" class="auth-input" placeholder="Mot de passe" required>
                <button id="login-btn" class="auth-btn btn-primary"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
                <div class="auth-switch-text"><span id="auth-toggle-text">Pas de compte ?</span><span id="auth-toggle-link" class="auth-switch-link">S'inscrire</span></div>
            </div>
            <div class="or-divider">OU</div>
            <button id="google-btn" class="auth-btn btn-google"><i class="fab fa-google"></i> Continuer avec Google</button>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE -->
    <div id="app-container" class="container">
        
        <div id="sidebar-overlay" class="sidebar-overlay"></div>
        <div id="trending-sidebar">
            <div class="trending-header">
                <h2><i class="fas fa-fire" style="color:var(--dislike-color)"></i> Tendances</h2>
                <i id="close-trending-btn" class="fas fa-times" style="cursor:pointer; font-size:20px;"></i>
            </div>
            <div id="trending-list" class="trending-list">
                <!-- Rempli par JS -->
            </div>
        </div>

        <div id="view-wrapper">
            <!-- VUE FEED -->
            <div id="feed-view" class="view feed-view">
                <div class="view-header">
                    <i id="trending-btn" class="fas fa-chart-line header-icon" style="text-align:left; width:40px;"></i>
                    <h1 class="header-title">Flux</h1>
                    <i id="create-post-header-btn" class="fas fa-feather-alt header-icon"></i>
                    <div id="feed-search-bar"><i id="feed-search-icon" class="fas fa-search"></i><input type="text" id="feed-search-input" placeholder="Rechercher..."></div>
                </div>
                <div id="feed-content" class="feed-content"></div>
            </div>
            
            <!-- VUE AMIS / GROUPES -->
            <div id="contacts-view" class="view contacts-view">
                <div class="view-header"><div class="header-placeholder"></div><h1 class="header-title">Conversations</h1><div class="header-placeholder"></div></div>
                <div class="search-bar-container">
                    <input type="text" id="search-input" placeholder="Rechercher...">
                    <button id="create-group-btn"><i class="fas fa-users-cog"></i></button>
                </div>
                <div id="friends-list" class="contacts-content"></div>
                <!-- BOUTON MAP (NOIR) -->
                <button id="open-map-btn" class="fab-btn"><i class="fas fa-map-marked-alt"></i></button>
                <!-- BOUTON AJOUT AMIS (BLEU) -->
                <button id="add-friend-fab" class="fab-btn"><i class="fas fa-user-plus"></i></button>
            </div>

            <!-- VUE PROFIL (MON PROFIL) -->
            <div id="profile-view" class="view profile-view">
                <div class="view-header"><i id="my-profile-nav-item" class="fas fa-users header-icon"></i><h1 id="profile-username-header" class="header-title">Profil</h1><div class="header-placeholder"></div></div>
                <div class="profile-content">
                    <div class="profile-header">
                        <div class="pp-container">
                             <img id="profile-pic" class="friend-pp" src="" alt="Avatar">
                             <div class="status-dot status-online"></div>
                        </div>
                        <div class="profile-info-main">
                            <h2 id="profile-username" class="profile-username">Nom d'utilisateur</h2>
                            <div id="profile-actions-container">
                                <button id="edit-bio-btn">Modifier le profil</button>
                            </div>
                        </div>
                    </div>
                    <div class="profile-stats"><div class="stat-item"><h3 id="posts-count">0</h3><p>Posts</p></div><div class="stat-item"><h3 id="followers-count">0</h3><p>Amis</p></div></div>
                    <div class="profile-details"><h4>Bio</h4><p id="profile-bio">Ceci est ma bio.</p><h4>Membre depuis</h4><p id="creation-date">...</p><button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Se déconnecter</button></div>
                    <div class="profile-details"><h4>Publications en ligne</h4></div>
                    <div id="my-posts-grid" class="profile-posts-grid"></div>
                </div>
            </div>
        </div>

        <!-- VUES SECONDAIRES -->
        
        <div id="map-view" class="view map-view secondary">
             <div class="view-header">
                <i id="map-back-btn" class="fas fa-arrow-left back-button"></i>
                <h1 class="header-title">Drop Map</h1>
                <div class="header-placeholder"></div>
            </div>
            <div id="map-container"></div>
        </div>

        <div id="user-profile-view" class="view secondary">
            <div class="view-header">
                <i id="user-profile-back-btn" class="fas fa-arrow-left back-button"></i>
                <h1 class="header-title">Profil</h1>
                <div class="header-placeholder"></div>
            </div>
            <div class="profile-content">
                <div class="profile-header">
                    <div class="pp-container">
                        <img id="other-profile-pic" class="friend-pp" src="" alt="Avatar">
                        <div id="other-profile-status" class="status-dot status-offline"></div>
                    </div>
                    <div class="profile-info-main">
                        <h2 id="other-profile-username" class="profile-username">Nom</h2>
                        <div id="other-profile-actions" style="display: flex; gap: 10px; margin-top: 10px;">
                            <button id="action-add-friend" class="profile-action-btn">Ajouter</button>
                            <button id="action-block-user" class="profile-action-btn danger">Bloquer</button>
                            <button id="action-message-user" class="profile-action-btn primary">Message</button>
                        </div>
                    </div>
                </div>
                <div class="profile-stats"><div class="stat-item"><h3 id="other-posts-count">0</h3><p>Posts</p></div><div class="stat-item"><h3 id="other-followers-count">0</h3><p>Amis</p></div></div>
                <div class="profile-details"><h4>Bio</h4><p id="other-profile-bio">Bio...</p></div>
                 <div class="profile-details"><h4>Publications en ligne</h4></div>
                 <div id="other-posts-grid" class="profile-posts-grid"></div>
            </div>
        </div>

        <div id="chat-view" class="view chat-view secondary">
            <div class="view-header chat-header">
                <i id="chat-back-btn" class="fas fa-arrow-left back-button"></i>
                <img id="chat-user-pp" src="">
                <h1 id="chat-username" class="header-title">Chat</h1>
                <i id="group-info-btn" class="fas fa-info-circle header-icon" style="display:none;"></i>
                <div id="chat-placeholder-right" class="header-placeholder"></div>
            </div>
            <div id="chat-content-container" class="chat-content"><div id="chat-body"></div></div>
            <div class="chat-footer">
                <button id="emoji-btn"><i class="far fa-smile"></i></button><div id="emoji-picker"></div>
                <div id="chat-input-wrapper"><input type="text" id="message-input" placeholder="Votre message..."></div><button id="send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        
        <div id="group-info-view" class="view group-info-view secondary">
            <div class="view-header">
                <i id="group-info-back-btn" class="fas fa-arrow-left back-button"></i>
                <h1 class="header-title">Infos du groupe</h1>
                <div id="group-save-placeholder" class="header-placeholder"></div>
            </div>
            <div class="group-info-content" style="background:var(--page-bg);">
                <div style="background:#fff; padding-bottom:20px; margin-bottom:10px; border-bottom:1px solid #DBDBDB;">
                    <div class="group-info-header-icon"><i class="fas fa-users"></i></div>
                    <div class="group-field-container">
                        <div class="section-label">Nom du groupe</div>
                        <div class="group-input-wrapper">
                            <input type="text" id="group-info-name" class="group-input-clean" disabled>
                            <button id="save-group-name-btn" class="group-save-btn">OK</button>
                        </div>
                    </div>
                    <div class="group-field-container" style="border:none;">
                        <div class="section-label">Description</div>
                        <div class="group-input-wrapper">
                            <input type="text" id="group-info-desc" class="group-input-clean" disabled>
                            <button id="save-group-desc-btn" class="group-save-btn">OK</button>
                        </div>
                    </div>
                </div>
                <div style="background:#fff; border-top:1px solid #DBDBDB; border-bottom:1px solid #DBDBDB; margin-bottom:20px; padding-bottom: 10px;">
                    <div class="section-label" style="padding:15px 15px 5px 15px;">Participants</div>
                    <div id="group-members-list-info" class="group-members-list"></div>
                    <div style="padding: 0 15px;">
                        <button id="open-add-member-modal-btn" class="btn-add-member"><i class="fas fa-user-plus"></i> Ajouter des participants</button>
                    </div>
                </div>
                <div class="group-danger-zone">
                    <button id="group-leave-btn" class="btn-danger-outline"><i class="fas fa-sign-out-alt"></i> Quitter le groupe</button>
                </div>
            </div>
        </div>

        <div id="post-creation-view" class="view post-creation-view secondary">
            <div class="view-header"><i id="post-creation-back-btn" class="fas fa-arrow-left back-button"></i><h1 class="header-title">Nouveau Post</h1><button id="publish-button" disabled>Publier</button></div>
            <div class="post-input-area">
                <div id="square-content" class="font-inter">
                    <div id="input-highlighter"></div>
                    <textarea id="post-textarea" placeholder="Exprimez-vous..." maxlength="200"></textarea> 
                </div>
                <div class="char-limit-indicator"><span id="char-count">0</span> / 70</div>
            </div>
            <div class="post-controls">
                <div class="control-row">
                    <label>Média</label>
                    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                    <div style="display:flex; gap:10px;">
                        <button class="control-button" id="add-image-button"><i class="fas fa-camera"></i></button>
                        <button class="control-button" id="add-poll-button"><i class="fas fa-list-ul"></i></button>
                        <button class="control-button" id="remove-image-button" style="display:none; color: var(--dislike-color);"><i class="fas fa-trash"></i></button>
                        <button class="control-button" id="remove-poll-button" style="display:none; color: var(--dislike-color);"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                
                <!-- SONDAGE INPUTS -->
                <div id="poll-creator-container" style="display:none; flex-direction:column; gap:8px;">
                    <input type="text" id="poll-opt1" placeholder="Option 1" class="auth-input" style="margin:0; padding:10px;">
                    <input type="text" id="poll-opt2" placeholder="Option 2" class="auth-input" style="margin:0; padding:10px;">
                </div>

                <div class="control-row" id="bg-color-control-row"><label>Couleur de fond</label><div class="color-swatches-container" id="post-color-swatches"></div></div>
                <div class="control-row"><label>Style de police</label><button class="control-button" id="font-style-button"><i class="fas fa-font"></i></button></div>
                <div class="control-row"><label>Publier en anonyme</label><label class="switch"><input type="checkbox" id="anonymous-switch-input"><span class="slider"></span></label></div>
            </div>
        </div>
        
        <div id="post-info-view" class="view post-info-view secondary">
             <div class="view-header">
                <i id="close-post-info-btn" class="fas fa-arrow-left back-button"></i>
                <h1 class="header-title">Infos publication</h1>
                <div class="header-placeholder"></div>
            </div>
            <div class="post-info-content" style="background:var(--page-bg);">
                <div class="info-stat-row">
                    <div class="info-stat-box"><span id="info-views-count" class="info-stat-val">0</span><span class="info-stat-label">Vues</span></div>
                    <div class="info-stat-box"><span id="info-likes-count" class="info-stat-val" style="color:var(--like-color)">0</span><span class="info-stat-label">Likes</span></div>
                    <div class="info-stat-box"><span id="info-dislikes-count" class="info-stat-val" style="color:var(--dislike-color)">0</span><span class="info-stat-label">Dislikes</span></div>
                </div>
                <div style="padding:15px;"><h4 style="margin:0;font-size:14px;color:#666;">Amis qui n'ont pas vu le post :</h4></div>
                <div id="not-seen-list" class="not-seen-list"></div>
            </div>
        </div>

        <div id="toast-message">Message</div>
        <div id="share-capture-container"></div>
        
        <nav class="nav-bar">
            <div class="nav-item active" data-view="feed-view"><i class="fas fa-home"></i><span>Flux</span></div>
            <div class="nav-item" data-view="contacts-view">
                <i class="fas fa-users"></i><span>Amis</span>
                <span id="nav-badge-contacts" class="notification-badge" style="display:none;">0</span>
            </div>
            <div class="nav-item" data-view="profile-view"><i class="fas fa-user"></i><span>Profil</span></div>
        </nav>
    </div>

    <!-- Modales -->
    <div id="edit-profile-modal" class="modal-backdrop"><div class="modal-content"><h3>Modifier le profil</h3><div><label>Nom d'utilisateur</label><input type="text" id="edit-username-input" maxlength="20"></div><div><label>Bio</label><textarea id="edit-bio-textarea" maxlength="150"></textarea></div><div><label>Couleur du profil</label><div id="edit-color-swatches"></div></div><div class="modal-actions"><button id="cancel-edit-btn">Annuler</button><button id="save-profile-btn">Enregistrer</button></div></div></div>
    <div id="friend-options-modal" class="modal-backdrop"><div class="modal-content"><h3>Options d'amis</h3><button id="show-friend-requests" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-bell"></i><span>Demandes d'amis</span></div><span id="pending-requests-count-badge" class="request-count-badge" style="display: none;">0</span></button><button id="enter-id-manually" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-id-card"></i><span>Ajouter par ID</span></div></button><button id="share-profile-link" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-share-alt"></i><span>Inviter un ami (Lien)</span></div></button><button id="show-my-qr" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-qrcode"></i><span>Mon QR Code</span></div></button><div class="modal-actions"><button id="cancel-friend-options-btn">Annuler</button></div></div></div>
    <div id="qr-code-modal" class="modal-backdrop"><div class="modal-content"><h3>Mon QR Code Drop</h3><canvas id="qr-code-canvas"></canvas><p style="font-size: 14px; text-align: center; color: var(--last-seen-color);">Partagez ce code ou votre ID : <strong id="qr-user-id" style="color: var(--text-color);"></strong></p><div class="modal-actions"><button id="close-qr-modal-btn" style="background-color: var(--highlight-color); color: white;">Fermer</button></div></div></div>
    <div id="paste-id-modal" class="modal-backdrop"><div class="modal-content"><h3>Ajouter un ami par ID</h3><p style="font-size: 14px; color: var(--last-seen-color); text-align: center;">Collez l'ID de l'utilisateur.</p><div><label>ID de l'utilisateur</label><input type="text" id="paste-id-input" placeholder="Coller l'ID ici..."></div><div class="modal-actions"><button id="cancel-paste-id-btn">Annuler</button><button id="send-friend-request-btn" style="background-color: var(--highlight-color); color: white;">Envoyer</button></div></div></div>
    <div id="friend-requests-modal" class="modal-backdrop"><div class="modal-content"><h3>Demandes d'amis</h3><div id="friend-requests-list"></div><div class="modal-actions"><button id="cancel-friend-requests-btn">Fermer</button></div></div></div>

    <div id="create-group-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Nouveau Groupe</h3>
            <div><label>Nom du groupe</label><input type="text" id="group-name-input" placeholder="Les Amis..."></div>
            <div><label>Description</label><textarea id="group-desc-input" placeholder="Description du groupe..."></textarea></div>
            <div><label>Membres</label><div id="group-friends-list"></div></div>
            <div class="modal-actions">
                <button id="cancel-group-modal-btn">Annuler</button>
                <button id="confirm-create-group-btn" style="background-color: var(--highlight-color); color: white;">Créer</button>
            </div>
        </div>
    </div>
    
    <div id="add-group-member-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Ajouter au groupe</h3>
            <div style="border-bottom: 1px solid #eee; padding-bottom: 15px;">
                <label>Ajouter par ID</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="add-member-id-input" placeholder="ID utilisateur">
                    <button id="add-member-by-id-btn" style="width:auto; background:var(--highlight-color); color:white;">OK</button>
                </div>
            </div>
            <div style="border-bottom: 1px solid #eee; padding-bottom: 15px;">
                 <button id="copy-group-link-btn" class="friend-option-button" style="width:100%"><div class="friend-option-button-text"><i class="fas fa-link"></i><span>Copier le lien d'invitation</span></div></button>
            </div>
            <div>
                <label>Sélectionner des amis</label>
                <div id="add-member-friends-list"></div>
            </div>
            <div class="modal-actions">
                <button id="cancel-add-group-member-btn">Fermer</button>
                <button id="confirm-add-members-btn" style="background-color: var(--highlight-color); color: white;">Ajouter</button>
            </div>
        </div>
    </div>

    <div id="group-member-options-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="member-options-title">Options</h3>
            <button id="promote-admin-btn" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-user-shield"></i><span>Promouvoir Admin</span></div></button>
            <button id="revoke-admin-btn" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-user"></i><span>Révoquer Admin</span></div></button>
            <button id="kick-member-btn" class="friend-option-button" style="border-color:var(--dislike-color); color:var(--dislike-color);"><div class="friend-option-button-text"><i class="fas fa-ban"></i><span>Retirer du groupe</span></div></button>
            <div class="modal-actions">
                <button id="cancel-member-options-btn">Annuler</button>
            </div>
        </div>
    </div>

    <div id="post-options-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Options publication</h3>
            <button id="view-post-btn" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-eye"></i><span>Voir la publication</span></div></button>
            <button id="info-post-btn" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-chart-bar"></i><span>Infos de la publication</span></div></button>
            <button id="delete-post-btn" class="friend-option-button" style="border-color:var(--dislike-color); color:var(--dislike-color);"><div class="friend-option-button-text"><i class="fas fa-trash"></i><span>Supprimer</span></div></button>
            <div class="modal-actions">
                <button id="cancel-post-options-btn">Annuler</button>
            </div>
        </div>
    </div>

    <div id="cropper-modal" class="modal-backdrop">
        <div class="modal-content" style="background: #222; color: white;">
            <h3>Recadrer l'image</h3>
            <div style="width: 100%; display: flex; justify-content: center; background: #000;">
                 <canvas id="cropper-canvas" width="300" height="300"></canvas>
            </div>
            <input type="range" id="zoom-slider" step="0.01" style="width: 100%; margin-top: 10px;">
            <div class="modal-actions">
                <button id="cancel-crop-btn">Annuler</button>
                <button id="confirm-crop-btn" style="background-color: var(--highlight-color); color: white;">Valider</button>
            </div>
        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, arrayUnion, arrayRemove, writeBatch, serverTimestamp, addDoc, deleteDoc, where, increment, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = '1:541715107757:web:0141b71ee3cd1ce5ec5b24'; 
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyB_z5U4yKJERho93p9696NujcG5R5fvlD8",
            authDomain: "studio-3374032724-f28d6.firebaseapp.com",
            projectId: "studio-3374032724-f28d6",
            appId: appId 
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const effectiveAppId = appId; 
        const dbPath = `artifacts/${effectiveAppId}/public/data`;
        const usersCollectionRef = collection(db, dbPath, 'users');
        const postsCollectionRef = collection(db, dbPath, 'posts');
        const groupsCollectionRef = collection(db, dbPath, 'groups');
        const chatsCollectionRef = collection(db, dbPath, 'chats');
        
        const PROFILE_COLORS = ['#e57373', '#81c784', '#64b5f6', '#f06292', '#ba68c8', '#ffd54f', '#7986cb', '#4db6ac', '#9575cd', '#4fc3f7', '#a1887f', '#90a4ae'];
        const POST_FONT_FAMILIES = ['font-inter', 'font-pacifico', 'font-mono', 'font-montserrat'];
        
        const STICKERS = [
            "mal_à_l'aise.gif", "amour.gif", "triste.gif", "colère.gif", "soulé.gif", "choqué.gif", "cligne.gif"
        ];

        const POST_COLOR_PALETTE = ['#FFFFFF', '#f1f1f1', '#D6E9F7', '#D1F7D1', '#FFF7D1', '#F7D1D1', '#A0D4FE', '#84E084', '#FEEA84', '#FE8484'];
        const MAX_CHARS = 70; 
        const BASE_URL = 'https://drop-24.netlify.app/';

        let currentUserId = null;
        let activeProfileUserId = null;
        let usersData = {};
        let postsData = [];
        let profilePostsCache = {}; 
        let filteredPostsData = []; 
        let pendingRequests = []; 
        
        let currentChatId = null; 
        let currentChatType = 'user'; 
        let conversationsData = {}; 
        
        let trendingTags = []; 
        let blockedUsers = [];
        let selectedPostId = null; 

        let unsubscribeChatListener = null;
        let unsubscribeUsersListener = null;
        let unsubscribeFeedListener = null;
        let unsubscribeFriendRequestsListener = null;
        let unsubscribeGroupsListener = null;
        let unsubscribeChatsMetaListener = null;
        let unsubscribeProfilePostsListener = null; 
        let countdownInterval = null;
        
        let isLoginMode = true;
        let referralId = null;

        let currentImageBase64 = null;
        let cropperImage = new Image();
        let cropperState = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };
        const CROP_SIZE = 800; 
        
        // POLL STATE
        let isPollMode = false;
        
        // MAP STATE
        let mapInstance = null;
        let mapMarkers = [];

        // DOM Elements
        const authView = document.getElementById('auth-view');
        const appContainer = document.getElementById('app-container');
        const viewWrapper = document.getElementById('view-wrapper');
        const navItems = document.querySelectorAll('.nav-item');
        const feedContent = document.getElementById('feed-content');
        
        const postCreationView = document.getElementById('post-creation-view');
        const postTextarea = document.getElementById('post-textarea');
        const inputHighlighter = document.getElementById('input-highlighter');
        const charCountSpan = document.getElementById('char-count');
        const publishButton = document.getElementById('publish-button');
        const squareContent = document.getElementById('square-content');
        const anonymousSwitch = document.getElementById('anonymous-switch-input');
        
        const imageUploadInput = document.getElementById('image-upload-input');
        const addImageButton = document.getElementById('add-image-button');
        const removeImageButton = document.getElementById('remove-image-button');
        const addPollButton = document.getElementById('add-poll-button');
        const removePollButton = document.getElementById('remove-poll-button');
        const pollCreatorContainer = document.getElementById('poll-creator-container');
        
        const cropperModal = document.getElementById('cropper-modal');
        const cropperCanvas = document.getElementById('cropper-canvas');
        const zoomSlider = document.getElementById('zoom-slider');
        const confirmCropBtn = document.getElementById('confirm-crop-btn');
        const cancelCropBtn = document.getElementById('cancel-crop-btn');
        let cropperCtx = null; 

        let currentPostFontIndex = 0;
        let currentPostColor = POST_COLOR_PALETTE[0];
        
        let toastTimeout;
        function showMessage(message, isSuccess) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message; toast.className = `show ${isSuccess?'success':'error'}`;
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.className = ''; }, 3000);
        }
        window.showMessage = showMessage;
        
        function showModal(el) { el.style.display = 'flex'; }
        function hideModal(el) { el.style.display = 'none'; }
        function showSecondaryView(el) { el.classList.add('visible'); }
        function hideSecondaryView(el) { el.classList.remove('visible'); }
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // --- PRESENCE SYSTEM ---
        function updatePresence() {
            if(!currentUserId) return;
            const userRef = doc(usersCollectionRef, currentUserId);
            // On met à jour lastSeen régulièrement pour dire "je suis là"
            updateDoc(userRef, {
                lastSeen: serverTimestamp(),
                isOnline: true
            }).catch(e => console.log("Presence err", e));
        }

        const initAuth = async () => { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); };
        initAuth();

        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('ref')) {
            referralId = urlParams.get('ref');
            sessionStorage.setItem('drop_ref', referralId);
        } else {
            referralId = sessionStorage.getItem('drop_ref');
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authView.style.display = 'none';
                appContainer.style.display = 'flex'; 
                await upsertUserDocument(user);
                
                // Init Presence Loop
                updatePresence();
                setInterval(updatePresence, 60000); // Heartbeat every 1 min
                
                listenToAllUsers(); 
                listenToFeed();
                listenToFriendRequests();
                listenToConversations();
                navigateTo('feed-view');
                
                const inviterId = urlParams.get('uid');
                const inviteGroupId = urlParams.get('group_invite');

                if(inviteGroupId) {
                    try {
                        const gRef = doc(groupsCollectionRef, inviteGroupId);
                        await updateDoc(gRef, { members: arrayUnion(currentUserId) });
                        showMessage("Groupe rejoint !", true);
                        showChat(inviteGroupId, 'group');
                        window.history.replaceState({}, document.title, "/");
                    } catch(e) { console.error(e); showMessage("Erreur invitation groupe.", false); }
                } else if(inviterId && inviterId !== currentUserId) {
                    await sendFriendRequest(inviterId);
                    window.history.replaceState({}, document.title, "/"); 
                }
            } else {
                currentUserId = null;
                authView.style.display = 'flex';
                appContainer.style.display = 'none';
                if(unsubscribeUsersListener) unsubscribeUsersListener();
                if(unsubscribeFeedListener) unsubscribeFeedListener();
                if(unsubscribeGroupsListener) unsubscribeGroupsListener();
                if(unsubscribeChatsMetaListener) unsubscribeChatsMetaListener();
                if(unsubscribeProfilePostsListener) unsubscribeProfilePostsListener();
            }
        });

        // Auth Logic Handlers...
        document.getElementById('auth-toggle-link').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('login-btn').textContent = isLoginMode ? "Se connecter" : "S'inscrire";
            document.getElementById('auth-toggle-text').textContent = isLoginMode ? "Pas de compte ?" : "Déjà un compte ?";
            document.getElementById('auth-toggle-link').textContent = isLoginMode ? "S'inscrire" : "Se connecter";
        });
        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            if(!email || !password) return showMessage("Veuillez remplir les champs.", false);
            try {
                if (isLoginMode) await signInWithEmailAndPassword(auth, email, password);
                else { await createUserWithEmailAndPassword(auth, email, password); showMessage("Compte créé !", true); }
            } catch (error) { 
                console.error("Auth Error:", error);
                showMessage("Erreur d'authentification", false); 
            }
        });
        document.getElementById('google-btn').addEventListener('click', async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (error) { showMessage("Erreur Google", false); }
        });
        document.getElementById('logout-btn').addEventListener('click', async () => { 
            if(currentUserId) {
                // Set offline on logout
                 updateDoc(doc(usersCollectionRef, currentUserId), { isOnline: false });
            }
            await signOut(auth); 
        });

        async function upsertUserDocument(user) {
            const userRef = doc(usersCollectionRef, user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                const newData = {
                    username: user.displayName || `user_${user.uid.substring(0, 4)}`, 
                    profileColor: PROFILE_COLORS[Math.floor(Math.random() * PROFILE_COLORS.length)],
                    accountCreatedAt: serverTimestamp(), friends: [], postsCount: 0, blockedUsers: [],
                    badges: [], isOnline: true, lastSeen: serverTimestamp() 
                };
                if(referralId && referralId !== user.uid) {
                    newData.referredBy = referralId;
                }
                await setDoc(userRef, newData);
            } else {
                await updateDoc(userRef, { isOnline: true, lastSeen: serverTimestamp() });
                if(!userDoc.data().blockedUsers) await updateDoc(userRef, { blockedUsers: [] });
            }
        }

        function navigateTo(viewId) {
            const viewIndex = ['feed-view', 'contacts-view', 'profile-view'].indexOf(viewId);
            if (viewIndex === -1) return;
            viewWrapper.style.transform = `translateX(-${viewIndex * 100}%)`;
            navItems.forEach(item => { item.classList.toggle('active', item.dataset.view === viewId); });
            if(viewId === 'profile-view') showProfile(currentUserId);
        }

        function generateAvatarUrl(user) {
            if (!user) return '';
            return `https://ui-avatars.com/api/?name=${user.username}&background=${(user.profileColor||'888').replace('#','')}&color=fff&size=128&bold=true`;
        }
        
        function getBadgesHTML(user) {
            if(!user || !user.badges) return '';
            let html = '';
            if(user.badges.includes('staff')) html += '<i class="fas fa-check-circle user-badge badge-staff" title="Staff"></i>';
            if(user.badges.includes('certif')) html += '<i class="fas fa-check-circle user-badge badge-certif" title="Certifié"></i>';
            if(user.badges.includes('vip')) html += '<i class="fas fa-star user-badge badge-vip" title="VIP"></i>';
            if(user.badges.includes('patron')) html += '<i class="fas fa-briefcase user-badge badge-patron" title="Patron"></i>';
            return html;
        }

        // HELPER: Check if online (based on field + timeout fallback 10min)
        function isUserOnline(u) {
            if(!u) return false;
            if(!u.lastSeen) return false;
            // Si explicitement offline
            if(u.isOnline === false) return false;
            // Fallback: si lastSeen > 10min, consider offline
            const now = new Date();
            const last = u.lastSeen.toDate ? u.lastSeen.toDate() : new Date(u.lastSeen);
            const diffMins = (now - last) / 60000;
            return diffMins < 10;
        }

        function listenToAllUsers() {
            unsubscribeUsersListener = onSnapshot(query(usersCollectionRef, limit(50)), (snapshot) => {
                snapshot.forEach((doc) => { usersData[doc.id] = { id: doc.id, ...doc.data() }; });
                blockedUsers = usersData[currentUserId]?.blockedUsers || [];
                renderFriendsList(); 
                if (activeProfileUserId && activeProfileUserId !== currentUserId) showProfile(activeProfileUserId);
            });
        }
        
        // ... Listen to Conversations, FriendRequests (Standard) ... 
        function listenToConversations() {
            if (!currentUserId) return;
            const qGroups = query(groupsCollectionRef, where('members', 'array-contains', currentUserId));
            unsubscribeGroupsListener = onSnapshot(qGroups, (snap) => {
                snap.forEach(d => {
                    const data = d.data();
                    const unread = data[`unreadCount_${currentUserId}`] || 0;
                    conversationsData[d.id] = { type: 'group', id: d.id, name: data.name, data: data, timestamp: data.lastMessageTime ? data.lastMessageTime.seconds : 0, unreadCount: unread };
                });
                updateGlobalUnreadBadge();
                renderFriendsList();
            });
            const qChats = query(chatsCollectionRef, where('participants', 'array-contains', currentUserId));
            unsubscribeChatsMetaListener = onSnapshot(qChats, (snap) => {
                snap.forEach(d => {
                    const data = d.data();
                    const unread = data[`unreadCount_${currentUserId}`] || 0;
                    conversationsData[d.id] = { type: 'user', id: d.id, data: data, timestamp: data.lastMessageTime ? data.lastMessageTime.seconds : 0, unreadCount: unread };
                });
                updateGlobalUnreadBadge();
                renderFriendsList();
            });
        }

        function updateGlobalUnreadBadge() {
            let total = 0;
            Object.values(conversationsData).forEach(c => total += (c.unreadCount || 0));
            const badge = document.getElementById('nav-badge-contacts');
            if (total > 0) { badge.style.display = 'block'; badge.textContent = total > 99 ? '99+' : total; } 
            else { badge.style.display = 'none'; }
        }
        
        function listenToFriendRequests() {
            if (!currentUserId) return;
            const requestsRef = collection(db, dbPath, 'users', currentUserId, 'friendRequests');
            unsubscribeFriendRequestsListener = onSnapshot(requestsRef, (snapshot) => {
                pendingRequests = [];
                snapshot.forEach(doc => { pendingRequests.push({ id: doc.id, ...doc.data() }); });
                updateFriendRequestBadge(pendingRequests.length);
                if(document.getElementById('friend-requests-modal').style.display === 'flex') renderFriendRequestsList();
            });
        }
        function updateFriendRequestBadge(count) {
            const fab = document.getElementById('add-friend-fab');
            let badge = fab.querySelector('.request-badge');
            const modalBadge = document.getElementById('pending-requests-count-badge');
            if (count > 0) {
                if (!badge) { badge = document.createElement('div'); badge.className='request-badge'; fab.appendChild(badge); }
                badge.textContent = count;
                modalBadge.textContent = count; modalBadge.style.display='inline-block';
            } else {
                if (badge) badge.remove();
                modalBadge.style.display='none';
            }
        }
        function renderFriendRequestsList() {
            const list = document.getElementById('friend-requests-list'); list.innerHTML = '';
            pendingRequests.forEach(req => {
                const u = usersData[req.senderId];
                if(blockedUsers.includes(req.senderId)) return;
                const div = document.createElement('div'); div.className='friend-request-item';
                div.innerHTML = `<div class="friend-request-info"><img src="${generateAvatarUrl(u)}"><span>${u?u.username:'...'} ${getBadgesHTML(u)}</span></div><div class="friend-request-actions"><button class="request-accept-btn"><i class="fas fa-check"></i></button><button class="request-reject-btn"><i class="fas fa-times"></i></button></div>`;
                div.querySelector('.request-accept-btn').onclick = () => acceptFriendRequest(req.senderId);
                div.querySelector('.request-reject-btn').onclick = () => rejectFriendRequest(req.senderId);
                list.appendChild(div);
            });
        }
        async function sendFriendRequest(rid) {
            if(!rid || rid === currentUserId) return;
            try { await setDoc(doc(db, dbPath, 'users', rid, 'friendRequests', currentUserId), { senderId: currentUserId, timestamp: serverTimestamp() }); showMessage("Envoyé !", true); } catch(e){ showMessage("Erreur.", false); }
        }
        async function acceptFriendRequest(sid) {
            const batch = writeBatch(db);
            batch.update(doc(usersCollectionRef, currentUserId), { friends: arrayUnion(sid) });
            batch.delete(doc(db, dbPath, 'users', currentUserId, 'friendRequests', sid));
            batch.update(doc(usersCollectionRef, sid), { friends: arrayUnion(currentUserId) });
            try { await batch.commit(); showMessage("Ami ajouté !", true); } catch(e){ showMessage("Erreur.", false); }
        }
        async function rejectFriendRequest(sid) {
            try { await deleteDoc(doc(db, dbPath, 'users', currentUserId, 'friendRequests', sid)); } catch(e){}
        }
        
        // RENDER FRIENDS LIST (With Status)
        function renderFriendsList() {
            const list = document.getElementById('friends-list'); list.innerHTML='';
            const term = document.getElementById('search-input').value.toLowerCase();
            
            let allItems = [];
            const friends = (usersData[currentUserId]?.friends || []).map(id => usersData[id]).filter(u => u && !blockedUsers.includes(u.id));
            friends.forEach(f => {
                const cid = getChatId(currentUserId, f.id);
                const meta = conversationsData[cid] || { timestamp: 0, unreadCount: 0 };
                allItems.push({ type: 'user', data: f, id: f.id, sortTime: meta.timestamp, unread: meta.unreadCount, name: f.username });
            });
            Object.values(conversationsData).filter(c => c.type === 'group').forEach(g => {
                allItems.push({ type: 'group', data: g.data, id: g.id, sortTime: g.timestamp, unread: g.unreadCount, name: g.name });
            });

            allItems.sort((a, b) => b.sortTime - a.sortTime);

            allItems.filter(item => item.name.toLowerCase().includes(term)).forEach(item => {
                const d = document.createElement('div'); d.className = 'friend-item';
                let avatarHTML = '', title = '', subtitle = '';

                if (item.type === 'user') {
                    const isOnline = isUserOnline(item.data);
                    const statusClass = isOnline ? 'status-online' : 'status-offline';
                    avatarHTML = `
                    <div class="pp-container" style="width:50px;height:50px;margin-right:15px;">
                        <img class="friend-pp" style="margin:0;" src="${generateAvatarUrl(item.data)}">
                        <div class="status-dot ${statusClass}"></div>
                    </div>`;
                    title = `${item.name} ${getBadgesHTML(item.data)}`; 
                    subtitle = isOnline ? "En ligne" : "Hors ligne";
                } else {
                    avatarHTML = `<div class="friend-pp" style="background:#333;color:white;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:15px;"><i class="fas fa-users"></i></div>`;
                    title = item.name; subtitle = "Groupe";
                }

                let badgeHTML = '';
                if (item.unread > 0) {
                    badgeHTML = `<div class="dm-unread-badge">${item.unread > 99 ? '99+' : item.unread}</div>`;
                }

                d.innerHTML = `${avatarHTML}<div class="friend-info"><h4>${title}</h4><p>${subtitle}</p></div><div class="dm-button-container"><button class="dm-button">Message</button>${badgeHTML}</div>`;
                d.querySelector('.dm-button').onclick = (e) => { e.stopPropagation(); showChat(item.id, item.type === 'user' ? 'user' : 'group'); };
                if (item.type === 'user') d.onclick = () => showProfile(item.id);
                else d.onclick = () => showChat(item.id, 'group');
                list.appendChild(d);
            });
        }
        
        // --- MAP LOGIC ---
        document.getElementById('open-map-btn').onclick = () => {
            if(!navigator.geolocation) return showMessage("Géolocalisation non supportée", false);
            
            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                // Update my location in DB
                if(currentUserId) {
                    updateDoc(doc(usersCollectionRef, currentUserId), {
                        location: { lat, lng },
                        lastSeen: serverTimestamp(),
                        isOnline: true
                    }).catch(e => console.error("Loc update fail", e));
                }
                
                showSecondaryView(document.getElementById('map-view'));
                initMap(lat, lng);
                
            }, () => {
                showMessage("Autorisation refusée ou erreur GPS", false);
            });
        };
        
        document.getElementById('map-back-btn').onclick = () => hideSecondaryView(document.getElementById('map-view'));

        function initMap(lat, lng) {
            if (!mapInstance) {
                mapInstance = L.map('map-container').setView([lat, lng], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(mapInstance);
            } else {
                mapInstance.setView([lat, lng], 14);
            }
            
            // Clear existing markers
            mapMarkers.forEach(m => mapInstance.removeLayer(m));
            mapMarkers = [];
            
            // Add ME
            const myIcon = L.divIcon({
                className: 'custom-map-marker',
                html: `<img class="map-avatar-icon online" src="${generateAvatarUrl(usersData[currentUserId])}" style="width:40px;height:40px;">`,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
            const myMarker = L.marker([lat, lng], {icon: myIcon}).addTo(mapInstance);
            myMarker.bindPopup("Moi");
            mapMarkers.push(myMarker);
            
            // Add Friends
            const friends = (usersData[currentUserId]?.friends || []).map(id => usersData[id]).filter(u => u && !blockedUsers.includes(u.id));
            
            friends.forEach(f => {
                if(f.location && f.location.lat && f.location.lng) {
                    const isOnline = isUserOnline(f);
                    const statusClass = isOnline ? 'online' : 'offline';
                    
                    const fIcon = L.divIcon({
                        className: 'custom-map-marker',
                        html: `<img class="map-avatar-icon ${statusClass}" src="${generateAvatarUrl(f)}" style="width:40px;height:40px;">`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    
                    const m = L.marker([f.location.lat, f.location.lng], {icon: fIcon}).addTo(mapInstance);
                    m.bindPopup(`<b>${f.username}</b><br>${isOnline ? 'En ligne' : 'Vu récemment'}`);
                    mapMarkers.push(m);
                }
            });
            
            // Fix Leaflet sizing issue in hidden container
            setTimeout(() => { mapInstance.invalidateSize(); }, 200);
        }

        // --- PROFILE LOGIC ---
        async function showProfile(uid) {
            if(unsubscribeProfilePostsListener) {
                unsubscribeProfilePostsListener();
                unsubscribeProfilePostsListener = null;
            }

            activeProfileUserId = uid;
            const isMe = uid === currentUserId;

            if (isMe) {
                const activeNav = document.querySelector('.nav-item.active');
                if (activeNav && activeNav.dataset.view !== 'profile-view') {
                    navigateTo('profile-view');
                    return; 
                }
                document.querySelectorAll('.view.secondary').forEach(el => el.classList.remove('visible'));
            } else {
                showSecondaryView(document.getElementById('user-profile-view'));
            }

            let u = usersData[uid];
            
            const updateUI = (userData) => {
                if(!userData) return;
                const prefix = isMe ? 'profile' : 'other-profile';
                const elName = document.getElementById(`${prefix}-username`);
                const elPic = document.getElementById(`${prefix}-pic`);
                const elBio = document.getElementById(`${prefix}-bio`);
                const elPosts = document.getElementById(isMe ? 'posts-count' : 'other-posts-count');
                const elFollowers = document.getElementById(isMe ? 'followers-count' : 'other-followers-count');
                
                if(elName) elName.innerHTML = `${userData.username} ${getBadgesHTML(userData)}`;
                if(elPic) elPic.src = generateAvatarUrl(userData);
                if(elBio) elBio.textContent = userData.bio || "";
                if(elPosts) elPosts.textContent = userData.postsCount || 0;
                if(elFollowers) elFollowers.textContent = (userData.friends||[]).length;
                
                if(isMe) {
                    const elDate = document.getElementById('creation-date');
                    const date = userData.accountCreatedAt?.toDate ? userData.accountCreatedAt.toDate().toLocaleDateString('fr-FR') : '...';
                    if(elDate) elDate.textContent = date;
                    document.getElementById('edit-bio-btn').style.display = 'block';
                    document.getElementById('logout-btn').style.display = 'block'; 
                } else {
                    const isOnline = isUserOnline(userData);
                    const statusEl = document.getElementById('other-profile-status');
                    if(statusEl) {
                        statusEl.className = `status-dot ${isOnline ? 'status-online' : 'status-offline'}`;
                    }

                    const isFriend = usersData[currentUserId]?.friends?.includes(uid);
                    const isBlocked = blockedUsers.includes(uid);
                    document.getElementById('action-add-friend').style.display = isFriend || isBlocked ? 'none' : 'block';
                    document.getElementById('action-message-user').style.display = isFriend && !isBlocked ? 'block' : 'none';
                    const blockBtn = document.getElementById('action-block-user');
                    blockBtn.style.display = 'block';
                    blockBtn.textContent = isBlocked ? "Débloquer" : "Bloquer";
                    
                    document.getElementById('action-add-friend').onclick = () => sendFriendRequest(uid);
                    document.getElementById('action-message-user').onclick = () => showChat(uid, 'user');
                    blockBtn.onclick = () => toggleBlockUser(uid);
                    document.getElementById('user-profile-back-btn').onclick = () => hideSecondaryView(document.getElementById('user-profile-view'));
                }
            };

            if(u) {
                updateUI(u);
            } else {
                if(isMe) document.getElementById('profile-username').textContent = "Chargement...";
                else document.getElementById('other-profile-username').textContent = "Chargement...";
                
                getDoc(doc(usersCollectionRef, uid)).then(snap => {
                    if(snap.exists()) {
                        usersData[uid] = { id: snap.id, ...snap.data() };
                        updateUI(usersData[uid]);
                    }
                });
            }

            const qProfilePosts = query(postsCollectionRef, where('publisherId', '==', uid), orderBy('createdAt', 'desc'), limit(20));
            
            unsubscribeProfilePostsListener = onSnapshot(qProfilePosts, (snap) => {
                profilePostsCache[uid] = [];
                snap.forEach(d => profilePostsCache[uid].push({ id: d.id, ...d.data() }));
                renderProfilePosts(uid, isMe ? 'my-posts-grid' : 'other-posts-grid');
            }, (error) => {
                console.error("Erreur Posts:", error);
            });
        }

        async function toggleBlockUser(uid) {
             const isBlocked = blockedUsers.includes(uid);
             if(isBlocked) {
                 await updateDoc(doc(usersCollectionRef, currentUserId), { blockedUsers: arrayRemove(uid) });
                 showMessage("Utilisateur débloqué", true);
             } else {
                 await updateDoc(doc(usersCollectionRef, currentUserId), { blockedUsers: arrayUnion(uid) });
                 showMessage("Utilisateur bloqué", true);
             }
        }

        function renderProfilePosts(uid, gridId) {
            const grid = document.getElementById(gridId);
            const userPosts = (profilePostsCache[uid] || postsData.filter(p => p.publisherId === uid)).filter(p => !p.isAnon);
            const fragment = document.createDocumentFragment();
            
            userPosts.forEach(p => {
                const div = document.createElement('div'); div.className = 'post-thumbnail';
                if (p.imageBase64) div.style.backgroundImage = `url('${p.imageBase64}')`;
                else div.style.backgroundColor = p.backgroundColor;
                
                div.innerHTML = `<div class="post-thumbnail-views"><i class="fas fa-eye"></i> ${p.views || 0}</div>`;
                
                div.onclick = () => {
                    if (uid === currentUserId) {
                        openPostOptions(p);
                    } else {
                        navigateTo('feed-view');
                        setTimeout(() => {
                             const el = document.querySelector(`.post-card[data-post-id="${p.id}"]`);
                             if(el) {
                                 el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                 hideSecondaryView(document.getElementById('user-profile-view'));
                             } else {
                                 showMessage("Ce post est trop ancien pour le flux global.", false);
                             }
                        }, 300);
                    }
                };
                fragment.appendChild(div);
            });
            
            requestAnimationFrame(() => {
                grid.innerHTML = '';
                grid.appendChild(fragment);
            });
        }
        
        function openPostOptions(post) {
            selectedPostId = post.id;
            const modal = document.getElementById('post-options-modal');
            
            document.getElementById('view-post-btn').onclick = () => {
                hideModal(modal);
                navigateTo('feed-view');
                setTimeout(() => {
                    const el = document.querySelector(`.post-card[data-post-id="${post.id}"]`);
                    if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            };
            
            document.getElementById('info-post-btn').onclick = () => {
                hideModal(modal);
                showPostInfo(post);
            };
            
            document.getElementById('delete-post-btn').onclick = async () => {
                if(confirm("Supprimer définitivement cette publication ?")) {
                    await deleteDoc(doc(postsCollectionRef, post.id));
                    await updateDoc(doc(usersCollectionRef, currentUserId), { postsCount: increment(-1) });
                    hideModal(modal);
                    showMessage("Post supprimé", true);
                    renderProfilePosts(currentUserId, 'my-posts-grid');
                }
            };
            
            document.getElementById('cancel-post-options-btn').onclick = () => hideModal(modal);
            showModal(modal);
        }

        function showPostInfo(post) {
            const view = document.getElementById('post-info-view');
            document.getElementById('info-views-count').textContent = post.views || 0;
            document.getElementById('info-likes-count').textContent = (post.likedBy || []).length;
            document.getElementById('info-dislikes-count').textContent = (post.dislikedBy || []).length;
            
            const list = document.getElementById('not-seen-list'); list.innerHTML = '';
            const myFriends = usersData[currentUserId]?.friends || [];
            const viewedBy = post.viewedBy || [];
            
            const notSeenFriends = myFriends.filter(fid => !viewedBy.includes(fid));
            
            if (notSeenFriends.length === 0) list.innerHTML = '<p style="text-align:center;padding:10px;color:gray;">Tout le monde a vu ça !</p>';
            
            notSeenFriends.forEach(fid => {
                 const u = usersData[fid];
                 if(u) {
                     const d = document.createElement('div'); d.className = 'friend-item';
                     d.innerHTML = `<img class="friend-pp" src="${generateAvatarUrl(u)}"><div class="friend-info"><h4>${u.username} ${getBadgesHTML(u)}</h4></div>`;
                     list.appendChild(d);
                 }
            });
            
            document.getElementById('close-post-info-btn').onclick = () => hideSecondaryView(view);
            showSecondaryView(view);
        }

        function listenToFeed() {
            unsubscribeFeedListener = onSnapshot(query(postsCollectionRef, limit(40)), (snap) => {
                const now = new Date();
                postsData = [];
                snap.forEach(d => {
                    const p = { id: d.id, ...d.data() };
                    const date = p.createdAt?.toDate ? p.createdAt.toDate() : new Date();
                    if (now.getTime() - date.getTime() > 86400000) {
                        deleteDoc(doc(postsCollectionRef, p.id)).catch(err => {});
                    } else {
                        p.expiresAt = new Date(date.getTime() + 86400000);
                        postsData.push(p);
                    }
                });
                postsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                debouncedRenderFeed();
            });
        }
        
        const debouncedRenderFeed = debounce(() => {
            updateTrendingStats();
            renderFeed();
            if(activeProfileUserId === currentUserId) renderProfilePosts(currentUserId, 'my-posts-grid');
            else if(activeProfileUserId) renderProfilePosts(activeProfileUserId, 'other-posts-grid');
        }, 200);

        function updateTrendingStats() {
            const tagCounts = {};
            postsData.forEach(p => {
                if(blockedUsers.includes(p.publisherId)) return;
                const tags = extractHashtags(p.message);
                tags.forEach(tag => {
                    const t = tag.toLowerCase();
                    tagCounts[t] = (tagCounts[t] || 0) + 1;
                });
            });

            trendingTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(e => ({ tag: e[0], count: e[1] }));
            
            renderTrendingSidebar();
        }

        function extractHashtags(text) {
             const regex = /#[\p{L}\p{N}_]+/gu;
             return text.match(regex) || [];
        }

        function renderTrendingSidebar() {
            const list = document.getElementById('trending-list');
            list.innerHTML = '';
            if (trendingTags.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:gray;">Aucune tendance pour le moment.</div>';
                return;
            }
            trendingTags.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'trending-item';
                div.innerHTML = `<span class="trending-rank">#${index+1}</span><span class="trending-tag">${item.tag}</span><span class="trending-count">${item.count} posts</span>`;
                div.onclick = () => {
                    toggleTrendingSidebar();
                    document.getElementById('feed-search-input').value = item.tag;
                    renderFeed();
                };
                list.appendChild(div);
            });
        }

        const sidebar = document.getElementById('trending-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        function toggleTrendingSidebar() {
            const isOpen = sidebar.classList.contains('open');
            if (isOpen) {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
            }
        }
        document.getElementById('trending-btn').onclick = toggleTrendingSidebar;
        document.getElementById('close-trending-btn').onclick = toggleTrendingSidebar;
        overlay.onclick = toggleTrendingSidebar;

        // VOTE POLL
        window.votePoll = async (postId, optionIdx) => {
            if(!currentUserId) return;
            const updates = {};
            if(optionIdx === 1) updates.pollVotes1 = arrayUnion(currentUserId);
            else updates.pollVotes2 = arrayUnion(currentUserId);
            
            try {
                await updateDoc(doc(postsCollectionRef, postId), updates);
            } catch(e) {
                console.error("Poll Vote Error:", e);
                showMessage("Erreur de vote", false);
            }
        };

        function renderFeed() {
            const term = document.getElementById('feed-search-input').value.toLowerCase();
            filteredPostsData = postsData.filter(p => !blockedUsers.includes(p.publisherId));
            
            if (term) {
                filteredPostsData = filteredPostsData.filter(p => {
                    const authorName = (usersData[p.publisherId]?.username || '').toLowerCase();
                    return p.message.toLowerCase().includes(term) || authorName.includes(term);
                });
            }
            
            if (!filteredPostsData.length) { feedContent.innerHTML = "<p style='text-align:center;color:gray;padding:20px;'>Rien à afficher.</p>"; return; }
            
            const postsToIncrement = [];
            
            const feedHTML = filteredPostsData.map(p => {
                const author = usersData[p.publisherId] || {username: 'Inconnu'};
                const rem = p.expiresAt - new Date();
                let bgStyle = `background-color:${p.backgroundColor}`;
                let txtClass = p.fontClass;
                if(p.imageBase64) { bgStyle = `background-image: url('${p.imageBase64}')`; txtClass += " snap-text"; }

                const hasLiked = (p.likedBy||[]).includes(currentUserId);
                const hasDisliked = (p.dislikedBy||[]).includes(currentUserId);
                const likes = (p.likedBy||[]).length;
                const dislikes = (p.dislikedBy||[]).length;
                const views = p.views || 0;
                
                if (!p.viewedBy || !p.viewedBy.includes(currentUserId)) {
                    postsToIncrement.push(p.id);
                }

                const formattedMessage = p.message.replace(/#[\p{L}\p{N}_]+/gu, (match) => {
                    return `<span class="post-hashtag" onclick="window.searchTag('${match}')">${match}</span>`;
                });

                // POLL RENDER LOGIC
                let pollHtml = '';
                if(p.isPoll && p.pollOptions && p.pollOptions.length === 2) {
                    const v1 = (p.pollVotes1 || []).length;
                    const v2 = (p.pollVotes2 || []).length;
                    const total = v1 + v2;
                    const hasVoted1 = (p.pollVotes1 || []).includes(currentUserId);
                    const hasVoted2 = (p.pollVotes2 || []).includes(currentUserId);
                    const hasVoted = hasVoted1 || hasVoted2;

                    if (!hasVoted) {
                        pollHtml = `
                            <div class="poll-square-container">
                                <div class="poll-square-inner">
                                    <div class="poll-question ${p.fontClass}">${formattedMessage}</div>
                                    <button class="poll-option-btn" onclick="votePoll('${p.id}', 1)">${p.pollOptions[0]}</button>
                                    <button class="poll-option-btn" onclick="votePoll('${p.id}', 2)">${p.pollOptions[1]}</button>
                                </div>
                            </div>
                        `;
                    } else {
                        const p1 = total === 0 ? 0 : Math.round((v1 / total) * 100);
                        const p2 = total === 0 ? 0 : Math.round((v2 / total) * 100);
                        
                        pollHtml = `
                            <div class="poll-square-container">
                                <div class="poll-square-inner">
                                    <div class="poll-question ${p.fontClass}">${formattedMessage}</div>
                                    <div class="poll-result-row">
                                        <div class="poll-result-header">
                                            <span>${p.pollOptions[0]}</span>
                                            <span>${p1}% (${v1})</span>
                                        </div>
                                        <div class="poll-bar-bg">
                                            <div class="poll-bar-fill" style="width:${p1}%; opacity:0.5;"></div>
                                            ${hasVoted1 ? '<div class="poll-bar-text"><i class="fas fa-check-circle poll-check"></i></div>' : ''}
                                        </div>
                                    </div>
                                    <div class="poll-result-row">
                                        <div class="poll-result-header">
                                            <span>${p.pollOptions[1]}</span>
                                            <span>${p2}% (${v2})</span>
                                        </div>
                                        <div class="poll-bar-bg">
                                            <div class="poll-bar-fill" style="width:${p2}%; opacity:0.5;"></div>
                                             ${hasVoted2 ? '<div class="poll-bar-text"><i class="fas fa-check-circle poll-check"></i></div>' : ''}
                                        </div>
                                    </div>
                                    <div style="text-align:right; font-size:12px; color:gray; margin-top:5px;">${total} votes</div>
                                </div>
                            </div>
                        `;
                    }
                }

                // ONCLICK LOGIC UPDATE FOR ANONYMOUS
                let publisherOnClick = '';
                if (p.isAnon) {
                    publisherOnClick = "window.showMessage('Cette personne est anonyme.', false)";
                } else {
                    // Check if it's me or someone else
                    publisherOnClick = `if('${p.publisherId}'==='${currentUserId}') navigateTo('profile-view'); else showProfile('${p.publisherId}')`;
                }

                return `<div class="post-card" data-post-id="${p.id}">
                    <div class="post-header"><span class="post-publisher" onclick="${publisherOnClick}">${p.isAnon?'Anonyme':author.username} ${!p.isAnon ? getBadgesHTML(author) : ''}</span><span class="post-countdown" data-exp="${p.expiresAt.getTime()}">${formatCountdown(rem)}</span></div>
                    
                    ${p.isPoll ? pollHtml : `<div class="post-image-wrapper" style="${bgStyle}"><div class="post-content-inner"><p class="post-message ${txtClass}">${formattedMessage}</p></div></div>`}
                    
                    <div class="post-actions">
                        <div class="action-button ${hasLiked?'liked':''}" onclick="likePost('${p.id}')"><i class="fas fa-thumbs-up"></i><span>${likes}</span></div>
                        <div class="action-button ${hasDisliked?'disliked':''}" onclick="dislikePost('${p.id}')"><i class="fas fa-thumbs-down"></i><span>${dislikes}</span></div>
                        <div class="action-button view-count"><i class="fas fa-eye"></i><span>${views}</span></div>
                        <div class="action-button share-btn" onclick="sharePost('${p.id}')"><i class="fas fa-share-square"></i></div>
                    </div>
                </div>`;
            }).join('');
            
            requestAnimationFrame(() => {
                feedContent.innerHTML = feedHTML;
            });
            
            if (postsToIncrement.length > 0) {
                 postsToIncrement.forEach(pid => {
                     updateDoc(doc(postsCollectionRef, pid), {
                         views: increment(1),
                         viewedBy: arrayUnion(currentUserId)
                     }).catch(e => console.log("View update err", e));
                 });
            }
            
            if(countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                document.querySelectorAll('.post-countdown').forEach(el => {
                    const rem = parseInt(el.dataset.exp) - Date.now();
                    if(rem>0) el.textContent = formatCountdown(rem); else el.closest('.post-card').remove();
                });
            }, 1000);
        }
        function formatCountdown(ms) {
            const s = Math.floor(ms/1000);
            return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        }
        
        window.searchTag = (tag) => {
             event.stopPropagation();
             document.getElementById('feed-search-input').value = tag.toLowerCase();
             renderFeed();
        };

        window.likePost = async (pid) => {
            const p = postsData.find(x => x.id === pid); if(!p) return;
            const ref = doc(postsCollectionRef, pid);
            const has = (p.likedBy||[]).includes(currentUserId);
            if(!has) await updateDoc(ref, { likedBy: arrayUnion(currentUserId), dislikedBy: arrayRemove(currentUserId) });
            else await updateDoc(ref, { likedBy: arrayRemove(currentUserId) });
        };
        window.dislikePost = async (pid) => {
            const p = postsData.find(x => x.id === pid); if(!p) return;
            const ref = doc(postsCollectionRef, pid);
            const has = (p.dislikedBy||[]).includes(currentUserId);
            if(!has) await updateDoc(ref, { dislikedBy: arrayUnion(currentUserId), likedBy: arrayRemove(currentUserId) });
            else await updateDoc(ref, { dislikedBy: arrayRemove(currentUserId) });
        };
        window.sharePost = async (pid) => {
            const p = postsData.find(x => x.id === pid); if(!p) return;
            const pub = p.isAnon ? "Anonyme" : (usersData[p.publisherId]?.username || "...");
            const card = document.createElement('div'); card.className = 'capture-card';
            
            // Set background
            if(p.imageBase64) card.style.backgroundImage = `url('${p.imageBase64}')`;
            else card.style.backgroundColor = p.backgroundColor || '#ffffff'; // Fallback white if undefined
            
            let contentHTML = '';

            if (p.isPoll && p.pollOptions && p.pollOptions.length === 2) {
                // Poll specific HTML for sharing
                contentHTML = `
                    <div style="width:100%; display:flex; flex-direction:column; align-items:center; gap:15px;">
                        <p class="post-message ${p.fontClass}" style="font-size:24px;text-align:center;color:var(--text-color); margin:0 0 20px 0; font-weight:700;">${p.message}</p>
                        <div style="width:100%; background:rgba(0,0,0,0.05); padding:10px; border-radius:8px; text-align:center; font-weight:600; color:#333;">${p.pollOptions[0]}</div>
                        <div style="width:100%; background:rgba(0,0,0,0.05); padding:10px; border-radius:8px; text-align:center; font-weight:600; color:#333;">${p.pollOptions[1]}</div>
                    </div>
                `;
                // Override card background for polls if it was transparent in feed (though create logic sets it to postColor)
                // In handlePublish: backgroundColor: (currentImageBase64 || isPollMode) ? 'transparent' : currentPostColor
                // If it is 'transparent', the share card will be transparent/white. Let's ensure it has a color or white.
                if (p.backgroundColor === 'transparent' || !p.backgroundColor) {
                    card.style.backgroundColor = '#ffffff';
                }
            } else {
                 // Standard post
                contentHTML = `<p class="post-message ${p.fontClass} ${p.imageBase64?'snap-text':''}" style="font-size:22px;text-align:center;color:${p.imageBase64?'white':'var(--text-color)'};">${p.message}</p>`;
            }
            
            card.innerHTML = `
                <div class="capture-publisher" style="position:absolute;top:20px;width:100%;text-align:center;font-weight:700;font-size:24px;color:rgba(0,0,0,0.5);">${pub}</div>
                <div style="display:flex;align-items:center;justify-content:center;height:100%;padding:40px;width:100%;">
                    ${contentHTML}
                </div>
                <div class="capture-watermark" style="position:absolute;bottom:10px;right:15px;font-size:12px;font-weight:600;color:rgba(0,0,0,0.3);font-family:'Pacifico';">Drop</div>
            `;
            const cont = document.getElementById('share-capture-container'); cont.innerHTML = ''; cont.appendChild(card);
            try {
                const canvas = await html2canvas(card, { useCORS: true, scale: 2 });
                canvas.toBlob(async (blob) => {
                    if (!blob) return showMessage("Erreur image.", false);
                    const file = new File([blob], 'drop_share.png', { type: 'image/png' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) { try { await navigator.share({ files: [file], title: 'Drop', text: `Post de ${pub}` }); } catch (err) {} } 
                    else { const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = 'drop.png'; a.click(); showMessage("Image téléchargée.", true); }
                    cont.innerHTML = '';
                });
            } catch(e) { showMessage("Erreur partage.", false); }
        };
        window.showProfile = showProfile; 

        document.getElementById('create-group-btn').onclick = () => {
            document.getElementById('group-name-input').value = '';
            document.getElementById('group-desc-input').value = '';
            const list = document.getElementById('group-friends-list'); list.innerHTML = '';
            const friends = (usersData[currentUserId]?.friends || []).map(id => usersData[id]).filter(u => u && !blockedUsers.includes(u.id));
            friends.forEach(f => {
                const d = document.createElement('div'); d.className = 'group-friend-select-item';
                d.innerHTML = `<input type="checkbox" value="${f.id}" id="gf-${f.id}"><label for="gf-${f.id}">${f.username}</label>`;
                d.onclick = (e) => { if(e.target.tagName!=='INPUT') { const cb = d.querySelector('input'); cb.checked = !cb.checked; } };
                list.appendChild(d);
            });
            showModal(document.getElementById('create-group-modal'));
        };
        document.getElementById('cancel-group-modal-btn').onclick = () => hideModal(document.getElementById('create-group-modal'));
        document.getElementById('confirm-create-group-btn').onclick = async () => {
            const name = document.getElementById('group-name-input').value.trim();
            const desc = document.getElementById('group-desc-input').value.trim();
            if(!name) return showMessage("Nom requis.", false);
            
            const selected = Array.from(document.querySelectorAll('#group-friends-list input:checked')).map(cb => cb.value);
            const members = [currentUserId, ...selected];
            
            try {
                const docRef = await addDoc(groupsCollectionRef, {
                    name: name, description: desc, admins: [currentUserId], members: members,
                    createdBy: currentUserId, createdAt: serverTimestamp(), lastMessageTime: serverTimestamp()
                });
                hideModal(document.getElementById('create-group-modal'));
                showMessage("Groupe créé !", true);
                showChat(docRef.id, 'group');
            } catch(e) { console.error(e); showMessage("Erreur.", false); }
        };

        function getChatId(u1, u2) { return [u1, u2].sort().join('_'); }
        
        async function showChat(id, type = 'user') {
            currentChatId = id; currentChatType = type;
            document.getElementById('chat-body').innerHTML = '';
            const chatView = document.getElementById('chat-view');
            const headerTitle = document.getElementById('chat-username');
            const headerImg = document.getElementById('chat-user-pp');
            const infoBtn = document.getElementById('group-info-btn');
            const placeholderRight = document.getElementById('chat-placeholder-right');

            showSecondaryView(chatView);

            let collRef;
            
            if (type === 'group') {
                let groupData = conversationsData[id]?.data; 
                if(!groupData) {
                    const snap = await getDoc(doc(groupsCollectionRef, id));
                    if(snap.exists()) groupData = snap.data();
                }
                headerTitle.textContent = groupData ? groupData.name : 'Groupe';
                headerImg.style.display = 'none'; infoBtn.style.display = 'block'; placeholderRight.style.display = 'none';
                infoBtn.onclick = () => openGroupInfo(id, groupData);
                
                const gRef = doc(groupsCollectionRef, id);
                updateDoc(gRef, { [`unreadCount_${currentUserId}`]: 0 }).catch(e=>console.log(e));
                
                collRef = collection(groupsCollectionRef, id, 'messages');
            } else {
                const u = usersData[id];
                headerTitle.textContent = u ? u.username : '...';
                headerImg.src = generateAvatarUrl(u); headerImg.style.display = 'block';
                infoBtn.style.display = 'none'; placeholderRight.style.display = 'block';

                const cid = getChatId(currentUserId, id); currentChatId = cid; 
                const cRef = doc(chatsCollectionRef, cid);
                
                updateDoc(cRef, { [`unreadCount_${currentUserId}`]: 0 }).catch(async (e) => {
                     await setDoc(cRef, { participants: [currentUserId, id], [`unreadCount_${currentUserId}`]: 0, lastMessageTime: serverTimestamp() }, { merge: true });
                });
                
                collRef = collection(chatsCollectionRef, currentChatId, 'messages');
            }

            if(unsubscribeChatListener) unsubscribeChatListener();
            
            let q;
            try {
                q = query(collRef, orderBy('createdAt', 'desc'), limit(50));
            } catch(e) {
                console.warn("Index manquant pour orderBy, fallback sur query simple", e);
                q = query(collRef);
            }
            
            unsubscribeChatListener = onSnapshot(q, snap => {
                const msgs = []; 
                snap.forEach(d => msgs.push({id: d.id, ...d.data()}));
                msgs.sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
                
                const chatBody = document.getElementById('chat-body');
                chatBody.innerHTML = '';

                const fragment = document.createDocumentFragment();
                msgs.forEach(m => {
                    if(blockedUsers.includes(m.senderId)) return;
                    const div = document.createElement('div');
                    const isMe = m.senderId === currentUserId;
                    const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                    div.className = `message-container ${isMe?'sent':'received'}`;
                    
                    let readStatus = '';
                    if(isMe && type === 'user') readStatus = m.read ? '<i class="fas fa-check-double" style="color:#3897f0"></i>' : '<i class="fas fa-check"></i>';
                    else if (!isMe && type === 'user') {
                        if (!m.read) updateDoc(doc(chatsCollectionRef, currentChatId, 'messages', m.id), { read: true });
                    }

                    let senderNameHtml = '';
                    if(type === 'group' && !isMe) {
                         const senderUser = usersData[m.senderId];
                         const senderPseudo = senderUser ? senderUser.username : 'Inconnu';
                         senderNameHtml = `<div class="message-sender-pseudo">${senderPseudo} ${getBadgesHTML(senderUser)}</div>`;
                    }

                    let contentHtml = '';
                    if (m.text.startsWith('[sticker:') && m.text.endsWith(']')) {
                        const fileName = m.text.substring(9, m.text.length - 1);
                        contentHtml = `${senderNameHtml}<div class="message-bubble ${isMe?'sent':'received'}" style="background:transparent;box-shadow:none;padding:0;"><img src="${fileName}" class="chat-sticker"><span class="message-time" style="color:black;">${time}</span></div>`;
                    } else {
                        contentHtml = `${senderNameHtml}<div class="message-bubble ${isMe?'sent':'received'}">${m.text}<span class="message-time">${time}${isMe ? `<span class="message-read-status">${readStatus}</span>` : ''}</span></div>`;
                    }
                    div.innerHTML = contentHtml;
                    fragment.appendChild(div);
                });
                chatBody.appendChild(fragment);
                document.getElementById('chat-content-container').scrollTop = document.getElementById('chat-content-container').scrollHeight;
            }, (error) => {
                 console.log("Erreur snapshot ou index manquant, chargement standard...", error);
                 unsubscribeChatListener = onSnapshot(query(collRef), snap => { });
            });
        }

        async function sendSticker(filename) { await sendMessageToChat(`[sticker:${filename}]`); }
        
        document.getElementById('send-button').onclick = async () => {
            const i = document.getElementById('message-input');
            const txt = i.value.trim();
            if(!txt) return;
            i.value = '';
            await sendMessageToChat(txt);
        };

        async function sendMessageToChat(text) {
             if(!currentChatId) return;
             const msgData = { text: text, senderId: currentUserId, createdAt: serverTimestamp(), read: false, readBy: [currentUserId] };

             if (currentChatType === 'group') {
                 await addDoc(collection(groupsCollectionRef, currentChatId, 'messages'), msgData);
                 const gRef = doc(groupsCollectionRef, currentChatId);
                 const groupSnap = await getDoc(gRef);
                 const members = groupSnap.data().members || [];
                 let updates = { lastMessageTime: serverTimestamp(), lastMessageText: text };
                 members.forEach(m => { if(m !== currentUserId) { updates[`unreadCount_${m}`] = increment(1); } });
                 await updateDoc(gRef, updates);
             } else {
                 const receiverId = currentChatId.split('_').find(id => id !== currentUserId);
                 msgData.receiverId = receiverId;
                 await addDoc(collection(chatsCollectionRef, currentChatId, 'messages'), msgData);
                 const cRef = doc(chatsCollectionRef, currentChatId);
                 await setDoc(cRef, { participants: arrayUnion(currentUserId, receiverId), lastMessageTime: serverTimestamp(), lastMessageText: text, [`unreadCount_${receiverId}`]: increment(1) }, { merge: true });
             }
        }

        document.getElementById('chat-back-btn').onclick = () => hideSecondaryView(document.getElementById('chat-view'));

        // CREATOR TOGGLE LOGIC
        addPollButton.onclick = () => {
            isPollMode = true;
            pollCreatorContainer.style.display = 'flex';
            
            // Disable Image mode
            addImageButton.style.display = 'none';
            removeImageButton.style.display = 'none'; // Ensure reset
            resetPostImage();
            
            // Show Remove Poll
            addPollButton.style.display = 'none';
            removePollButton.style.display = 'block';
            
            // Hide bg color
            document.getElementById('bg-color-control-row').style.display = 'none';
            squareContent.style.backgroundColor = 'transparent';
        };

        removePollButton.onclick = () => {
            isPollMode = false;
            pollCreatorContainer.style.display = 'none';
            document.getElementById('poll-opt1').value = '';
            document.getElementById('poll-opt2').value = '';
            
            // Re-enable Image mode
            addImageButton.style.display = 'block';
            addPollButton.style.display = 'block';
            removePollButton.style.display = 'none';
            
            // Restore bg color
            document.getElementById('bg-color-control-row').style.display = 'flex';
            squareContent.style.backgroundColor = currentPostColor;
        };

        function openGroupInfo(groupId, groupData) {
            const view = document.getElementById('group-info-view');
            const nameInp = document.getElementById('group-info-name');
            const descInp = document.getElementById('group-info-desc');
            const leaveBtn = document.getElementById('group-leave-btn');
            const memberList = document.getElementById('group-members-list-info');
            const addMemberBtn = document.getElementById('open-add-member-modal-btn');
            const saveNameBtn = document.getElementById('save-group-name-btn');
            const saveDescBtn = document.getElementById('save-group-desc-btn');
            
            const isAdmin = (groupData.admins || []).includes(currentUserId);
            const isFounder = (groupData.createdBy === currentUserId);
            
            nameInp.value = groupData.name; descInp.value = groupData.description;
            nameInp.disabled = !isAdmin; descInp.disabled = !isAdmin;
            addMemberBtn.style.display = 'block'; 
            
            if(isAdmin) {
                saveNameBtn.style.display = 'block';
                saveDescBtn.style.display = 'block';
                
                saveNameBtn.onclick = async () => {
                     await updateDoc(doc(groupsCollectionRef, groupId), { name: nameInp.value });
                     document.getElementById('chat-username').textContent = nameInp.value;
                     showMessage("Nom enregistré", true);
                };
                saveDescBtn.onclick = async () => {
                     await updateDoc(doc(groupsCollectionRef, groupId), { description: descInp.value });
                     showMessage("Description enregistrée", true);
                };
            } else {
                saveNameBtn.style.display = 'none';
                saveDescBtn.style.display = 'none';
            }
            
            memberList.innerHTML = '';
            (groupData.members || []).forEach(uid => {
                const u = usersData[uid];
                const isMemberAdmin = (groupData.admins || []).includes(uid);
                const isMemberFounder = (groupData.createdBy === uid);
                
                const div = document.createElement('div'); div.className = 'group-member-item';
                
                let badges = '';
                if(isMemberFounder) badges += '<span class="founder-badge">FONDATEUR</span>';
                else if(isMemberAdmin) badges += '<span class="admin-badge">ADMIN</span>';

                div.innerHTML = `<div class="group-member-info"><img src="${generateAvatarUrl(u || {username:'?'})}"><span>${u ? u.username : 'Inconnu'} ${getBadgesHTML(u)}</span>${badges}</div>`;
                
                div.onclick = () => {
                    if(!isAdmin) return; 
                    if(isMemberFounder) return;
                    openMemberOptions(groupId, uid, isMemberAdmin);
                };
                memberList.appendChild(div);
            });
            
            leaveBtn.onclick = async () => {
                if(confirm("Quitter le groupe ?")) {
                    await updateDoc(doc(groupsCollectionRef, groupId), { members: arrayRemove(currentUserId), admins: arrayRemove(currentUserId) });
                    hideSecondaryView(view); hideSecondaryView(document.getElementById('chat-view'));
                }
            };

            addMemberBtn.onclick = () => openAddMemberModal(groupId);

            document.getElementById('group-info-back-btn').onclick = () => hideSecondaryView(view);
            showSecondaryView(view);
        }

        function openMemberOptions(groupId, memberId, isTargetAdmin) {
            if(memberId === currentUserId) return; 
            const modal = document.getElementById('group-member-options-modal');
            const pBtn = document.getElementById('promote-admin-btn');
            const rBtn = document.getElementById('revoke-admin-btn');
            const kBtn = document.getElementById('kick-member-btn');
            
            pBtn.style.display = isTargetAdmin ? 'none' : 'flex';
            rBtn.style.display = isTargetAdmin ? 'flex' : 'none';
            kBtn.style.display = 'flex'; 
            
            pBtn.onclick = async () => {
                await updateDoc(doc(groupsCollectionRef, groupId), { admins: arrayUnion(memberId) });
                hideModal(modal); showChat(groupId, 'group'); 
            };
            rBtn.onclick = async () => {
                await updateDoc(doc(groupsCollectionRef, groupId), { admins: arrayRemove(memberId) });
                hideModal(modal); showChat(groupId, 'group');
            };
            kBtn.onclick = async () => {
                if(confirm("Voulez-vous vraiment retirer ce membre du groupe ?")) {
                    await updateDoc(doc(groupsCollectionRef, groupId), { members: arrayRemove(memberId), admins: arrayRemove(memberId) });
                    hideModal(modal); showChat(groupId, 'group');
                }
            };
            document.getElementById('cancel-member-options-btn').onclick = () => hideModal(modal);
            showModal(modal);
        }

        function openAddMemberModal(groupId) {
            const modal = document.getElementById('add-group-member-modal');
            const list = document.getElementById('add-member-friends-list');
            list.innerHTML = '';
            
            const gMembers = conversationsData[groupId]?.data.members || [];
            const friends = (usersData[currentUserId]?.friends || []).map(id => usersData[id]).filter(f => f && !gMembers.includes(f.id) && !blockedUsers.includes(f.id));
            
            friends.forEach(f => {
                const d = document.createElement('div'); d.className = 'group-friend-select-item';
                d.innerHTML = `<input type="checkbox" value="${f.id}" id="am-${f.id}"><label for="am-${f.id}">${f.username}</label>`;
                d.onclick = (e) => { if(e.target.tagName!=='INPUT') { const cb = d.querySelector('input'); cb.checked = !cb.checked; } };
                list.appendChild(d);
            });

            document.getElementById('add-member-by-id-btn').onclick = async () => {
                const val = document.getElementById('add-member-id-input').value.trim();
                if(val) {
                    await updateDoc(doc(groupsCollectionRef, groupId), { members: arrayUnion(val) });
                    hideModal(modal); showMessage("Membre ajouté", true); showChat(groupId, 'group');
                }
            };

            document.getElementById('copy-group-link-btn').onclick = () => {
                const link = `${BASE_URL}?group_invite=${groupId}`;
                navigator.clipboard.writeText(link).then(() => showMessage("Lien copié !", true));
            };

            document.getElementById('confirm-add-members-btn').onclick = async () => {
                const selected = Array.from(document.querySelectorAll('#add-member-friends-list input:checked')).map(cb => cb.value);
                if(selected.length > 0) {
                    await updateDoc(doc(groupsCollectionRef, groupId), { members: arrayUnion(...selected) });
                    hideModal(modal); showMessage("Membres ajoutés", true); showChat(groupId, 'group');
                }
            };
            
            document.getElementById('cancel-add-group-member-btn').onclick = () => hideModal(modal);
            showModal(modal);
        }

        document.getElementById('emoji-btn').onclick = () => {
            const p = document.getElementById('emoji-picker');
            if(p.style.display==='grid') { p.style.display='none'; } else {
                p.innerHTML=''; 
                STICKERS.forEach(s => {
                    const img = document.createElement('img'); img.src = s; img.className = 'picker-sticker';
                    img.onclick = () => { sendSticker(s); p.style.display = 'none'; };
                    p.appendChild(img);
                }); 
                p.style.display='grid';
            }
        };

        document.getElementById('edit-bio-btn').onclick = () => {
             const u = usersData[currentUserId];
             document.getElementById('edit-username-input').value = u.username;
             document.getElementById('edit-bio-textarea').value = u.bio;
             const cDiv = document.getElementById('edit-color-swatches'); cDiv.innerHTML='';
             PROFILE_COLORS.forEach(c => {
                 const d = document.createElement('div'); d.className='edit-color-swatch'; d.style.backgroundColor=c; d.dataset.color=c;
                 if(u.profileColor===c) d.classList.add('selected');
                 d.onclick=()=>{cDiv.querySelector('.selected')?.classList.remove('selected'); d.classList.add('selected');};
                 cDiv.appendChild(d);
             });
             showModal(document.getElementById('edit-profile-modal'));
        };
        document.getElementById('cancel-edit-btn').onclick = () => hideModal(document.getElementById('edit-profile-modal'));
        document.getElementById('save-profile-btn').onclick = async () => {
            await updateDoc(doc(usersCollectionRef, currentUserId), {
                username: document.getElementById('edit-username-input').value,
                bio: document.getElementById('edit-bio-textarea').value,
                profileColor: document.querySelector('#edit-color-swatches .selected')?.dataset.color
            });
            hideModal(document.getElementById('edit-profile-modal'));
        };

        async function shareProfileLink() {
            const link = `${BASE_URL}?ref=${currentUserId}`;
            try { await navigator.share({ title: 'Rejoins-moi sur Drop !', text: `Ajoute-moi sur Drop !`, url: link }); } catch (err) { if (err.name !== 'AbortError') navigator.clipboard.writeText(link).then(() => showMessage("Lien copié !", true)); }
        }
        function showMyQrCode() {
            const canvas = document.getElementById('qr-code-canvas');
            if (!currentUserId) return showMessage("Erreur ID.", false);
            const link = `${BASE_URL}?ref=${currentUserId}`;
            document.getElementById('qr-user-id').textContent = currentUserId; 
            QRCode.toCanvas(canvas, link, { width: 200, margin: 2 }, function (error) {
                if (error) return showMessage("Erreur QR.", false);
                hideModal(document.getElementById('friend-options-modal'));
                showModal(document.getElementById('qr-code-modal'));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            cropperCtx = cropperCanvas.getContext('2d');
            
            document.getElementById('create-post-header-btn').onclick = () => { resetPostCreator(); generatePostColorSwatches(); showSecondaryView(postCreationView); };
            document.getElementById('post-creation-back-btn').onclick = () => hideSecondaryView(postCreationView);
            addImageButton.onclick = () => imageUploadInput.click();
            imageUploadInput.onchange = (e) => {
                if(e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (evt) => { cropperImage.src = evt.target.result; cropperImage.onload = () => { initCropper(); showModal(cropperModal); } };
                    reader.readAsDataURL(e.target.files[0]);
                }
                e.target.value = '';
            };
            zoomSlider.oninput = () => drawCropper();
            
            const startDrag = (x, y) => { cropperState.isDragging=true; cropperState.startX=x; cropperState.startY=y; };
            const moveDrag = (x, y) => {
                if(!cropperState.isDragging) return;
                cropperState.x += x - cropperState.startX; cropperState.y += y - cropperState.startY;
                cropperState.startX = x; cropperState.startY = y;
                drawCropper();
            };
            const endDrag = () => cropperState.isDragging = false;
            
            cropperCanvas.addEventListener('mousedown', e => startDrag(e.clientX, e.clientY));
            window.addEventListener('mousemove', e => moveDrag(e.clientX, e.clientY));
            window.addEventListener('mouseup', endDrag);
            cropperCanvas.addEventListener('touchstart', e => { e.preventDefault(); startDrag(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
            window.addEventListener('touchmove', e => { if(cropperState.isDragging) e.preventDefault(); moveDrag(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
            window.addEventListener('touchend', endDrag);
            
            confirmCropBtn.onclick = () => {
                const tCvs = document.createElement('canvas'); tCvs.width = CROP_SIZE; tCvs.height = CROP_SIZE;
                const ctx = tCvs.getContext('2d');
                ctx.fillStyle = "#000000"; ctx.fillRect(0,0,CROP_SIZE,CROP_SIZE);
                
                const ratio = CROP_SIZE / 300; 
                const w = cropperImage.width * cropperState.scale * ratio;
                const h = cropperImage.height * cropperState.scale * ratio;
                const dx = (CROP_SIZE - w) / 2 + (cropperState.x * ratio);
                const dy = (CROP_SIZE - h) / 2 + (cropperState.y * ratio);
                
                ctx.drawImage(cropperImage, dx, dy, w, h);
                currentImageBase64 = tCvs.toDataURL('image/jpeg', 0.7);
                squareContent.style.backgroundImage = `url('${currentImageBase64}')`;
                squareContent.style.backgroundColor = 'transparent';
                postTextarea.classList.add('has-image');
                inputHighlighter.classList.add('has-image-overlay');
                document.getElementById('bg-color-control-row').style.display = 'none';
                addImageButton.style.display = 'none'; removeImageButton.style.display = 'block';
                checkPublishButton(); 
                hideModal(cropperModal);
            };
            cancelCropBtn.onclick = () => hideModal(cropperModal);
            removeImageButton.onclick = () => { resetPostImage(); checkPublishButton(); };
            publishButton.onclick = handlePublish;
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                     if(item.dataset.view === 'profile-view') { activeProfileUserId = currentUserId; showProfile(currentUserId); }
                     else navigateTo(item.dataset.view);
                });
            });
            document.getElementById('my-profile-nav-item').addEventListener('click', () => navigateTo('contacts-view'));
            document.getElementById('feed-search-input').addEventListener('input', renderFeed);
            document.getElementById('search-input').addEventListener('input', renderFriendsList);
            document.getElementById('add-friend-fab').onclick = () => showModal(document.getElementById('friend-options-modal'));
            document.getElementById('cancel-friend-options-btn').onclick = () => hideModal(document.getElementById('friend-options-modal'));
            document.getElementById('share-profile-link').onclick = () => shareProfileLink();
            document.getElementById('show-my-qr').onclick = () => showMyQrCode();
            document.getElementById('close-qr-modal-btn').onclick = () => hideModal(document.getElementById('qr-code-modal'));
            document.getElementById('show-friend-requests').onclick = () => { hideModal(document.getElementById('friend-options-modal')); showModal(document.getElementById('friend-requests-modal')); renderFriendRequestsList(); };
            document.getElementById('cancel-friend-requests-btn').onclick = () => hideModal(document.getElementById('friend-requests-modal'));
            document.getElementById('enter-id-manually').onclick = () => { hideModal(document.getElementById('friend-options-modal')); document.getElementById('paste-id-input').value = ''; showModal(document.getElementById('paste-id-modal')); };
            document.getElementById('cancel-paste-id-btn').onclick = () => hideModal(document.getElementById('paste-id-modal'));
            document.getElementById('send-friend-request-btn').onclick = async () => { await sendFriendRequest(document.getElementById('paste-id-input').value.trim()); hideModal(document.getElementById('paste-id-modal')); };
            
            const syncHighlighter = () => {
                const text = postTextarea.value;
                const safeText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const highlighted = safeText.replace(/(#[\p{L}\p{N}_]+)/gu, '<span class="hashtag-highlight">$1</span>');
                inputHighlighter.innerHTML = highlighted.replace(/\n/g, '<br>') + '<br>'; 
                
                const hashtags = extractHashtags(text);
                const textWithoutTags = text.replace(/#[\p{L}\p{N}_]+/gu, '').replace(/\s+/g, ' ');
                const realCount = textWithoutTags.trim().length;
                
                charCountSpan.textContent = realCount;
                
                const isLenOk = realCount <= MAX_CHARS;
                const isTagCountOk = hashtags.length <= 5;
                const hasContent = text.trim().length > 0 || !!currentImageBase64;

                charCountSpan.className = isLenOk ? '' : 'error';
                
                if (hasContent && isLenOk && isTagCountOk) {
                    publishButton.disabled = false;
                } else {
                    publishButton.disabled = true;
                }
            };

            postTextarea.addEventListener('input', syncHighlighter);
            postTextarea.addEventListener('scroll', () => { inputHighlighter.scrollTop = postTextarea.scrollTop; });
            
            document.getElementById('font-style-button').onclick = () => { squareContent.classList.remove(POST_FONT_FAMILIES[currentPostFontIndex]); currentPostFontIndex = (currentPostFontIndex+1)%POST_FONT_FAMILIES.length; squareContent.classList.add(POST_FONT_FAMILIES[currentPostFontIndex]); };
            document.getElementById('message-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') document.getElementById('send-button').click(); });
        });

        function checkPublishButton() {
            const event = new Event('input');
            postTextarea.dispatchEvent(event);
        }

        function initCropper() {
            cropperState = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };
            const scaleX = 300 / cropperImage.width;
            const scaleY = 300 / cropperImage.height;
            const scaleToFit = Math.min(scaleX, scaleY);
            const s = document.getElementById('zoom-slider');
            s.min = scaleToFit; s.max = scaleToFit * 3; s.step = scaleToFit / 20; s.value = scaleToFit;
            cropperState.scale = scaleToFit;
            drawCropper();
        }
        function drawCropper() {
            if(!cropperCtx) return;
            cropperCtx.fillStyle = "#000"; cropperCtx.fillRect(0,0,300,300);
            const scale = parseFloat(document.getElementById('zoom-slider').value);
            cropperState.scale = scale;
            const w = cropperImage.width * scale; const h = cropperImage.height * scale;
            const dx = (300 - w) / 2 + cropperState.x; const dy = (300 - h) / 2 + cropperState.y;
            cropperCtx.drawImage(cropperImage, dx, dy, w, h);
        }
        function resetPostCreator() { 
            resetPostImage(); 
            // Reset Poll
            removePollButton.click(); 
            postTextarea.value = ''; inputHighlighter.innerHTML=''; charCountSpan.textContent = '0'; squareContent.className = 'font-inter'; checkPublishButton(); 
        }
        function resetPostImage() { currentImageBase64 = null; squareContent.style.backgroundImage = ''; squareContent.style.backgroundColor = currentPostColor; postTextarea.classList.remove('has-image'); inputHighlighter.classList.remove('has-image-overlay'); document.getElementById('bg-color-control-row').style.display = 'flex'; addImageButton.style.display = 'block'; removeImageButton.style.display = 'none'; }
        function generatePostColorSwatches() {
            const div = document.getElementById('post-color-swatches'); div.innerHTML='';
            POST_COLOR_PALETTE.forEach(c => { const s = document.createElement('div'); s.className='color-swatch'; s.style.backgroundColor=c; if(c===currentPostColor) s.classList.add('selected'); s.onclick = () => { currentPostColor=c; if(!currentImageBase64) squareContent.style.backgroundColor=c; div.querySelector('.selected')?.classList.remove('selected'); s.classList.add('selected'); }; div.appendChild(s); });
            if(!currentImageBase64) squareContent.style.backgroundColor = currentPostColor;
        }
        async function handlePublish() {
            const txt = postTextarea.value.trim();
            if(!txt && !currentImageBase64 && !isPollMode) return;
            
            let pollData = {};
            if(isPollMode) {
                 const o1 = document.getElementById('poll-opt1').value.trim();
                 const o2 = document.getElementById('poll-opt2').value.trim();
                 if(!o1 || !o2) { showMessage("Remplissez les 2 options", false); return; }
                 pollData = {
                     isPoll: true,
                     pollOptions: [o1, o2],
                     pollVotes1: [],
                     pollVotes2: []
                 };
            }
            
            publishButton.disabled = true;
            try {
                await addDoc(postsCollectionRef, { 
                    message: txt, publisherId: anonymousSwitch.checked ? null : currentUserId, isAnon: anonymousSwitch.checked, 
                    createdAt: serverTimestamp(), backgroundColor: (currentImageBase64 || isPollMode) ? 'transparent' : currentPostColor, 
                    fontClass: POST_FONT_FAMILIES[currentPostFontIndex], likedBy: [], dislikedBy: [], imageBase64: currentImageBase64,
                    views: 0, viewedBy: [],
                    ...pollData
                });
                const uRef = doc(usersCollectionRef, currentUserId);
                const uDoc = await getDoc(uRef);
                updateDoc(uRef, { postsCount: (uDoc.data().postsCount||0)+1 });
                hideSecondaryView(postCreationView); showMessage("Publié !", true);
            } catch(e) { if(e.code === 'resource-exhausted') showMessage("Image trop lourde.", false); else showMessage("Erreur publication.", false); }
            publishButton.disabled = false;
        }
    </script>
</body>
</html>
