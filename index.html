<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="google-site-verification" content="lULIZecjpMCUjs1v3f7cUVpNzZf0cceze-bv5Zkq9Qs" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <!-- HTML2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@700&family=Pacifico&display=swap');

        :root {
            --primary-bg: #FAFAFA;
            --secondary-bg: #FFFFFF;
            --border-color: #DBDBDB;
            --text-color: #262626;
            --highlight-color: #3897f0;
            --last-seen-color: #8E8E8E;
            --button-border: #d4d4d4;
            --like-color: #3897f0;
            --dislike-color: #E74C3C;
            --action-color: #8e8e8e;
            --switch-off: #ccc;
            --switch-on: #5cb85c;
            --page-bg: #f0f2f5; 
            --google-btn: #4285F4;
            --apple-btn: #000000;
            --chat-bubble-sent: #3897f0;
            --chat-bubble-received: #EFEFEF;
            --badge-color: #ff3b30;
        }

        .font-inter { font-family: 'Inter', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; font-weight: 700; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .font-mono { font-family: 'Courier New', Courier, monospace; }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--page-bg); 
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- AUTH --- */
        #auth-view {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--primary-bg); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; overflow-y: auto;
        }
        .auth-card {
            background: var(--secondary-bg); padding: 30px 20px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center;
        }
        .app-logo { font-family: 'Pacifico', cursive; font-size: 48px; color: var(--text-color); margin-bottom: 30px; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--primary-bg); font-size: 14px; }
        .auth-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; font-size: 14px; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: opacity 0.2s; }
        .auth-btn:hover { opacity: 0.9; }
        .btn-primary { background-color: var(--highlight-color); color: white; }
        .btn-google { background-color: var(--google-btn); color: white; }
        .or-divider { display: flex; align-items: center; color: var(--last-seen-color); font-size: 12px; font-weight: 600; margin: 15px 0; }
        .or-divider::before, .or-divider::after { content: ""; flex: 1; border-bottom: 1px solid var(--border-color); }
        .or-divider::before { margin-right: 10px; } .or-divider::after { margin-left: 10px; }
        .auth-switch-text { margin-top: 20px; font-size: 14px; }
        .auth-switch-link { color: var(--highlight-color); font-weight: 600; cursor: pointer; }

        /* --- APP CONTAINER --- */
        #app-container {
            display: none; width: 100%; height: 100%; max-width: 480px; margin: 0 auto;
            background-color: var(--primary-bg); flex-direction: column; position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;
        }
        #view-wrapper { display: flex; flex: 1; width: 100%; height: 100%; transition: transform 0.3s ease-in-out; }
        .view { display: flex; flex-direction: column; background-color: var(--primary-bg); width: 100%; height: 100%; flex-shrink: 0; overflow: hidden; }
        .view.secondary { position: absolute; top: 0; left: 0; right: 0; bottom: 0; transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 20; visibility: hidden; }
        .view.secondary.visible { transform: translateX(0); visibility: visible; }

        /* --- HEADERS --- */
        .view-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color); min-height: 60px;
            flex-shrink: 0; z-index: 10; gap: 10px; 
        }
        .feed-view .view-header { flex-wrap: wrap; }
        #feed-search-bar {
            width: 100%; display: flex; align-items: center; background-color: var(--page-bg);
            border: 1px solid var(--border-color); border-radius: 8px; padding: 0 10px; order: 3; 
        }
        #feed-search-icon { color: var(--last-seen-color); font-size: 14px; }
        #feed-search-input { width: 100%; padding: 8px 5px; border: none; background: transparent; outline: none; font-size: 14px; }
        .header-title { font-size: 20px; font-weight: 600; margin: 0; text-align: center; flex-grow: 1; }
        .header-icon { font-size: 22px; cursor: pointer; color: var(--text-color); width: 40px; text-align: right; }
        .header-placeholder { width: 40px; } 
        .back-button { font-size: 20px; cursor: pointer; width: 40px; text-align: left; }

        /* --- SCROLL CONTENT --- */
        .feed-content, .contacts-content, .chat-content, .profile-content, #friend-requests-list {
            flex: 1 1 0; overflow-y: auto; padding-bottom: 140px;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .feed-content::-webkit-scrollbar, .contacts-content::-webkit-scrollbar, .chat-content::-webkit-scrollbar { display: none; }
        
        /* --- NAV BAR --- */
        .nav-bar {
            position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around;
            background-color: var(--secondary-bg); border-top: 1px solid var(--border-color);
            z-index: 15; padding-bottom: env(safe-area-inset-bottom); height: 60px;
        }
        .nav-item { padding: 10px 15px; font-size: 24px; color: var(--action-color); cursor: pointer; text-align: center; position: relative; transition: transform 0.2s; }
        .nav-item.active { color: var(--highlight-color); transform: scale(1.1); }
        .nav-item span { display: block; font-size: 10px; margin-top: 2px; }
        
        /* NAV BADGE (Le Rond Rouge) */
        .nav-badge {
            position: absolute; top: 5px; right: 10px;
            background-color: var(--badge-color); color: white;
            font-size: 10px; font-weight: bold;
            min-width: 18px; height: 18px; border-radius: 9px;
            display: flex; align-items: center; justify-content: center;
            padding: 0 4px; border: 2px solid var(--secondary-bg);
            display: none; /* Hidden by default */
        }

        /* --- FEED POSTS --- */
        .post-card { background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color); margin-bottom: 8px; }
        .post-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; font-size: 14px; }
        .post-publisher { font-weight: 600; cursor: pointer; }
        .post-countdown { font-size: 12px; color: var(--dislike-color); font-family: 'Roboto Mono', monospace; font-weight: 700; background-color: #fcebeb; padding: 2px 6px; border-radius: 4px; }
        .post-image-wrapper { width: 100%; padding-top: 100%; position: relative; background-size: cover; background-position: center; }
        .post-content-inner { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .post-message { font-size: 22px; text-align: center; white-space: pre-wrap; word-wrap: break-word; }
        .post-message.snap-text { display: inline; background-color: rgba(0, 0, 0, 0.5); color: white; padding: 2px 6px; border-radius: 4px; -webkit-box-decoration-break: clone; box-decoration-break: clone; text-shadow: none; }
        .post-actions { display: flex; padding: 8px 15px; gap: 20px; }
        .action-button { display: flex; align-items: center; gap: 8px; font-size: 18px; color: var(--action-color); cursor: pointer; }
        .action-button.liked i, .action-button.liked span { color: var(--like-color); }
        .action-button.disliked i, .action-button.disliked span { color: var(--dislike-color); }
        .action-button.share-btn { margin-left: auto; }

        /* --- CONTACTS & GROUPS VIEW --- */
        .contacts-view { position: relative; }
        .search-container { display: flex; padding: 10px; background-color: var(--primary-bg); gap: 10px; align-items: center; }
        .search-bar { flex-grow: 1; }
        #search-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--secondary-bg); font-size: 14px; }
        #create-group-btn { 
            font-size: 20px; color: var(--highlight-color); background: none; border: none; cursor: pointer; width: 40px;
        }
        
        .friend-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .friend-item:hover { background-color: #f9f9f9; }
        .friend-pp { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .group-pp { width: 50px; height: 50px; border-radius: 12px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: bold; }
        .friend-info { flex-grow: 1; min-width: 0; }
        .friend-info h4 { margin: 0 0 4px 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .friend-info p { margin: 0; font-size: 12px; color: var(--last-seen-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .chat-row-meta { display: flex; flex-direction: column; align-items: flex-end; min-width: 50px; }
        .last-msg-time { font-size: 10px; color: var(--last-seen-color); margin-bottom: 5px; }
        .unread-badge { 
            background-color: var(--badge-color); color: white; font-size: 10px; font-weight: bold;
            min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            padding: 0 5px; 
        }

        /* --- CHAT VIEW --- */
        .chat-view .view-header { gap: 10px; }
        #chat-header-info { flex-grow: 1; display: flex; align-items: center; gap: 10px; overflow: hidden; cursor: pointer; }
        #chat-user-pp { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        #chat-group-pp { width: 40px; height: 40px; border-radius: 10px; display: none; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
        #chat-username { font-size: 18px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .chat-content { background-color: #FFFFFF; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .message-container { display: flex; width: 100%; margin-bottom: 5px; }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .message-time { font-size: 10px; margin-top: 4px; display: block; opacity: 0.6; text-align: right; font-weight: 600; }
        .message-sender-name { font-size: 10px; font-weight: 700; color: var(--highlight-color); margin-bottom: 2px; display: block; }
        
        .message-container.sent { justify-content: flex-end; }
        .message-bubble.sent { background-color: var(--chat-bubble-sent); color: white; border-bottom-right-radius: 4px; }
        .message-container.received { justify-content: flex-start; }
        .message-bubble.received { background-color: var(--chat-bubble-received); color: black; border-bottom-left-radius: 4px; }
        
        .chat-sticker { width: 150px; height: 150px; object-fit: contain; display: block; margin: 5px 0; }
        .mention { color: var(--highlight-color); font-weight: bold; background: rgba(56, 151, 240, 0.1); padding: 0 4px; border-radius: 4px; }

        .chat-footer { display: flex; align-items: center; padding: 10px; background-color: var(--secondary-bg); border-top: 1px solid var(--border-color); gap: 10px; position: relative; }
        #chat-input-wrapper { flex-grow: 1; background-color: var(--primary-bg); border-radius: 24px; padding: 0 15px; border: 1px solid var(--border-color); display: flex; align-items: center; }
        #message-input { flex-grow: 1; border: none; background: transparent; padding: 12px 0; font-size: 15px; outline: none; }
        #send-button { width: 40px; height: 40px; border-radius: 50%; background-color: var(--highlight-color); border: none; font-size: 16px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Stickers Picker */
        #emoji-picker { position: absolute; bottom: 70px; left: 10px; background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); padding: 15px; display: none; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 320px; max-width: 90vw; z-index: 50; max-height: 250px; overflow-y: auto; }
        #emoji-picker.show { display: grid; }
        .picker-sticker { width: 60px; height: 60px; cursor: pointer; object-fit: contain; transition: transform 0.2s; }
        .picker-sticker:hover { transform: scale(1.1); }

        /* --- PROFIL & MISC --- */
        .profile-header { display: flex; align-items: center; padding: 15px; gap: 15px; background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color); }
        #profile-pic { width: 80px; height: 80px; border-radius: 50%; }
        .profile-info-main { flex-grow: 1; }
        #profile-username { font-size: 22px; font-weight: 600; margin: 0; }
        #edit-bio-btn { background: none; border: 1px solid var(--button-border); border-radius: 6px; padding: 6px 12px; margin-top: 10px; cursor: pointer; font-weight: 600; width: 100%; }
        #profile-actions { display: flex; gap: 10px; margin-top: 10px; }
        .profile-action-btn { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--button-border); border-radius: 6px; font-weight: 600; cursor: pointer; background: none; }
        .profile-action-btn.primary { background-color: var(--highlight-color); color: white; border-color: var(--highlight-color); }
        .profile-action-btn.danger { background-color: var(--dislike-color); color: white; border-color: var(--dislike-color); }
        .profile-stats { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .profile-details { padding: 15px; }
        #logout-btn { width: 100%; margin-top: 20px; padding: 12px; background-color: var(--primary-bg); color: var(--dislike-color); border: 1px solid var(--button-border); border-radius: 6px; font-weight: 600; cursor: pointer; display: none; }

        /* --- MODALES --- */
        .modal-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 150; display: none; align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: var(--secondary-bg); padding: 20px; border-radius: 12px; width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 15px; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { margin: 0 0 10px 0; text-align: center; }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
        .modal-actions button { flex-grow: 1; padding: 10px; border-radius: 6px; border: none; font-weight: 600; font-size: 16px; cursor: pointer; }
        .friend-option-button { display: flex; align-items: center; justify-content: space-between; gap: 15px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .friend-option-button:hover { background-color: #f9f9f9; }
        
        /* Selecteur d'amis pour groupe */
        .friend-selector-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .friend-selector-info { display: flex; align-items: center; gap: 10px; }
        .friend-selector-info img { width: 32px; height: 32px; border-radius: 50%; }
        
        /* --- POST CREATOR --- */
        #post-creation-view .view-header { justify-content: space-between; }
        .post-input-area { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background-color: var(--secondary-bg); }
        #square-content { width: 100%; padding-top: 100%; position: relative; background-color: #f1f1f1; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); cursor: text; background-size: cover; background-position: center; overflow: hidden; }
        #post-textarea { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-sizing: border-box; padding: 20px; background: transparent; border: none; resize: none; outline: none; text-align: center; font-size: 20px; line-height: 1.4; color: var(--text-color); display: flex; align-items: center; justify-content: center; font-family: inherit; font-weight: inherit; }
        #post-textarea.has-image { color: white; text-shadow: 0 1px 4px rgba(0,0,0,0.8); }
        .post-controls { padding: 15px 20px; background-color: var(--secondary-bg); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 15px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
        .color-swatch.selected { border-color: var(--highlight-color); box-shadow: 0 0 0 2px white; }
        
        /* Toast */
        #toast-message { position: absolute; bottom: 80px; left: 50%; transform: translate(-50%, 100%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 200; opacity: 0; transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; pointer-events: none; }
        #toast-message.show { transform: translate(-50%, 0); opacity: 1; }
        #toast-message.success { background-color: #28a745; }
        #toast-message.error { background-color: #dc3545; }

        /* --- Capture & Cropper --- */
        #share-capture-container { position: fixed; top: -9999px; left: -9999px; width: 400px; height: 400px; z-index: -1; }
        .capture-card { width: 100%; height: 100%; position: relative; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; background-size: cover; background-position: center; }
        #cropper-modal .modal-content { max-width: 90vw; width: 400px; align-items: center; }
        #cropper-canvas { max-width: 100%; border: 1px solid var(--border-color); background: #eee; touch-action: none; }

    </style>
</head>
<body>

    <!-- AUTH -->
    <div id="auth-view">
        <div class="auth-card">
            <h1 class="app-logo">Drop</h1>
            <div id="email-auth-form">
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-password" class="auth-input" placeholder="Mot de passe" required>
                <button id="login-btn" class="auth-btn btn-primary"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
                <div class="auth-switch-text"><span id="auth-toggle-text">Pas de compte ?</span><span id="auth-toggle-link" class="auth-switch-link">S'inscrire</span></div>
            </div>
            <div class="or-divider">OU</div>
            <button id="google-btn" class="auth-btn btn-google"><i class="fab fa-google"></i> Continuer avec Google</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-container" class="container">
        <div id="view-wrapper">
            <!-- Feed -->
            <div id="feed-view" class="view feed-view">
                <div class="view-header">
                    <div class="header-placeholder"></div> 
                    <h1 class="header-title">Flux</h1>
                    <i id="create-post-header-btn" class="fas fa-feather-alt header-icon"></i>
                    <div id="feed-search-bar"><i id="feed-search-icon" class="fas fa-search"></i><input type="text" id="feed-search-input" placeholder="Rechercher..."></div>
                </div>
                <div id="feed-content" class="feed-content"></div>
            </div>
            
            <!-- Discussions (Contacts/Groups) -->
            <div id="contacts-view" class="view contacts-view">
                <div class="view-header"><div class="header-placeholder"></div><h1 class="header-title">Discussions</h1><div class="header-placeholder"></div></div>
                <div class="search-container">
                    <div class="search-bar"><input type="text" id="search-input" placeholder="Rechercher..."></div>
                    <button id="create-group-btn"><i class="fas fa-users-cog"></i></button>
                </div>
                <div id="friends-list" class="contacts-content"></div>
                <button id="add-friend-fab"><i class="fas fa-user-plus"></i></button>
            </div>

            <!-- Profile -->
            <div id="profile-view" class="view profile-view">
                <div class="view-header"><i id="my-profile-nav-item" class="fas fa-users header-icon"></i><h1 id="profile-username-header" class="header-title">Profil</h1><div class="header-placeholder"></div></div>
                <div class="profile-content">
                    <div class="profile-header">
                        <img id="profile-pic" src="" alt="Avatar">
                        <div class="profile-info-main">
                            <h2 id="profile-username">User</h2>
                            <div id="profile-actions-container">
                                <button id="edit-bio-btn">Modifier</button>
                                <div id="profile-actions" style="display: none;">
                                    <button id="action-add-friend" class="profile-action-btn">Ajouter</button>
                                    <button id="action-block-user" class="profile-action-btn danger">Bloquer</button>
                                    <button id="action-message-user" class="profile-action-btn primary">Message</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-stats"><div class="stat-item"><h3 id="posts-count">0</h3><p>Posts</p></div><div class="stat-item"><h3 id="followers-count">0</h3><p>Amis</p></div></div>
                    <div class="profile-details"><h4>Bio</h4><p id="profile-bio">...</p><h4>Membre depuis</h4><p id="creation-date">...</p><button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Se déconnecter</button></div>
                </div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="view chat-view secondary">
            <div class="view-header chat-header">
                <i id="chat-back-btn" class="fas fa-arrow-left back-button"></i>
                <div id="chat-header-info">
                    <img id="chat-user-pp" src="">
                    <div id="chat-group-pp"></div>
                    <h1 id="chat-username" class="header-title">Chat</h1>
                </div>
                <div class="header-placeholder"></div>
            </div>
            <div id="chat-content-container" class="chat-content"><div id="chat-body"></div></div>
            <div class="chat-footer">
                <button id="emoji-btn"><i class="far fa-smile"></i></button><div id="emoji-picker"></div>
                <div id="chat-input-wrapper"><input type="text" id="message-input" placeholder="Votre message..."></div><button id="send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        
        <!-- Post Creator -->
        <div id="post-creation-view" class="view post-creation-view secondary">
            <div class="view-header"><i id="post-creation-back-btn" class="fas fa-arrow-left back-button"></i><h1 class="header-title">Nouveau</h1><button id="publish-button" disabled>Publier</button></div>
            <div class="post-input-area">
                <div id="square-content" class="font-inter"><textarea id="post-textarea" placeholder="Exprimez-vous..." maxlength="70"></textarea></div>
                <div class="char-limit-indicator"><span id="char-count">0</span> / 70</div>
            </div>
            <div class="post-controls">
                <div class="control-row">
                    <label>Image</label>
                    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                    <div style="display:flex; gap:10px;">
                        <button class="control-button" id="add-image-button"><i class="fas fa-camera"></i></button>
                        <button class="control-button" id="remove-image-button" style="display:none; color: var(--dislike-color);"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="control-row" id="bg-color-control-row"><label>Couleur</label><div class="color-swatches-container" id="post-color-swatches"></div></div>
                <div class="control-row"><label>Police</label><button class="control-button" id="font-style-button"><i class="fas fa-font"></i></button></div>
                <div class="control-row"><label>Anonyme</label><label class="switch"><input type="checkbox" id="anonymous-switch-input"><span class="slider"></span></label></div>
            </div>
        </div>

        <!-- Modals -->
        <div id="edit-profile-modal" class="modal-backdrop"><div class="modal-content"><h3>Modifier</h3><div><label>Nom</label><input type="text" id="edit-username-input" maxlength="20"></div><div><label>Bio</label><textarea id="edit-bio-textarea" maxlength="150"></textarea></div><div><label>Couleur</label><div id="edit-color-swatches"></div></div><div class="modal-actions"><button id="cancel-edit-btn">Annuler</button><button id="save-profile-btn">Enregistrer</button></div></div></div>
        
        <div id="friend-options-modal" class="modal-backdrop"><div class="modal-content"><h3>Options</h3><button id="show-friend-requests" class="friend-option-button"><span>Demandes</span><span id="pending-requests-count-badge" class="request-count-badge" style="display: none;">0</span></button><button id="enter-id-manually" class="friend-option-button"><span>Ajouter par ID</span></button><button id="share-profile-link" class="friend-option-button"><span>Inviter (Lien)</span></button><button id="show-my-qr" class="friend-option-button"><span>Mon QR Code</span></button><div class="modal-actions"><button id="cancel-friend-options-btn">Fermer</button></div></div></div>
        
        <!-- Group Creation Modal -->
        <div id="group-creation-modal" class="modal-backdrop">
            <div class="modal-content">
                <h3>Créer un groupe</h3>
                <input type="text" id="group-name-input" placeholder="Nom du groupe" maxlength="20">
                <input type="text" id="group-bio-input" placeholder="Description (optionnel)" maxlength="50">
                <div><label>Couleur</label><div id="group-color-swatches" style="display:flex;gap:5px;flex-wrap:wrap;justify-content:center;"></div></div>
                <h4>Ajouter des membres</h4>
                <div id="group-friend-selector" style="max-height: 200px; overflow-y: auto;"></div>
                <div class="modal-actions"><button id="cancel-group-creation">Annuler</button><button id="confirm-group-creation" style="background:var(--highlight-color);color:white;">Créer</button></div>
            </div>
        </div>

        <!-- Group Settings Modal -->
        <div id="group-settings-modal" class="modal-backdrop">
            <div class="modal-content">
                <h3>Paramètres du groupe</h3>
                <input type="text" id="edit-group-name" placeholder="Nom du groupe">
                <textarea id="edit-group-bio" placeholder="Bio du groupe"></textarea>
                <div id="group-admins-list"></div>
                <div id="group-members-list" style="max-height:150px; overflow-y:auto;"></div>
                <button id="add-member-link-btn" class="friend-option-button">Copier lien d'invitation</button>
                <div class="modal-actions"><button id="close-group-settings">Fermer</button><button id="save-group-settings" style="background:var(--highlight-color);color:white;">Sauver</button></div>
            </div>
        </div>

        <div id="qr-code-modal" class="modal-backdrop"><div class="modal-content"><h3>QR Code</h3><canvas id="qr-code-canvas"></canvas><p>ID: <strong id="qr-user-id"></strong></p><div class="modal-actions"><button id="close-qr-modal-btn">Fermer</button></div></div></div>
        <div id="paste-id-modal" class="modal-backdrop"><div class="modal-content"><h3>Ajouter par ID</h3><input type="text" id="paste-id-input" placeholder="ID..."><div class="modal-actions"><button id="cancel-paste-id-btn">Annuler</button><button id="send-friend-request-btn">Envoyer</button></div></div></div>
        <div id="friend-requests-modal" class="modal-backdrop"><div class="modal-content"><h3>Demandes</h3><div id="friend-requests-list"></div><div class="modal-actions"><button id="cancel-friend-requests-btn">Fermer</button></div></div></div>
        <div id="cropper-modal" class="modal-backdrop"><div class="modal-content"><h3>Cadrer</h3><div style="display:flex;justify-content:center;background:#000;"><canvas id="cropper-canvas" width="300" height="300"></canvas></div><input type="range" id="zoom-slider" min="1" max="3" step="0.1" value="1" style="width:100%;margin-top:10px;"><div class="modal-actions"><button id="cancel-crop-btn">Annuler</button><button id="confirm-crop-btn" style="background-color: var(--highlight-color); color: white;">Valider</button></div></div></div>

        <div id="toast-message">Message</div>
        <div id="share-capture-container"></div>
        
        <nav class="nav-bar">
            <div class="nav-item active" data-view="feed-view"><i class="fas fa-home"></i><span>Flux</span></div>
            <div class="nav-item" data-view="contacts-view">
                <i class="fas fa-users"></i><span>Amis</span>
                <div id="main-nav-badge" class="nav-badge">0</div>
            </div>
            <div class="nav-item" data-view="profile-view"><i class="fas fa-user"></i><span>Profil</span></div>
        </nav>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, arrayUnion, arrayRemove, writeBatch, serverTimestamp, addDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = '1:541715107757:web:0141b71ee3cd1ce5ec5b24';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyB_z5U4yKJERho93p9696NujcG5R5fvlD8", authDomain: "studio-3374032724-f28d6.firebaseapp.com", projectId: "studio-3374032724-f28d6", appId: appId };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const effectiveAppId = appId; 
        const dbPath = `artifacts/${effectiveAppId}/public/data`;
        const usersCollectionRef = collection(db, dbPath, 'users');
        const postsCollectionRef = collection(db, dbPath, 'posts');
        const groupsCollectionRef = collection(db, dbPath, 'groups');
        
        const PROFILE_COLORS = ['#e57373', '#81c784', '#64b5f6', '#f06292', '#ba68c8', '#ffd54f', '#7986cb', '#4db6ac', '#9575cd', '#4fc3f7', '#a1887f', '#90a4ae'];
        const POST_FONT_FAMILIES = ['font-inter', 'font-pacifico', 'font-mono', 'font-montserrat'];
        const STICKERS = ["mal_à_l'aise.gif", "amour.gif", "triste.gif", "colère.gif", "soulé.gif", "choqué.gif", "cligne.gif"];
        const POST_COLOR_PALETTE = ['#f1f1f1', '#D6E9F7', '#D1F7D1', '#FFF7D1', '#F7D1D1', '#A0D4FE', '#84E084', '#FEEA84', '#FE8484'];
        const MAX_CHARS = 70; const BASE_URL = 'https://drop-24.netlify.app/';

        let currentUserId = null;
        let activeProfileUserId = null;
        let usersData = {};
        let postsData = [];
        let filteredPostsData = []; 
        let pendingRequests = []; 
        let myFriends = []; // IDs
        let myGroups = []; // Objects
        let myPrivateChatsMeta = {}; // { chatId: { lastMessageTime, ... } }
        let myLastReads = {}; // { chatId: timestamp }
        
        let currentChatId = null;
        let currentChatType = 'private'; // 'private' or 'group'
        let currentChatTargetId = null; // friendId or groupId
        let unsubscribeChatListener = null;
        let unsubscribeUsersListener = null;
        let unsubscribeFeedListener = null;
        let unsubscribeFriendRequestsListener = null;
        let unsubscribeGroupsListener = null;
        let unsubscribeChatsMetaListeners = []; // Array of unsub functions
        let countdownInterval = null;
        let isLoginMode = true;

        // Image Vars
        let currentImageBase64 = null;
        let cropperImage = new Image();
        let cropperState = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };
        const CROP_SIZE = 800; 
        let cropperCtx = null;

        // --- AUTH ---
        const initAuth = async () => { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('auth-view').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Join group via link
                const urlParams = new URLSearchParams(window.location.search);
                const joinGroupId = urlParams.get('joinGroup');
                if(joinGroupId) joinGroupViaLink(joinGroupId);

                await upsertUserDocument(user);
                listenToAllUsers();
                listenToFeed();
                listenToFriendRequests();
                listenToMyGroups();
                navigateTo('feed-view');
            } else {
                currentUserId = null;
                document.getElementById('auth-view').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                // Cleanup
                if(unsubscribeUsersListener) unsubscribeUsersListener();
                if(unsubscribeFeedListener) unsubscribeFeedListener();
                if(unsubscribeGroupsListener) unsubscribeGroupsListener();
                unsubscribeChatsMetaListeners.forEach(u => u());
            }
        });

        // --- DATA LOGIC ---
        async function upsertUserDocument(user) {
            const ref = doc(usersCollectionRef, user.uid);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                await setDoc(ref, {
                    username: user.displayName || `user_${user.uid.substring(0, 4)}`, 
                    profileColor: PROFILE_COLORS[Math.floor(Math.random() * PROFILE_COLORS.length)],
                    accountCreatedAt: serverTimestamp(), friends: [], postsCount: 0, lastReads: {}
                });
            } else {
                myLastReads = snap.data().lastReads || {};
            }
            // Listen to my own doc for lastRead updates
            onSnapshot(ref, s => { 
                if(s.exists()) {
                    myLastReads = s.data().lastReads || {};
                    updateUnreadBadges();
                }
            });
        }

        function listenToAllUsers() {
            unsubscribeUsersListener = onSnapshot(usersCollectionRef, (snap) => {
                usersData = {}; snap.forEach((d) => { usersData[d.id] = { id: d.id, ...d.data() }; });
                // Update my friends list
                if(usersData[currentUserId]) {
                    const newFriends = usersData[currentUserId].friends || [];
                    if(JSON.stringify(newFriends) !== JSON.stringify(myFriends)) {
                        myFriends = newFriends;
                        listenToPrivateChatsMetadata(); // Re-bind listeners for new friends
                    }
                }
                renderDiscussionsList();
                if (activeProfileUserId && document.getElementById('profile-view').getBoundingClientRect().x === 0) showProfile(activeProfileUserId);
            });
        }

        function listenToMyGroups() {
            unsubscribeGroupsListener = onSnapshot(groupsCollectionRef, (snap) => {
                myGroups = [];
                snap.forEach(d => {
                    const g = { id: d.id, ...d.data() };
                    if((g.participants || []).includes(currentUserId)) myGroups.push(g);
                });
                renderDiscussionsList();
            });
        }

        // Listen to parent doc of chats to get lastMessageTime for sorting/unread
        function listenToPrivateChatsMetadata() {
            unsubscribeChatsMetaListeners.forEach(u => u());
            unsubscribeChatsMetaListeners = [];
            myPrivateChatsMeta = {};

            myFriends.forEach(fid => {
                const cid = getChatId(currentUserId, fid);
                const unsub = onSnapshot(doc(db, dbPath, 'chats', cid), (s) => {
                    if(s.exists()) {
                        myPrivateChatsMeta[cid] = s.data();
                        renderDiscussionsList();
                    }
                });
                unsubscribeChatsMetaListeners.push(unsub);
            });
        }

        // --- SORTING & UNREAD LOGIC ---
        function renderDiscussionsList() {
            const list = document.getElementById('friends-list'); list.innerHTML = '';
            const term = document.getElementById('search-input').value.toLowerCase();
            
            // Combine Groups & Private Chats
            let discussions = [];

            // 1. Private Chats
            myFriends.forEach(fid => {
                const u = usersData[fid];
                if(!u) return;
                const cid = getChatId(currentUserId, fid);
                const meta = myPrivateChatsMeta[cid] || {};
                // Filter by name
                if(term && !u.username.toLowerCase().includes(term)) return;
                
                discussions.push({
                    type: 'private',
                    id: fid, // Target ID
                    chatId: cid,
                    name: u.username,
                    avatar: generateAvatarUrl(u),
                    lastMsgTime: meta.lastMessageTime ? meta.lastMessageTime.toMillis() : 0,
                    lastMsgText: meta.lastMessageText || 'Pas de message',
                    obj: u
                });
            });

            // 2. Groups
            myGroups.forEach(g => {
                // Filter by name
                if(term && !g.name.toLowerCase().includes(term)) return;
                discussions.push({
                    type: 'group',
                    id: g.id,
                    chatId: g.id, // Group ID is Chat ID
                    name: g.name,
                    avatar: null, // Custom render for groups
                    iconColor: g.iconColor,
                    lastMsgTime: g.lastMessageTime ? g.lastMessageTime.toMillis() : 0,
                    lastMsgText: g.lastMessageText || 'Nouveau groupe',
                    obj: g
                });
            });

            // Sort by Recency
            discussions.sort((a, b) => b.lastMsgTime - a.lastMsgTime);

            // Render
            discussions.forEach(d => {
                const lastRead = myLastReads[d.chatId] ? myLastReads[d.chatId].toMillis() : 0;
                const isUnread = d.lastMsgTime > lastRead;
                // Calcul unread count (approximatif: 1 si unread) ou on stocke le vrai count ?
                // Pour simplifier on met une pastille "1+" si unread.
                // Si on veut un vrai count il faut le stocker dans chats/{chatId}/unreadCounts/{userId}
                
                const div = document.createElement('div');
                div.className = 'friend-item';
                
                let imgHtml = '';
                if(d.type === 'private') {
                    imgHtml = `<img class="friend-pp" src="${d.avatar}">`;
                } else {
                    imgHtml = `<div class="group-pp" style="background-color:${d.iconColor}">${d.name.substring(0,2).toUpperCase()}</div>`;
                }

                div.innerHTML = `
                    ${imgHtml}
                    <div class="friend-info">
                        <h4>${d.name}</h4>
                        <p style="font-weight:${isUnread?'bold':'normal'};color:${isUnread?'black':'var(--last-seen-color)'}">
                            ${d.type==='group'?'<i class="fas fa-users" style="font-size:10px;margin-right:4px;"></i>':''}
                            ${d.lastMsgText}
                        </p>
                    </div>
                    <div class="chat-row-meta">
                        <span class="last-msg-time">${d.lastMsgTime > 0 ? new Date(d.lastMsgTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                        ${isUnread ? '<div class="unread-badge">1</div>' : ''}
                    </div>
                `;
                div.onclick = () => {
                    if(d.type === 'private') showChat(d.id);
                    else showGroupChat(d.id);
                };
                list.appendChild(div);
            });
            
            updateUnreadBadges(discussions);
        }

        function updateUnreadBadges(discussionsList) {
            // Recalculate global unread
            if(!discussionsList) {
                // If not provided, fetch basic list again (simplified)
                // Actually we just rely on the next render loop or existing data
                return; 
            }
            let totalUnread = 0;
            discussionsList.forEach(d => {
                const lastRead = myLastReads[d.chatId] ? myLastReads[d.chatId].toMillis() : 0;
                if(d.lastMsgTime > lastRead) totalUnread++;
            });
            
            const badge = document.getElementById('main-nav-badge');
            if(totalUnread > 0) {
                badge.style.display = 'flex';
                badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
            } else {
                badge.style.display = 'none';
            }
        }

        // --- GROUP LOGIC ---
        document.getElementById('create-group-btn').onclick = () => {
            // Populate friend selector
            const list = document.getElementById('group-friend-selector');
            list.innerHTML = '';
            myFriends.forEach(fid => {
                const u = usersData[fid];
                const div = document.createElement('div'); div.className = 'friend-selector-item';
                div.innerHTML = `
                    <div class="friend-selector-info"><img src="${generateAvatarUrl(u)}"><span>${u.username}</span></div>
                    <input type="checkbox" value="${fid}" class="group-friend-cb">
                `;
                list.appendChild(div);
            });
            
            // Color swatches for group
            const cDiv = document.getElementById('group-color-swatches'); cDiv.innerHTML='';
            PROFILE_COLORS.forEach(c => {
                const s = document.createElement('div'); s.className='color-swatch'; s.style.backgroundColor=c; s.dataset.color=c;
                s.onclick = () => { cDiv.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected')); s.classList.add('selected'); };
                cDiv.appendChild(s);
            });
            
            showModal(document.getElementById('group-creation-modal'));
        };
        
        document.getElementById('cancel-group-creation').onclick = () => hideModal(document.getElementById('group-creation-modal'));
        
        document.getElementById('confirm-group-creation').onclick = async () => {
            const name = document.getElementById('group-name-input').value.trim();
            const bio = document.getElementById('group-bio-input').value.trim();
            const color = document.querySelector('#group-color-swatches .selected')?.dataset.color || PROFILE_COLORS[0];
            const checkboxes = document.querySelectorAll('.group-friend-cb:checked');
            const selectedFriends = Array.from(checkboxes).map(cb => cb.value);
            
            if(!name) return showMessage("Nom requis", false);
            
            const participants = [currentUserId, ...selectedFriends];
            
            try {
                await addDoc(groupsCollectionRef, {
                    name: name,
                    bio: bio,
                    iconColor: color,
                    participants: participants,
                    admins: [currentUserId],
                    createdAt: serverTimestamp(),
                    lastMessageTime: serverTimestamp(),
                    lastMessageText: "Groupe créé"
                });
                showMessage("Groupe créé !", true);
                hideModal(document.getElementById('group-creation-modal'));
            } catch(e) { showMessage("Erreur création", false); }
        };

        // --- CHAT LOGIC (Unified) ---
        function getChatId(u1, u2) { return [u1, u2].sort().join('_'); }
        
        async function showChat(fid) {
            currentChatType = 'private';
            currentChatTargetId = fid;
            currentChatId = getChatId(currentUserId, fid);
            
            const u = usersData[fid];
            document.getElementById('chat-username').textContent = u ? u.username : '...';
            document.getElementById('chat-user-pp').src = generateAvatarUrl(u);
            document.getElementById('chat-user-pp').style.display='block';
            document.getElementById('chat-group-pp').style.display='none';
            document.getElementById('chat-header-info').onclick = () => showProfile(fid);
            
            startChatListener(currentChatId);
        }

        async function showGroupChat(gid) {
            currentChatType = 'group';
            currentChatTargetId = gid;
            currentChatId = gid;
            
            const g = myGroups.find(gr => gr.id === gid);
            if(!g) return;
            
            document.getElementById('chat-username').textContent = g.name;
            const pp = document.getElementById('chat-group-pp');
            pp.style.display='flex';
            pp.style.backgroundColor = g.iconColor;
            pp.textContent = g.name.substring(0,2).toUpperCase();
            document.getElementById('chat-user-pp').style.display='none';
            
            // Settings click
            document.getElementById('chat-header-info').onclick = () => openGroupSettings(g);
            
            startChatListener(gid);
        }

        function startChatListener(cid) {
            document.getElementById('chat-body').innerHTML = '';
            showSecondaryView(document.getElementById('chat-view'));
            
            // Mark as read immediately
            markAsRead(cid);

            if(unsubscribeChatListener) unsubscribeChatListener();
            
            // Query depends on type? No, we use 'chats' collection for Private and 'groups' for Group messages?
            // WAIT: To simplify, I put group messages in `groups/{gid}/messages` and private in `chats/{cid}/messages`.
            let collRef;
            if(currentChatType === 'group') collRef = collection(db, dbPath, 'groups', cid, 'messages');
            else collRef = collection(db, dbPath, 'chats', cid, 'messages');

            unsubscribeChatListener = onSnapshot(query(collRef, orderBy('createdAt', 'asc')), snap => {
                document.getElementById('chat-body').innerHTML = '';
                snap.forEach(d => renderMessage(d.data()));
                document.getElementById('chat-content-container').scrollTop = document.getElementById('chat-content-container').scrollHeight;
                
                // Update read status if new message comes while looking
                markAsRead(cid);
            });
        }

        async function markAsRead(cid) {
            // Update local user doc
            const ref = doc(usersCollectionRef, currentUserId);
            await updateDoc(ref, { [`lastReads.${cid}`]: serverTimestamp() });
        }

        async function sendMessage(text) {
            if(!text) return;
            
            const isGroup = currentChatType === 'group';
            const collPath = isGroup ? ['groups', currentChatId, 'messages'] : ['chats', currentChatId, 'messages'];
            const metaDocRef = isGroup ? doc(db, dbPath, 'groups', currentChatId) : doc(db, dbPath, 'chats', currentChatId);
            
            // Handle Mentions (Simple color coding in display, stored as plain text)
            // Enhanced: Detect @User
            
            const msgData = {
                text: text,
                senderId: currentUserId,
                createdAt: serverTimestamp()
            };
            
            const batch = writeBatch(db);
            batch.set(doc(collection(db, dbPath, ...collPath)), msgData);
            
            // Update Metadata for Sorting & Snippet
            // For Private Chat, we must ensure parent doc exists
            const lastMsgTxt = text.startsWith('[sticker:') ? 'Sticker' : text;
            batch.set(metaDocRef, {
                lastMessageTime: serverTimestamp(),
                lastMessageText: (isGroup ? `${usersData[currentUserId].username}: ` : '') + lastMsgTxt
            }, { merge: true });
            
            await batch.commit();
        }

        function renderMessage(m) {
            const div = document.createElement('div');
            const isMe = m.senderId === currentUserId;
            const time = m.createdAt ? new Date(m.createdAt.toMillis()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            
            let content = m.text;
            
            // Sticker
            if(content.startsWith('[sticker:') && content.endsWith(']')) {
                const fname = content.substring(9, content.length-1);
                content = `<img src="${fname}" class="chat-sticker">`;
            } else {
                // Mention Highlight
                content = content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
            }

            const senderName = (currentChatType === 'group' && !isMe) ? `<span class="message-sender-name">${usersData[m.senderId]?.username||'Inconnu'}</span>` : '';

            div.className = `message-container ${isMe?'sent':'received'}`;
            div.innerHTML = `<div class="message-bubble ${isMe?'sent':'received'}" style="${m.text.startsWith('[')?'background:transparent;box-shadow:none;padding:0;':''}">${senderName}${content}<span class="message-time" style="${m.text.startsWith('[')?'color:black':''}">${time}</span></div>`;
            document.getElementById('chat-body').appendChild(div);
        }

        // --- GROUP ADMIN & SETTINGS ---
        function openGroupSettings(g) {
            document.getElementById('edit-group-name').value = g.name;
            document.getElementById('edit-group-bio').value = g.bio || '';
            
            const isAdmin = (g.admins || []).includes(currentUserId);
            
            // List Members
            const list = document.getElementById('group-members-list'); list.innerHTML='';
            g.participants.forEach(pid => {
                const u = usersData[pid];
                const row = document.createElement('div'); row.className='friend-selector-item';
                const isUserAdmin = (g.admins||[]).includes(pid);
                row.innerHTML = `
                    <div class="friend-selector-info">
                        <img src="${generateAvatarUrl(u)}">
                        <span>${u?.username} ${isUserAdmin?'(Admin)':''}</span>
                    </div>
                    ${isAdmin && pid !== currentUserId ? `<button onclick="removeMember('${g.id}', '${pid}')" style="color:red;border:none;background:none;"><i class="fas fa-trash"></i></button>` : ''}
                `;
                list.appendChild(row);
            });
            
            // Invitation Link
            document.getElementById('add-member-link-btn').onclick = () => {
                const link = `${BASE_URL}?joinGroup=${g.id}`;
                navigator.clipboard.writeText(link).then(() => showMessage("Lien copié !", true));
            };
            
            // Save logic
            document.getElementById('save-group-settings').onclick = async () => {
                if(!isAdmin) return showMessage("Seul un admin peut modifier", false);
                await updateDoc(doc(groupsCollectionRef, g.id), {
                    name: document.getElementById('edit-group-name').value,
                    bio: document.getElementById('edit-group-bio').value
                });
                hideModal(document.getElementById('group-settings-modal'));
            };
            
            showModal(document.getElementById('group-settings-modal'));
        }
        
        window.removeMember = async (gid, uid) => {
            if(!confirm("Retirer ce membre ?")) return;
            await updateDoc(doc(groupsCollectionRef, gid), {
                participants: arrayRemove(uid),
                admins: arrayRemove(uid)
            });
            // Close modal to refresh or keep open and refresh? Simple: close.
            hideModal(document.getElementById('group-settings-modal'));
        };

        async function joinGroupViaLink(gid) {
            // Check if group exists
            try {
                const gRef = doc(groupsCollectionRef, gid);
                const gSnap = await getDoc(gRef);
                if(gSnap.exists()) {
                    await updateDoc(gRef, { participants: arrayUnion(currentUserId) });
                    showMessage("Groupe rejoint !", true);
                    // Clean URL
                    window.history.replaceState({}, document.title, "/");
                }
            } catch(e) { console.error(e); }
        }

        // --- GLOBAL HANDLERS ---
        document.getElementById('send-button').onclick = () => {
            const i = document.getElementById('message-input');
            sendMessage(i.value.trim());
            i.value = '';
        };
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') document.getElementById('send-button').click();
        });
        document.getElementById('emoji-btn').onclick = () => {
            const p = document.getElementById('emoji-picker');
            if(p.style.display==='grid') { p.style.display='none'; } else {
                p.innerHTML=''; STICKERS.forEach(s=>{
                    const img=document.createElement('img'); img.src=s; img.className='picker-sticker';
                    img.onclick=()=>{sendMessage(`[sticker:${s}]`); p.style.display='none';}; p.appendChild(img);
                }); p.style.display='grid';
            }
        };
        
        // Navigation
        function navigateTo(viewId) {
            const viewIndex = ['feed-view', 'contacts-view', 'profile-view'].indexOf(viewId);
            document.getElementById('view-wrapper').style.transform = `translateX(-${viewIndex * 100}%)`;
            navItems.forEach(item => { item.classList.toggle('active', item.dataset.view === viewId); });
            if (viewId === 'profile-view' && !activeProfileUserId) showProfile(currentUserId);
        }
        navItems.forEach(item => item.onclick = () => {
            if(item.dataset.view === 'profile-view') { activeProfileUserId = null; showProfile(currentUserId); }
            else navigateTo(item.dataset.view);
        });
        
        // Helper
        function generateAvatarUrl(user) {
            if (!user) return '';
            return `https://ui-avatars.com/api/?name=${user.username}&background=${(user.profileColor||'888').replace('#','')}&color=fff&size=128&bold=true`;
        }
        function showMessage(msg, s) {
            const t = document.getElementById('toast-message'); t.textContent=msg; t.className=`show ${s?'success':'error'}`;
            setTimeout(()=>t.className='', 3000);
        }
        function showModal(el) { el.style.display='flex'; }
        function hideModal(el) { el.style.display='none'; }
        function showSecondaryView(el) { el.classList.add('visible'); }
        function hideSecondaryView(el) { el.classList.remove('visible'); }

        // --- INIT FEED / SEARCH ---
        document.getElementById('feed-search-input').addEventListener('input', renderFeed);
        document.getElementById('search-input').addEventListener('input', renderDiscussionsList);
        
        // Feed Logic reused from prev (Simplified for length)
        function listenToFeed() {
            unsubscribeFeedListener = onSnapshot(query(postsCollectionRef), (snap) => {
                const now = new Date(); postsData = [];
                snap.forEach(d => {
                    const p = { id: d.id, ...d.data() };
                    const date = p.createdAt?.toDate ? p.createdAt.toDate() : new Date();
                    if (now.getTime() - date.getTime() > 86400000) { if (p.publisherId === currentUserId) deleteDoc(doc(postsCollectionRef, p.id)); } 
                    else { p.expiresAt = new Date(date.getTime() + 86400000); postsData.push(p); }
                });
                postsData.sort((a, b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                renderFeed();
            });
        }
        function renderFeed() {
            const term = document.getElementById('feed-search-input').value.toLowerCase();
            filteredPostsData = term ? postsData.filter(p => {
                const uName = (usersData[p.publisherId]?.username||'').toLowerCase();
                return p.message.toLowerCase().includes(term) || uName.includes(term);
            }) : postsData;
            
            const c = document.getElementById('feed-content');
            if(!filteredPostsData.length) { c.innerHTML="<p style='text-align:center;padding:20px;color:grey;'>Rien.</p>"; return; }
            c.innerHTML = filteredPostsData.map(p => {
                const u = usersData[p.publisherId] || {username:'Inconnu'};
                const rem = p.expiresAt - new Date();
                let bg = `background-color:${p.backgroundColor}`;
                let cls = p.fontClass;
                if(p.imageBase64) { bg=`background-image:url('${p.imageBase64}')`; cls+=" snap-text"; }
                return `<div class="post-card">
                    <div class="post-header"><span class="post-publisher" onclick="showProfile('${p.publisherId}')">${p.isAnon?'Anonyme':u.username}</span><span class="post-countdown">${formatCountdown(rem)}</span></div>
                    <div class="post-image-wrapper" style="${bg}"><div class="post-content-inner"><p class="post-message ${cls}">${p.message}</p></div></div>
                    <div class="post-actions">
                        <div class="action-button" onclick="likePost('${p.id}')"><i class="fas fa-thumbs-up" style="color:${(p.likedBy||[]).includes(currentUserId)?'var(--highlight-color)':''}"></i><span>${(p.likedBy||[]).length}</span></div>
                    </div>
                </div>`;
            }).join('');
        }
        function formatCountdown(ms) { const s=Math.floor(ms/1000); return `${Math.floor(s/3600)}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}`; }
        window.likePost = async (pid) => { const r=doc(postsCollectionRef,pid); const p=postsData.find(x=>x.id===pid); if(!p)return; const has=(p.likedBy||[]).includes(currentUserId); await updateDoc(r,{likedBy:has?arrayRemove(currentUserId):arrayUnion(currentUserId)}); };
        window.showProfile = showProfile;

        // --- CROPPER, IMAGE, PROFILE EDIT, QR, ETC... KEEPING AS IS ---
        document.addEventListener('DOMContentLoaded', () => {
            cropperCtx = document.getElementById('cropper-canvas').getContext('2d');
            document.getElementById('create-post-header-btn').onclick = () => showSecondaryView(document.getElementById('post-creation-view'));
            document.getElementById('post-creation-back-btn').onclick = () => hideSecondaryView(document.getElementById('post-creation-view'));
            document.getElementById('publish-button').onclick = handlePublish;
            
            document.getElementById('add-image-button').onclick = () => document.getElementById('image-upload-input').click();
            document.getElementById('image-upload-input').onchange = e => {
                if(e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = evt => { cropperImage.src = evt.target.result; cropperImage.onload = () => { initCropper(); showModal(document.getElementById('cropper-modal')); }};
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            document.getElementById('confirm-crop-btn').onclick = () => {
                const cvs = document.createElement('canvas'); cvs.width=CROP_SIZE; cvs.height=CROP_SIZE;
                const ctx = cvs.getContext('2d'); ctx.fillStyle="#000"; ctx.fillRect(0,0,CROP_SIZE,CROP_SIZE);
                const ratio = CROP_SIZE/300; const scale = parseFloat(document.getElementById('zoom-slider').value)*ratio;
                const dx = (CROP_SIZE/2)-(cropperImage.width*scale/2)+(cropperState.x*ratio);
                const dy = (CROP_SIZE/2)-(cropperImage.height*scale/2)+(cropperState.y*ratio);
                ctx.drawImage(cropperImage, dx, dy, cropperImage.width*scale, cropperImage.height*scale);
                currentImageBase64 = cvs.toDataURL('image/jpeg', 0.92);
                document.getElementById('square-content').style.backgroundImage = `url('${currentImageBase64}')`;
                hideModal(document.getElementById('cropper-modal'));
            };
            document.getElementById('zoom-slider').oninput = drawCropper;
            document.getElementById('close-group-settings').onclick = () => hideModal(document.getElementById('group-settings-modal'));
            document.getElementById('chat-back-btn').onclick = () => hideSecondaryView(document.getElementById('chat-view'));
            
            // Cropper drag
            const cvs = document.getElementById('cropper-canvas');
            const start = (x,y)=>{cropperState.isDragging=true;cropperState.startX=x;cropperState.startY=y;};
            const move = (x,y)=>{if(cropperState.isDragging){cropperState.x+=x-cropperState.startX;cropperState.y+=y-cropperState.startY;cropperState.startX=x;cropperState.startY=y;drawCropper();}};
            cvs.onmousedown=e=>start(e.clientX,e.clientY); window.onmousemove=e=>move(e.clientX,e.clientY); window.onmouseup=()=>cropperState.isDragging=false;
            cvs.ontouchstart=e=>start(e.touches[0].clientX,e.touches[0].clientY); window.ontouchmove=e=>move(e.touches[0].clientX,e.touches[0].clientY); window.ontouchend=()=>cropperState.isDragging=false;
        });

        function initCropper() { cropperState={scale:1,x:0,y:0,isDragging:false,startX:0,startY:0}; document.getElementById('zoom-slider').value=1; drawCropper(); }
        function drawCropper() {
            cropperCtx.fillStyle="#000"; cropperCtx.fillRect(0,0,300,300);
            const scale = parseFloat(document.getElementById('zoom-slider').value);
            const dx = 150-(cropperImage.width*scale/2)+cropperState.x; const dy = 150-(cropperImage.height*scale/2)+cropperState.y;
            cropperCtx.drawImage(cropperImage, dx, dy, cropperImage.width*scale, cropperImage.height*scale);
        }
        async function handlePublish() {
            const txt = document.getElementById('post-textarea').value.trim();
            if(!txt && !currentImageBase64) return;
            const isAnon = document.getElementById('anonymous-switch-input').checked;
            await addDoc(postsCollectionRef, {
                message: txt, publisherId: isAnon ? null : currentUserId, isAnon: isAnon,
                createdAt: serverTimestamp(), backgroundColor: currentImageBase64 ? 'transparent' : '#f1f1f1',
                likedBy: [], imageBase64: currentImageBase64
            });
            hideSecondaryView(document.getElementById('post-creation-view'));
            currentImageBase64=null; document.getElementById('post-textarea').value='';
        }

    </script>
</body>
</html>
