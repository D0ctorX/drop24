<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <!-- HTML2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@700&family=Pacifico&display=swap');

        :root {
            --primary-bg: #FAFAFA;
            --secondary-bg: #FFFFFF;
            --border-color: #DBDBDB;
            --text-color: #262626;
            --highlight-color: #3897f0;
            --last-seen-color: #8E8E8E;
            --button-border: #d4d4d4;
            --like-color: #3897f0;
            --dislike-color: #E74C3C;
            --action-color: #8e8e8e;
            --switch-off: #ccc;
            --switch-on: #5cb85c;
            --page-bg: #f0f2f5; 
            --google-btn: #4285F4;
            --apple-btn: #000000;
        }

        .font-inter { font-family: 'Inter', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .font-pacifico { font-family: 'Pacifico', cursive; }

        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--page-bg); 
            color: var(--text-color);
            overflow: hidden;
        }

        /* --- VUE AUTHENTIFICATION --- */
        #auth-view {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--primary-bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .auth-card {
            background: var(--secondary-bg);
            padding: 30px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        .app-logo {
            font-family: 'Pacifico', cursive;
            font-size: 48px;
            color: var(--text-color);
            margin-bottom: 30px;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--primary-bg);
            font-size: 14px;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: opacity 0.2s;
        }
        .auth-btn:hover { opacity: 0.9; }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background-color: var(--highlight-color); color: white; }
        .btn-google { background-color: var(--google-btn); color: white; }
        
        .or-divider {
            display: flex;
            align-items: center;
            color: var(--last-seen-color);
            font-size: 12px;
            font-weight: 600;
            margin: 15px 0;
        }
        .or-divider::before, .or-divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        .or-divider::before { margin-right: 10px; }
        .or-divider::after { margin-left: 10px; }

        .auth-switch-text {
            margin-top: 20px;
            font-size: 14px;
        }
        .auth-switch-link {
            color: var(--highlight-color);
            font-weight: 600;
            cursor: pointer;
        }

        /* --- APPLICATION PRINCIPALE --- */
        #app-container {
            display: none; 
            width: 100%;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            background-color: var(--primary-bg);
            flex-direction: column;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        #view-wrapper {
            display: flex;
            flex: 1;
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease-in-out;
        }
        
        .view {
            display: flex;
            flex-direction: column;
            background-color: var(--primary-bg);
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            overflow: hidden;
        }

        .view.secondary {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 20;
            visibility: hidden;
        }
        
        .view.secondary.visible {
            transform: translateX(0);
            visibility: visible;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            min-height: 60px;
            flex-shrink: 0;
            z-index: 10;
            gap: 10px; 
        }
        
        .feed-view .view-header {
            flex-wrap: wrap;
        }
        #feed-search-bar {
            width: 100%;
            display: flex;
            align-items: center;
            background-color: var(--page-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0 10px;
            order: 3; 
        }
        #feed-search-icon {
            color: var(--last-seen-color);
            font-size: 14px;
        }
        #feed-search-input {
            width: 100%;
            padding: 8px 5px;
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
        }

        .header-title { font-size: 20px; font-weight: 600; margin: 0; text-align: center; flex-grow: 1; }
        .header-icon { font-size: 22px; cursor: pointer; color: var(--text-color); width: 40px; text-align: right; }
        .header-placeholder { width: 40px; } 
        .back-button { font-size: 20px; cursor: pointer; width: 40px; text-align: left; }

        /* Scroll Fix */
        .feed-content, .contacts-content, .chat-content, .profile-content, #friend-requests-list {
            flex: 1 1 0;
            overflow-y: auto;
            padding-bottom: 80px;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .feed-content::-webkit-scrollbar, .contacts-content::-webkit-scrollbar, 
        .chat-content::-webkit-scrollbar, .profile-content::-webkit-scrollbar,
        #friend-requests-list::-webkit-scrollbar {
            display: none;
        }
        
        #friend-requests-list {
            max-height: 300px; 
            flex: initial; 
        }

        /* --- Barre de Navigation --- */
        .nav-bar {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            display: flex;
            justify-content: space-around;
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            z-index: 15;
            padding-bottom: env(safe-area-inset-bottom);
            height: 60px;
        }
        .nav-item { padding: 10px 15px; font-size: 24px; color: var(--action-color); cursor: pointer; text-align: center; transition: color 0.2s, transform 0.2s; }
        .nav-item.active { color: var(--highlight-color); transform: scale(1.1); }
        .nav-item span { display: block; font-size: 10px; margin-top: 2px; }

        /* --- Feed --- */
        .feed-content { padding: 0; }
        .post-card { background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color); margin-bottom: 8px; }
        .post-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; font-size: 14px; }
        .post-publisher { font-weight: 600; cursor: pointer; }
        .post-countdown { 
            font-size: 12px; 
            color: var(--dislike-color);
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            background-color: #fcebeb;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .post-image-wrapper { width: 100%; padding-top: 100%; position: relative; }
        .post-content-inner { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .post-message { font-size: 22px; text-align: center; white-space: pre-wrap; word-wrap: break-word; }
        .post-actions { display: flex; padding: 8px 15px; gap: 20px; }
        .action-button { display: flex; align-items: center; gap: 8px; font-size: 18px; color: var(--action-color); cursor: pointer; }
        .action-button span { font-size: 14px; font-weight: 600; }
        .action-button.liked i, .action-button.liked span { color: var(--like-color); }
        .action-button.disliked i, .action-button.disliked span { color: var(--dislike-color); }
        .action-button.share-btn { margin-left: auto; } 

        /* --- Amis --- */
        .contacts-view { position: relative; } 
        .search-bar { padding: 10px; background-color: var(--primary-bg); flex-shrink: 0; }
        #search-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--secondary-bg); font-size: 14px; }
        .friend-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .friend-item:hover { background-color: #f9f9f9; }
        .friend-pp { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; }
        .friend-info { flex-grow: 1; }
        .friend-info h4 { margin: 0 0 4px 0; font-size: 16px; }
        .friend-info p { margin: 0; font-size: 12px; color: var(--last-seen-color); }
        .dm-button { background-color: var(--highlight-color); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        /* FAB */
        #add-friend-fab {
            position: absolute;
            bottom: calc(80px + env(safe-area-inset-bottom));
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: var(--highlight-color);
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 100;
        }
        .request-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--dislike-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid var(--secondary-bg);
            z-index: 101;
        }
        .request-count-badge {
            background-color: var(--dislike-color);
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }
        
        /* --- Chat Styles (Nouveau Design) --- */
        .chat-view .view-header { gap: 10px; }
        
        /* Header Chat Personnalis√© */
        .friend-info-header {
            display: flex;
            align-items: center;
            flex-grow: 1;
            cursor: pointer;
        }
        .friend-info-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .friend-info-header span {
            font-size: 18px;
            font-weight: 600;
        }

        .chat-content { 
            background-color: #f0f2f5; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; /* Espace pour input */
        }
        
        #chat-body { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }

        /* Messages Bulles */
        .message {
            display: flex;
            margin-bottom: 5px;
            max-width: 85%;
            flex-direction: column;
        }
        .message.sent { align-self: flex-end; }
        .message.received { align-self: flex-start; }

        .message-row {
            display: flex;
            align-items: flex-end;
        }
        .sent .message-row { justify-content: flex-end; }

        .message-content {
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }
        .sent .message-content {
            background-color: var(--highlight-color);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .received .message-content {
            background-color: var(--secondary-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 10px;
            color: var(--last-seen-color);
            margin: 2px 5px;
            align-self: flex-end;
        }
        .sent .message-time { align-self: flex-end; text-align: right; }
        .received .message-time { align-self: flex-start; }

        /* Zone de saisie chat */
        .chat-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            gap: 10px;
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            z-index: 10;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .chat-input-container input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            min-width: 0;
            background-color: var(--primary-bg);
        }
        .chat-input-container .action-icon {
            font-size: 24px;
            color: var(--last-seen-color);
            cursor: pointer;
        }
        .send-button {
            background-color: var(--highlight-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        /* Emoji Popup */
        .emoji-popup {
            position: absolute;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 15;
            flex-direction: column;
            display: none;
            max-height: 300px;
            overflow: hidden;
        }
        .emoji-popup.active { display: flex; }
        .emoji-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        #emoji-back-button {
            background: none; border: none; font-size: 20px; cursor: pointer; margin-right: 10px;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 5px;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .emoji-item {
            font-size: 30px; text-align: center; cursor: pointer; transition: transform 0.2s;
        }
        .emoji-item:hover { transform: scale(1.2); }
        
        
        /* --- Profil --- */
        .profile-header { display: flex; align-items: center; padding: 15px; gap: 15px; background-color: var(--secondary-bg); border-bottom: 1px solid var(--border-color); }
        #profile-pic { width: 80px; height: 80px; border-radius: 50%; }
        .profile-info-main { flex-grow: 1; }
        #profile-username { font-size: 22px; font-weight: 600; margin: 0; }
        #edit-bio-btn { background: none; border: 1px solid var(--button-border); border-radius: 6px; padding: 6px 12px; margin-top: 10px; cursor: pointer; font-weight: 600; width: 100%; }
        #profile-actions { display: flex; gap: 10px; margin-top: 10px; }
        
        /* NOUVEAU STYLE POUR LES BOUTONS D'ACTION PROFIL */
        .profile-action-btn {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid var(--button-border);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            background: none;
        }
        .profile-action-btn.primary {
            background-color: var(--highlight-color);
            color: white;
            border-color: var(--highlight-color);
        }
        .profile-action-btn.danger {
            background-color: var(--dislike-color);
            color: white;
            border-color: var(--dislike-color);
        }

        .profile-stats { display: flex; justify-content: space-around; text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .stat-item h3 { margin: 0; font-size: 18px; }
        .stat-item p { margin: 2px 0 0; font-size: 12px; color: var(--last-seen-color); }
        .profile-details { padding: 15px; }
        .profile-details h4 { margin: 0 0 5px 0; font-size: 16px; }
        .profile-details p { margin: 0 0 15px 0; line-height: 1.5; }

        /* NOUVEAU: Bouton de d√©connexion */
        #logout-btn {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            background-color: var(--primary-bg);
            color: var(--dislike-color);
            border: 1px solid var(--button-border);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- Toast --- */
        #toast-message { position: absolute; bottom: 80px; left: 50%; transform: translate(-50%, 100%); background-color: rgba(0, 0, 0, 0.75); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 200; opacity: 0; transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; pointer-events: none; }
        #toast-message.show { transform: translate(-50%, 0); opacity: 1; }
        #toast-message.success { background-color: #28a745; }
        #toast-message.error { background-color: #dc3545; }
        
        /* --- Modales --- */
        .modal-backdrop {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 150;
            display: none; /* Cach√© par d√©faut */
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        .modal-content {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .modal-content h3 { margin: 0 0 10px 0; text-align: center; }
        .modal-content label { font-size: 14px; font-weight: 600; }
        .modal-content input, .modal-content textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        .modal-content textarea { resize: vertical; min-height: 60px; }
        #edit-color-swatches { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .edit-color-swatch {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .edit-color-swatch.selected { border-color: var(--highlight-color); }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
        .modal-actions button {
            flex-grow: 1; padding: 10px; border-radius: 6px; border: none;
            font-weight: 600; font-size: 16px; cursor: pointer;
        }
        #save-profile-btn { background-color: var(--highlight-color); color: white; }
        #cancel-edit-btn, #cancel-friend-options-btn, #cancel-friend-requests-btn, #cancel-paste-id-btn, #cancel-scan-btn { 
            background-color: #f0f0f0; color: var(--text-color); 
        }

        /* Modale d'options d'amis */
        #friend-options-modal .modal-content {
            gap: 10px;
        }
        .friend-option-button {
            display: flex;
            align-items: center;
            justify-content: space-between; 
            gap: 15px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .friend-option-button:hover {
            background-color: #f9f9f9;
        }
        .friend-option-button i {
            width: 20px;
            text-align: center;
            color: var(--action-color);
        }
        .friend-option-button-text {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Modale QR Code */
        #qr-code-modal .modal-content {
            align-items: center;
            gap: 20px;
        }
        #qr-code-canvas {
            border: 5px solid var(--secondary-bg);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* NOUVEAU: Scanner QR */
        #scanner-modal .modal-content {
            padding: 0;
            overflow: hidden;
            background-color: black;
            justify-content: center;
        }
        #reader {
            width: 100%;
            height: 300px;
            background-color: black;
        }
        
        /* NOUVEAU: Modale des demandes d'amis */
        #friend-requests-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        .friend-request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .friend-request-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .friend-request-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .friend-request-info span {
            font-weight: 600;
        }
        .friend-request-actions {
            display: flex;
            gap: 8px;
        }
        .friend-request-actions button {
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 16px;
            cursor: pointer;
        }
        .request-accept-btn {
            background-color: var(--switch-on);
            color: white;
        }
        .request-reject-btn {
            background-color: var(--dislike-color);
            color: white;
        }


        /* --- Styles Cr√©ation de post --- */
        #post-creation-view .view-header { justify-content: space-between; }
        #publish-button {
            font-size: 16px; font-weight: 600; color: var(--highlight-color);
            background: none; border: none; cursor: pointer;
        }
        #publish-button:disabled { color: var(--last-seen-color); cursor: not-allowed; }
        .post-input-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: hidden;
            background-color: var(--secondary-bg);
        }
        #square-content {
            width: 100%;
            padding-top: 100%; /* Ratio 1:1 */
            position: relative;
            background-color: #f1f1f1;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease-in-out;
            cursor: text;
        }
        #post-textarea {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            box-sizing: border-box; padding: 20px;
            background: transparent; border: none;
            resize: none; outline: none;
            text-align: center;
            font-size: 20px; line-height: 1.4;
            color: var(--text-color);
            display: flex; align-items: center; justify-content: center;
        }
        .char-limit-indicator {
            margin-top: 10px;
            font-size: 12px;
            color: var(--last-seen-color);
            text-align: right;
            width: 100%;
        }
        .char-limit-indicator.error { color: var(--dislike-color); font-weight: 600; }
        .post-controls {
            padding: 15px 20px;
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .control-row label { font-size: 14px; font-weight: 600; }
        .color-swatches-container { display: flex; gap: 8px; }
        .color-swatch {
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .color-swatch.selected { border-color: var(--highlight-color); box-shadow: 0 0 0 2px white; }
        .control-button {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 1px solid var(--button-border);
            background-color: var(--primary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px; height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--switch-off);
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--switch-on); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Styles pour la capture d'image (cach√©) */
        #share-capture-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 400px;
            height: 400px;
            z-index: -1;
        }
        .capture-card {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        .capture-publisher {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: 700;
            font-size: 24px;
            color: rgba(0,0,0,0.5);
            z-index: 10;
        }
        .capture-watermark {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 12px;
            font-weight: 600;
            color: rgba(0,0,0,0.3);
            font-family: 'Pacifico', cursive;
        }

    </style>
</head>
<body>

    <!-- VUE D'AUTHENTIFICATION (Premier √©cran) -->
    <div id="auth-view">
        <div class="auth-card">
            <h1 class="app-logo">Drop</h1>
            
            <!-- Formulaire Login/Signup -->
            <div id="email-auth-form">
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-password" class="auth-input" placeholder="Mot de passe" required>
                
                <button id="login-btn" class="auth-btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>
                
                <div class="auth-switch-text">
                    <span id="auth-toggle-text">Pas de compte ?</span>
                    <span id="auth-toggle-link" class="auth-switch-link">S'inscrire</span>
                </div>
            </div>

            <div class="or-divider">OU</div>

            <!-- Boutons Sociaux -->
            <button id="google-btn" class="auth-btn btn-google">
                <i class="fab fa-google"></i> Continuer avec Google
            </button>
        </div>
    </div>

    <!-- APPLICATION PRINCIPALE (Cach√©e par d√©faut) -->
    <div id="app-container" class="container">
        <div id="view-wrapper">
            <!-- VUE FEED -->
            <div id="feed-view" class="view feed-view">
                <div class="view-header">
                    <div class="header-placeholder"></div> 
                    <h1 class="header-title">Flux</h1>
                    <i id="create-post-header-btn" class="fas fa-feather-alt header-icon"></i>
                    <div id="feed-search-bar">
                        <i id="feed-search-icon" class="fas fa-search"></i>
                        <input type="text" id="feed-search-input" placeholder="Rechercher des posts...">
                    </div>
                </div>
                <div id="feed-content" class="feed-content"></div>
            </div>
            
            <!-- VUE AMIS -->
            <div id="contacts-view" class="view contacts-view">
                <div class="view-header">
                    <div class="header-placeholder"></div>
                    <h1 class="header-title">Amis</h1>
                    <div class="header-placeholder"></div>
                </div>
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="Rechercher un ami...">
                </div>
                <div id="friends-list" class="contacts-content"></div>
                <!-- Bouton FAB -->
                <button id="add-friend-fab">
                    <i class="fas fa-user-plus"></i>
                </button>
            </div>

            <!-- VUE PROFIL -->
            <div id="profile-view" class="view profile-view">
                <div class="view-header">
                     <i id="my-profile-nav-item" class="fas fa-users header-icon"></i>
                    <h1 id="profile-username-header" class="header-title">Profil</h1>
                    <div class="header-placeholder"></div>
                </div>
                <div class="profile-content">
                    <div class="profile-header">
                        <img id="profile-pic" src="" alt="Avatar">
                        <div class="profile-info-main">
                            <h2 id="profile-username">Nom d'utilisateur</h2>
                            <div id="profile-actions-container">
                                <button id="edit-bio-btn">Modifier le profil</button>
                                
                                <!-- NOUVEAUX BOUTONS D'ACTIONS -->
                                <div id="profile-actions" style="display: none;">
                                    <button id="action-add-friend" class="profile-action-btn">Ajouter</button>
                                    <button id="action-block-user" class="profile-action-btn danger">Bloquer</button>
                                    <button id="action-message-user" class="profile-action-btn primary">Message</button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <h3 id="posts-count">0</h3>
                            <p>Posts</p>
                        </div>
                        <div class="stat-item">
                            <h3 id="followers-count">0</h3>
                            <p>Amis</p>
                        </div>
                    </div>
                    <div class="profile-details">
                        <h4>Bio</h4>
                        <p id="profile-bio">Ceci est ma bio.</p>
                        <h4>Membre depuis</h4>
                        <p id="creation-date">1 janvier 2025</p>
                        
                        <!-- Bouton D√©connexion -->
                        <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Se d√©connecter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VUES SECONDAIRES (Chat, Cr√©ation Post...) -->
        <!-- NOUVEAU DESIGN CHAT -->
        <div id="chat-view" class="view chat-view secondary">
            <div class="view-header chat-header">
                <i id="chat-back-btn" class="fas fa-arrow-left back-button"></i>
                <div class="friend-info-header" id="chat-friend-info">
                    <img id="chat-user-pp" src="" alt="Avatar">
                    <span id="chat-username" class="friend-name">Chat</span>
                </div>
                <div class="header-placeholder"></div>
            </div>
            
            <div class="chat-content">
                <div id="chat-body"></div>
            </div>

            <!-- Emoji Popup (Copie exacte de la maquette) -->
            <div id="emoji-popup" class="emoji-popup">
                <header class="emoji-header">
                    <button id="emoji-back-button"><i class="fas fa-arrow-down"></i></button>
                    <h2 style="flex-grow: 1; text-align: center; margin: 0; font-size: 16px;">S√©lectionner un √©moji</h2>
                </header>
                <div class="emoji-grid" id="emoji-grid"></div>
            </div>

            <div class="chat-input-container">
                <i class="fas fa-smile action-icon" id="emoji-btn-trigger"></i>
                <input type="text" id="message-input" placeholder="Envoyer un message...">
                <button id="send-button" class="send-button"><i class="fas fa-arrow-up"></i></button>
            </div>
        </div>
        
        <div id="post-creation-view" class="view post-creation-view secondary">
            <div class="view-header">
                <i id="post-creation-back-btn" class="fas fa-arrow-left back-button"></i>
                <h1 class="header-title">Nouveau Post</h1>
                <button id="publish-button" disabled>Publier</button>
            </div>
            <div class="post-input-area">
                <div id="square-content">
                    <textarea id="post-textarea" placeholder="Exprimez-vous..." maxlength="200"></textarea>
                </div>
                <div class="char-limit-indicator">
                    <span id="char-count">0</span> / 200
                </div>
            </div>
            <div class="post-controls">
                <div class="control-row">
                    <label>Couleur de fond</label>
                    <div class="color-swatches-container" id="post-color-swatches"></div>
                </div>
                <div class="control-row">
                    <label>Style de police</label>
                    <button class="control-button" id="font-style-button">
                        <i class="fas fa-font"></i>
                    </button>
                </div>
                <div class="control-row">
                    <label>Publier en anonyme</label>
                    <label class="switch">
                        <input type="checkbox" id="anonymous-switch-input">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div id="toast-message">Message</div>
        <div id="share-capture-container"></div>
        
        <nav class="nav-bar">
            <div class="nav-item active" data-view="feed-view"><i class="fas fa-home"></i><span>Flux</span></div>
            <div class="nav-item" data-view="contacts-view"><i class="fas fa-users"></i><span>Amis</span></div>
            <div class="nav-item" data-view="profile-view"><i class="fas fa-user"></i><span>Profil</span></div>
        </nav>
    </div>

    <!-- Modales (Profil, Amis, QR...) -->
    <div id="edit-profile-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Modifier le profil</h3>
            <div><label>Nom d'utilisateur</label><input type="text" id="edit-username-input" maxlength="20"></div>
            <div><label>Bio</label><textarea id="edit-bio-textarea" maxlength="150"></textarea></div>
            <div><label>Couleur du profil</label><div id="edit-color-swatches"></div></div>
            <div class="modal-actions"><button id="cancel-edit-btn">Annuler</button><button id="save-profile-btn">Enregistrer</button></div>
        </div>
    </div>
    
    <div id="friend-options-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Options d'amis</h3>
            <button id="show-friend-requests" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-bell"></i><span>Demandes d'amis</span></div><span id="pending-requests-count-badge" class="request-count-badge" style="display: none;">0</span></button>
            <button id="enter-id-manually" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-id-card"></i><span>Ajouter par ID</span></div></button>
            <button id="share-profile-link" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-share-alt"></i><span>Inviter un ami (Lien)</span></div></button>
            <button id="show-my-qr" class="friend-option-button"><div class="friend-option-button-text"><i class="fas fa-qrcode"></i><span>Mon QR Code</span></div></button>
            <div class="modal-actions"><button id="cancel-friend-options-btn">Annuler</button></div>
        </div>
    </div>
    
    <div id="qr-code-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Mon QR Code Drop</h3><canvas id="qr-code-canvas"></canvas>
            <p style="font-size: 14px; text-align: center; color: var(--last-seen-color);">Partagez ce code ou votre ID : <strong id="qr-user-id" style="color: var(--text-color);"></strong></p>
            <div class="modal-actions"><button id="close-qr-modal-btn" style="background-color: var(--highlight-color); color: white;">Fermer</button></div>
        </div>
    </div>
    
    <div id="paste-id-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Ajouter un ami par ID</h3>
            <p style="font-size: 14px; color: var(--last-seen-color); text-align: center;">Collez l'ID de l'utilisateur.</p>
            <div><label>ID de l'utilisateur</label><input type="text" id="paste-id-input" placeholder="Coller l'ID ici..."></div>
            <div class="modal-actions"><button id="cancel-paste-id-btn">Annuler</button><button id="send-friend-request-btn" style="background-color: var(--highlight-color); color: white;">Envoyer</button></div>
        </div>
    </div>
    
    <div id="friend-requests-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3>Demandes d'amis</h3>
            <div id="friend-requests-list"></div>
            <div class="modal-actions"><button id="cancel-friend-requests-btn">Fermer</button></div>
        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, orderBy, arrayUnion, arrayRemove, writeBatch, serverTimestamp, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURATION FIREBASE (Remise en place pour votre site) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_z5U4yKJERho93p9696NujcG5R5fvlD8",
            authDomain: "studio-3374032724-f28d6.firebaseapp.com",
            projectId: "studio-3374032724-f28d6",
            storageBucket: "studio-3374032724-f28d6.appspot.com",
            messagingSenderId: "541715107757",
            appId: "1:541715107757:web:0141b71ee3cd1ce5ec5b24"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Utilisation de l'ID de l'app directement depuis la config
        const dbPath = `artifacts/${firebaseConfig.appId}/public/data`;
        const usersCollectionRef = collection(db, dbPath, 'users');
        const postsCollectionRef = collection(db, dbPath, 'posts');
        
        // --- CONSTANTES & ETAT ---
        const PROFILE_COLORS = ['#e57373', '#81c784', '#64b5f6', '#f06292', '#ba68c8', '#ffd54f', '#7986cb', '#4db6ac', '#9575cd', '#4fc3f7', '#a1887f', '#90a4ae'];
        const POST_FONT_FAMILIES = ['font-inter', 'font-roboto', 'font-montserrat', 'font-pacifico'];
        const POST_COLOR_PALETTE = ['#f1f1f1', '#D6E9F7', '#D1F7D1', '#FFF7D1', '#F7D1D1', '#A0D4FE', '#84E084', '#FEEA84', '#FE8484'];
        const MAX_CHARS = 200;
        const BASE_URL = 'https://drop-24.netlify.app/';
        const EMOJIS = ['üòä', 'üòÇ', 'üòç', 'ü§©', 'üëç', 'üôè', '‚ù§Ô∏è', 'üî•', 'üéâ', 'üí°', 'üëã', 'üöÄ', 'üåà', 'üíØ', 'ü§î', 'üòé', 'ü•≥', 'ü§Ø', 'üò≠', 'üòú', 'ü§£', 'üòÅ', 'ü§ó', 'üòâ', 'ü•∞', 'üòò', 'üòã', 'ü§´', 'üò∂', 'üò¥'];

        let currentUserId = null;
        let activeProfileUserId = null;
        let currentChatId = null; // ID de la conversation active
        let unsubscribeChat = null; // Listener pour le chat actif
        
        let usersData = {};
        let postsData = [];
        let filteredPostsData = []; 
        let pendingRequests = []; 
        
        let unsubscribeUsersListener = null;
        let unsubscribeFeedListener = null;
        let unsubscribeFriendRequestsListener = null;
        let countdownInterval = null;
        
        // Etat UI Auth
        let isLoginMode = true;

        // --- DOM REFERENCES ---
        const authView = document.getElementById('auth-view');
        const appContainer = document.getElementById('app-container');
        
        // Auth Elements
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginBtn = document.getElementById('login-btn');
        const googleBtn = document.getElementById('google-btn');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const logoutBtn = document.getElementById('logout-btn');

        // App Elements
        const viewWrapper = document.getElementById('view-wrapper');
        const friendsList = document.getElementById('friends-list');
        const navItems = document.querySelectorAll('.nav-item');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const feedContent = document.getElementById('feed-content');
        const friendSearchInput = document.getElementById('search-input'); 
        const feedSearchInput = document.getElementById('feed-search-input'); 

        // Refs Modales
        const addFriendFab = document.getElementById('add-friend-fab');
        const friendOptionsModal = document.getElementById('friend-options-modal');
        const qrCodeModal = document.getElementById('qr-code-modal');
        const pasteIdModal = document.getElementById('paste-id-modal'); 
        const friendRequestsModal = document.getElementById('friend-requests-modal'); 
        const friendRequestsList = document.getElementById('friend-requests-list'); 
        const captureContainer = document.getElementById('share-capture-container');
        
        // Refs Post
        const postCreationView = document.getElementById('post-creation-view');
        const postTextarea = document.getElementById('post-textarea');
        const charCountSpan = document.getElementById('char-count');
        const publishButton = document.getElementById('publish-button');
        const postColorSwatches = document.getElementById('post-color-swatches');
        const fontStyleButton = document.getElementById('font-style-button');
        const squareContent = document.getElementById('square-content');
        const anonymousSwitch = document.getElementById('anonymous-switch-input');
        let currentPostFontIndex = 0;
        let currentPostColor = POST_COLOR_PALETTE[0];
        let isAnonymousPost = false;

        // Refs Chat
        const chatView = document.getElementById('chat-view');
        const chatBody = document.getElementById('chat-body');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emojiPopup = document.getElementById('emoji-popup');
        const emojiGrid = document.getElementById('emoji-grid');
        const emojiBtnTrigger = document.getElementById('emoji-btn-trigger');
        const emojiBackButton = document.getElementById('emoji-back-button');

        // --- UTILS ---
        let toastTimeout;
        function showMessage(message, isSuccess) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.className = 'show';
            toast.classList.add(isSuccess ? 'success' : 'error');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }
        function showModal(el) { el.style.display = 'flex'; }
        function hideModal(el) { el.style.display = 'none'; }
        function showSecondaryView(el) { el.classList.add('visible'); }
        function hideSecondaryView(el) { el.classList.remove('visible'); }

        // --- AUTHENTIFICATION ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User connected:", user.uid);
                currentUserId = user.uid;
                authView.style.display = 'none';
                appContainer.style.display = 'flex'; // Afficher l'app
                
                await upsertUserDocument(user);
                listenToAllUsers();
                listenToFeed();
                listenToFriendRequests();
                navigateTo('feed-view');
                
                // --- AUTO ADD FRIEND VIA URL ---
                const urlParams = new URLSearchParams(window.location.search);
                const targetUid = urlParams.get('uid');
                if(targetUid && targetUid !== currentUserId) {
                    setTimeout(() => {
                        window.history.replaceState({}, document.title, window.location.pathname);
                        if(confirm("Voulez-vous envoyer une demande d'ami √† cet utilisateur ?")) {
                            sendFriendRequest(targetUid);
                        }
                    }, 2000);
                }

            } else {
                console.log("No user connected");
                currentUserId = null;
                authView.style.display = 'flex';
                appContainer.style.display = 'none'; // Cacher l'app
                
                if(unsubscribeUsersListener) unsubscribeUsersListener();
                if(unsubscribeFeedListener) unsubscribeFeedListener();
                if(unsubscribeFriendRequestsListener) unsubscribeFriendRequestsListener();
            }
        });

        // Toggle Login/Signup
        authToggleLink.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Se connecter';
                authToggleText.textContent = "Pas de compte ?";
                authToggleLink.textContent = "S'inscrire";
            } else {
                loginBtn.innerHTML = '<i class="fas fa-user-plus"></i> Cr√©er un compte';
                authToggleText.textContent = "D√©j√† un compte ?";
                authToggleLink.textContent = "Se connecter";
            }
        });

        // Email Auth
        loginBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if(!email || !password) {
                showMessage("Veuillez remplir tous les champs", false);
                return;
            }
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Compte cr√©√© !", true);
                }
            } catch (error) {
                console.error(error);
                showMessage("Erreur d'authentification", false);
            }
        });

        // Google Auth
        googleBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                 if (error.code === 'auth/unauthorized-domain') {
                    showMessage("Erreur de domaine (voir console)", false);
                } else {
                    showMessage("Erreur Google: " + error.message, false);
                }
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("D√©connect√©", true);
            } catch (error) {
                console.error(error);
            }
        });

        // --- DATA & LOGIC ---
        
        async function upsertUserDocument(user) {
            const userRef = doc(usersCollectionRef, user.uid);
            const userDoc = await getDoc(userRef);
            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    username: user.displayName || `user_${user.uid.substring(0, 6)}`, 
                    bio: 'Bienvenue sur mon profil !',
                    profileColor: PROFILE_COLORS[Math.floor(Math.random() * PROFILE_COLORS.length)],
                    accountCreatedAt: serverTimestamp(),
                    friends: [],
                    postsCount: 0
                });
            }
        }
        
        function navigateTo(viewId) {
            const viewIndex = ['feed-view', 'contacts-view', 'profile-view'].indexOf(viewId);
            if (viewIndex === -1) return;
            viewWrapper.style.transform = `translateX(-${viewIndex * 100}%)`;
            navItems.forEach(item => { item.classList.toggle('active', item.dataset.view === viewId); });
            if (viewId === 'profile-view' && !activeProfileUserId) {
                showProfile(currentUserId);
            }
        }
        
        function generateAvatarUrl(user) {
            if (!user || !user.username) return 'https://ui-avatars.com/api/?name=?&background=8E8E8E&color=fff&size=128&bold=true';
            const name = user.username.charAt(0).toUpperCase();
            const color = (user.profileColor || '8E8E8E').replace('#', '');
            return `https://ui-avatars.com/api/?name=${name}&background=${color}&color=fff&size=128&bold=true`;
        }

        function listenToAllUsers() {
            if (unsubscribeUsersListener) unsubscribeUsersListener();
            unsubscribeUsersListener = onSnapshot(usersCollectionRef, (snapshot) => {
                usersData = {};
                snapshot.forEach((doc) => {
                    usersData[doc.id] = { id: doc.id, ...doc.data() };
                });
                renderFriendsList(); 
                if (document.getElementById('profile-view').getBoundingClientRect().x === 0 && activeProfileUserId) {
                    showProfile(activeProfileUserId); 
                }
                if(document.getElementById('friend-requests-modal').style.display === 'flex') renderFriendRequestsList();
            });
        }
        
        function listenToFriendRequests() {
            if (unsubscribeFriendRequestsListener) unsubscribeFriendRequestsListener();
            if (!currentUserId) return;
            const requestsRef = collection(db, dbPath, 'users', currentUserId, 'friendRequests');
            unsubscribeFriendRequestsListener = onSnapshot(requestsRef, (snapshot) => {
                pendingRequests = [];
                snapshot.forEach(doc => { pendingRequests.push({ id: doc.id, ...doc.data() }); });
                updateFriendRequestBadge(pendingRequests.length);
                if(document.getElementById('friend-requests-modal').style.display === 'flex') renderFriendRequestsList();
            });
        }

        function updateFriendRequestBadge(count) {
            const fabBadge = document.querySelector('#add-friend-fab .request-badge');
            const modalBadge = document.getElementById('pending-requests-count-badge');
            if (count > 0) {
                if (!fabBadge) {
                    const newBadge = document.createElement('div');
                    newBadge.className = 'request-badge';
                    newBadge.textContent = count;
                    addFriendFab.appendChild(newBadge);
                } else { fabBadge.textContent = count; }
                modalBadge.textContent = count;
                modalBadge.style.display = 'inline-block';
            } else {
                if (fabBadge) fabBadge.remove();
                modalBadge.style.display = 'none';
            }
        }
        
        function renderFriendRequestsList() {
            friendRequestsList.innerHTML = '';
            if (pendingRequests.length === 0) {
                friendRequestsList.innerHTML = '<p style="text-align: center; color: var(--last-seen-color); padding: 20px 0;">Aucune demande en attente.</p>';
                return;
            }
            pendingRequests.forEach(req => {
                const sender = usersData[req.senderId];
                const senderName = sender ? sender.username : 'Chargement...';
                const senderAvatar = sender ? generateAvatarUrl(sender) : '';
                const item = document.createElement('div');
                item.className = 'friend-request-item';
                item.innerHTML = `<div class="friend-request-info"><img src="${senderAvatar}"><span>${senderName}</span></div><div class="friend-request-actions"><button class="request-accept-btn" data-sender-id="${req.senderId}"><i class="fas fa-check"></i></button><button class="request-reject-btn" data-sender-id="${req.senderId}"><i class="fas fa-times"></i></button></div>`;
                friendRequestsList.appendChild(item);
            });
        }
        
        async function sendFriendRequest(recipientId) {
            if (!recipientId || recipientId === currentUserId) return showMessage("Impossible de s'ajouter soi-m√™me.", false);
            if (usersData[currentUserId]?.friends?.includes(recipientId)) return showMessage("D√©j√† amis.", false);
            try {
                const requestRef = doc(db, dbPath, 'users', recipientId, 'friendRequests', currentUserId);
                const requestDoc = await getDoc(requestRef);
                if (requestDoc.exists()) return showMessage("Demande d√©j√† envoy√©e.", false);
                await setDoc(requestRef, { senderId: currentUserId, timestamp: serverTimestamp(), status: 'pending' });
                showMessage("Demande envoy√©e !", true);
            } catch (error) { console.error(error); showMessage("Erreur envoi.", false); }
        }
        
        async function acceptFriendRequest(senderId) {
            if (!currentUserId || !senderId) return;
            
            const batch = writeBatch(db);
            const currentUserRef = doc(usersCollectionRef, currentUserId);
            batch.update(currentUserRef, { friends: arrayUnion(senderId) });
            const requestRef = doc(db, dbPath, 'users', currentUserId, 'friendRequests', senderId);
            batch.delete(requestRef);
            const senderUserRef = doc(usersCollectionRef, senderId);
            batch.update(senderUserRef, { friends: arrayUnion(currentUserId) });

            try { 
                await batch.commit(); 
                showMessage("Ami ajout√© !", true); 
            } catch (error) { 
                console.error("Erreur acceptation (Probablement permissions Firestore):", error);
                if (error.code === 'permission-denied') {
                    console.warn("Tentative de fallback : mise √† jour locale uniquement.");
                    try {
                        const batch2 = writeBatch(db);
                        batch2.update(currentUserRef, { friends: arrayUnion(senderId) });
                        batch2.delete(requestRef);
                        await batch2.commit();
                        showMessage("Ami ajout√© (V√©rifiez les r√®gles pour la r√©ciprocit√©) !", true);
                        alert("Note: L'ami a √©t√© ajout√© de votre c√¥t√©, mais vos r√®gles de s√©curit√© emp√™chent de vous ajouter automatiquement √† sa liste.");
                    } catch (err2) {
                        showMessage("Erreur critique d'ajout.", false);
                    }
                } else {
                    showMessage("Erreur acceptation.", false); 
                }
            }
        }
        
        async function rejectFriendRequest(senderId) {
            try {
                const requestRef = doc(db, dbPath, 'users', currentUserId, 'friendRequests', senderId);
                await deleteDoc(requestRef);
                showMessage("Rejet√©e.", true);
            } catch (error) { console.error(error); showMessage("Erreur rejet.", false); }
        }

        function renderFriendsList() {
            const searchTerm = friendSearchInput.value.toLowerCase();
            friendsList.innerHTML = '';
            const currentUser = usersData[currentUserId];
            if (!currentUser) return;
            const friends = (currentUser.friends || []).map(id => usersData[id]).filter(Boolean); 
            const filtered = friends.filter(u => u.username.toLowerCase().includes(searchTerm));
            filtered.forEach(u => {
                const d = document.createElement('div'); d.className = 'friend-item';
                d.innerHTML = `<img class="friend-pp" src="${generateAvatarUrl(u)}"><div class="friend-info"><h4>${u.username}</h4><p>${u.bio || '...'}</p></div><button class="dm-button" data-user-id="${u.id}">Message</button>`;
                d.addEventListener('click', e => { if(e.target.classList.contains('dm-button')) showChat(u.id); else showProfile(u.id); });
                friendsList.appendChild(d);
            });
        }
        
        async function toggleFriendship(userIdToAdd) {
            if (!currentUserId || !userIdToAdd) return;
            const isFriend = usersData[currentUserId]?.friends?.includes(userIdToAdd);
            if (!isFriend) return showMessage("Envoyez une demande.", false);
            
            if(confirm("Voulez-vous vraiment retirer cet ami ?")) {
                const batch = writeBatch(db);
                batch.update(doc(usersCollectionRef, currentUserId), { friends: arrayRemove(userIdToAdd) });
                batch.update(doc(usersCollectionRef, userIdToAdd), { friends: arrayRemove(currentUserId) });
                try { await batch.commit(); showMessage("Ami retir√©.", true); } catch(e) { console.error(e); showMessage("Erreur.", false); }
            }
        }
        
        function showProfile(userId) {
            const user = usersData[userId];
            if (!user) return;
            activeProfileUserId = userId;
            document.getElementById('profile-pic').src = generateAvatarUrl(user);
            document.getElementById('profile-username').textContent = user.username;
            document.getElementById('profile-username-header').textContent = user.username;
            document.getElementById('profile-bio').textContent = user.bio || "Pas de bio.";
            document.getElementById('followers-count').textContent = user.friends?.length || 0;
            document.getElementById('posts-count').textContent = user.postsCount || 0;
            document.getElementById('creation-date').textContent = user.accountCreatedAt?.toDate ? user.accountCreatedAt.toDate().toLocaleDateString('fr-FR') : '...';
            
            const isMyProfile = userId === currentUserId;
            document.getElementById('edit-bio-btn').style.display = isMyProfile ? 'block' : 'none';
            logoutBtn.style.display = isMyProfile ? 'block' : 'none';
            document.getElementById('profile-actions').style.display = isMyProfile ? 'none' : 'flex';
            
            if (!isMyProfile) {
                const isFriend = usersData[currentUserId]?.friends?.includes(userId);
                
                const addBtn = document.getElementById('action-add-friend');
                const blockBtn = document.getElementById('action-block-user');
                const messageBtn = document.getElementById('action-message-user');
                
                if (isFriend) {
                    addBtn.style.display = 'none';
                    blockBtn.style.display = 'block';
                    messageBtn.style.display = 'block';
                    
                    blockBtn.onclick = () => toggleFriendship(userId);
                    messageBtn.onclick = () => showChat(userId);
                } else {
                    addBtn.style.display = 'block';
                    blockBtn.style.display = 'none';
                    messageBtn.style.display = 'none';
                    
                    addBtn.onclick = () => sendFriendRequest(userId);
                }
            }
            navigateTo('profile-view');
        }

        // --- LOGIQUE DU CHAT (NOUVEAU) ---
        function showChat(friendId) {
            const friend = usersData[friendId];
            if (!friend) return;

            // Mise √† jour UI Header
            document.getElementById('chat-user-pp').src = generateAvatarUrl(friend);
            document.getElementById('chat-username').textContent = friend.username;
            document.getElementById('chat-friend-info').onclick = () => showProfile(friendId); // Lien vers profil

            // G√©n√©rer un ID de chat unique (les 2 UIDs tri√©s par ordre alphab√©tique)
            const participants = [currentUserId, friendId].sort();
            currentChatId = participants.join('_');

            // Nettoyer l'ancien listener si on change de chat
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }

            // Vider l'√©cran de chat
            chatBody.innerHTML = '';

            // √âcouter les messages en temps r√©el
            const messagesRef = collection(db, dbPath, 'chats', currentChatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));

            unsubscribeChat = onSnapshot(q, (snapshot) => {
                chatBody.innerHTML = ''; // On pourrait optimiser en n'ajoutant que les nouveaux
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    renderMessage(msg);
                });
                // Scroll en bas
                chatBody.scrollTop = chatBody.scrollHeight;
            });

            showSecondaryView(chatView);
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatId) return;

            messageInput.value = ''; // Vider input tout de suite (UX)

            try {
                const messagesRef = collection(db, dbPath, 'chats', currentChatId, 'messages');
                await addDoc(messagesRef, {
                    text: text,
                    senderId: currentUserId,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Erreur envoi message:", error);
                showMessage("√âchec d'envoi.", false);
            }
        }

        function renderMessage(msg) {
            const isMe = msg.senderId === currentUserId;
            const date = msg.timestamp ? msg.timestamp.toDate() : new Date();
            const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isMe ? 'sent' : 'received'}`;
            
            msgDiv.innerHTML = `
                <div class="message-row">
                    <div class="message-content">${msg.text}</div>
                </div>
                <div class="message-time">${timeStr}</div>
            `;
            chatBody.appendChild(msgDiv);
        }

        // --- GESTION EMOJIS (NOUVEAU) ---
        function renderEmojis() {
            emojiGrid.innerHTML = EMOJIS.map(emoji => `<span class="emoji-item">${emoji}</span>`).join('');
            
            emojiGrid.onclick = (e) => {
                if (e.target.classList.contains('emoji-item')) {
                    messageInput.value += e.target.textContent;
                }
            };
        }

        // --- FLUX & POSTS ---
        function listenToFeed() {
            if (unsubscribeFeedListener) unsubscribeFeedListener();
            const q = query(postsCollectionRef, orderBy('createdAt', 'desc'));
            unsubscribeFeedListener = onSnapshot(q, (snap) => {
                const now = new Date();
                postsData = [];
                snap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    const d = p.createdAt?.toDate();
                    if(d && d.getTime() > now.getTime() - 86400000) {
                        p.expiresAt = new Date(d.getTime() + 86400000);
                        postsData.push(p);
                    }
                });
                filterAndRenderFeed();
            });
        }
        function filterAndRenderFeed() {
            const term = feedSearchInput.value.toLowerCase();
            filteredPostsData = term ? postsData.filter(p => p.message.toLowerCase().includes(term)) : postsData;
            renderFeed();
        }
        function renderFeed() {
            if (countdownInterval) clearInterval(countdownInterval);
            if (!filteredPostsData.length) { feedContent.innerHTML = "<p style='text-align:center;color:gray;padding:20px;'>Rien ici.</p>"; return; }
            feedContent.innerHTML = filteredPostsData.map(createPostElement).join('');
            countdownInterval = setInterval(updateAllCountdowns, 1000);
        }
        function createPostElement(post) {
            const pub = post.isAnon ? "Anonyme" : (usersData[post.publisherId]?.username || "...");
            const publisherAttr = !post.isAnon && post.publisherId ? `data-publisher-id="${post.publisherId}"` : '';
            
            const rem = post.expiresAt - new Date();
            const txt = rem > 0 ? formatCountdown(rem) : "Fini";
            const l = (post.likedBy||[]).length, d = (post.dislikedBy||[]).length;
            const il = (post.likedBy||[]).includes(currentUserId), id = (post.dislikedBy||[]).includes(currentUserId);
            
            return `<div class="post-card" data-post-id="${post.id}"><div class="post-header"><span class="post-publisher" ${publisherAttr}>${pub}</span><span class="post-countdown" data-expires="${post.expiresAt.getTime()}">${txt}</span></div><div class="post-image-wrapper"><div class="post-content-inner" style="background-color:${post.backgroundColor}"><p class="post-message ${post.fontClass}">${post.message}</p></div></div><div class="post-actions"><div class="action-button ${il?'liked':''}" data-action="like"><i class="fas fa-thumbs-up"></i><span>${l}</span></div><div class="action-button ${id?'disliked':''}" data-action="dislike"><i class="fas fa-thumbs-down"></i><span>${d}</span></div><div class="action-button share-btn" data-action="share"><i class="fas fa-share-square"></i></div></div></div>`;
        }
        function formatCountdown(ms) {
            const s = Math.floor(ms/1000);
            return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
        }
        function updateAllCountdowns() {
            document.querySelectorAll('.post-countdown').forEach(el => {
                const rem = parseInt(el.dataset.expires) - Date.now();
                if(rem>0) el.textContent = formatCountdown(rem); else el.closest('.post-card').remove();
            });
        }
        
        // --- HANDLERS ---
        document.addEventListener('DOMContentLoaded', () => {
            renderEmojis(); // Init Emojis

            navItems.forEach(i => i.addEventListener('click', () => {
                if(i.dataset.view === 'profile-view') { activeProfileUserId = null; showProfile(currentUserId); }
                else navigateTo(i.dataset.view);
            }));
            document.getElementById('my-profile-nav-item').addEventListener('click', () => navigateTo('contacts-view'));
            
            friendSearchInput.addEventListener('input', renderFriendsList);
            feedSearchInput.addEventListener('input', filterAndRenderFeed);

            document.getElementById('edit-bio-btn').addEventListener('click', openEditProfileModal);
            document.getElementById('cancel-edit-btn').addEventListener('click', closeEditProfileModal);
            document.getElementById('save-profile-btn').addEventListener('click', saveProfileChanges);
            
            document.getElementById('create-post-header-btn').addEventListener('click', () => { generatePostColorSwatches(); showSecondaryView(postCreationView); });
            document.getElementById('post-creation-back-btn').addEventListener('click', () => hideSecondaryView(postCreationView));
            postTextarea.addEventListener('input', updateCharCount);
            fontStyleButton.addEventListener('click', handlePostFontChange);
            anonymousSwitch.addEventListener('change', () => isAnonymousPost = anonymousSwitch.checked);
            publishButton.addEventListener('click', handlePublish);
            
            feedContent.addEventListener('click', e => {
                const btn = e.target.closest('.action-button');
                if(btn) handlePostAction(e);

                const publisher = e.target.closest('.post-publisher');
                if(publisher && publisher.dataset.publisherId) {
                    e.stopPropagation(); 
                    showProfile(publisher.dataset.publisherId);
                }
            });
            
            addFriendFab.addEventListener('click', openFriendOptionsMenu);
            document.getElementById('cancel-friend-options-btn').addEventListener('click', closeFriendOptionsMenu);
            document.getElementById('share-profile-link').addEventListener('click', shareProfileLink);
            document.getElementById('show-my-qr').addEventListener('click', showMyQrCode);
            document.getElementById('close-qr-modal-btn').addEventListener('click', closeQrModal);
            document.getElementById('show-friend-requests').addEventListener('click', openFriendRequestsModal);
            document.getElementById('enter-id-manually').addEventListener('click', openPasteIdModal);
            document.getElementById('cancel-paste-id-btn').addEventListener('click', () => hideModal(pasteIdModal));
            document.getElementById('send-friend-request-btn').addEventListener('click', async () => {
                await sendFriendRequest(document.getElementById('paste-id-input').value.trim()); hideModal(pasteIdModal);
            });
            document.getElementById('cancel-friend-requests-btn').addEventListener('click', () => hideModal(friendRequestsModal));
            
            friendRequestsList.addEventListener('click', e => {
                const acc = e.target.closest('.request-accept-btn');
                const rej = e.target.closest('.request-reject-btn');
                if(acc) { acc.disabled=true; acceptFriendRequest(acc.dataset.senderId); }
                else if(rej) { rej.disabled=true; rejectFriendRequest(rej.dataset.senderId); }
            });

            // Chat Listeners
            document.getElementById('chat-back-btn').addEventListener('click', () => hideSecondaryView(chatView));
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
            
            // Emoji Listeners
            emojiBtnTrigger.addEventListener('click', () => {
                if(emojiPopup.classList.contains('active')) emojiPopup.classList.remove('active');
                else emojiPopup.classList.add('active');
            });
            emojiBackButton.addEventListener('click', () => emojiPopup.classList.remove('active'));
        });
        
        // --- FUNCTIONS ---
        function openEditProfileModal() {
            const u = usersData[currentUserId];
            if(!u) return;
            document.getElementById('edit-username-input').value = u.username;
            document.getElementById('edit-bio-textarea').value = u.bio;
            const div = document.getElementById('edit-color-swatches'); div.innerHTML='';
            PROFILE_COLORS.forEach(c => {
                const s = document.createElement('div'); s.className='edit-color-swatch'; s.style.backgroundColor=c; s.dataset.color=c;
                if(c===u.profileColor) s.classList.add('selected');
                s.addEventListener('click', () => { div.querySelector('.selected')?.classList.remove('selected'); s.classList.add('selected'); });
                div.appendChild(s);
            });
            showModal(editProfileModal);
        }
        function closeEditProfileModal() { hideModal(editProfileModal); }
        function openFriendOptionsMenu() { showModal(friendOptionsModal); }
        function closeFriendOptionsMenu() { hideModal(friendOptionsModal); }
        function openPasteIdModal() { hideModal(friendOptionsModal); document.getElementById('paste-id-input').value=''; showModal(pasteIdModal); }
        function openFriendRequestsModal() { hideModal(friendOptionsModal); showModal(friendRequestsModal); renderFriendRequestsList(); }
        function updateCharCount() {
            const l = postTextarea.value.length; charCountSpan.textContent=l;
            publishButton.disabled = l===0 || l>MAX_CHARS;
        }
        function generatePostColorSwatches() {
            const div = document.getElementById('post-color-swatches'); div.innerHTML='';
            POST_COLOR_PALETTE.forEach(c => {
                const s = document.createElement('div'); s.className='color-swatch'; s.style.backgroundColor=c;
                if(c===currentPostColor) s.classList.add('selected');
                s.addEventListener('click', () => { currentPostColor=c; squareContent.style.backgroundColor=c; div.querySelector('.selected')?.classList.remove('selected'); s.classList.add('selected'); });
                div.appendChild(s);
            });
            squareContent.style.backgroundColor = currentPostColor;
        }
        function handlePostFontChange() {
            squareContent.classList.remove(POST_FONT_FAMILIES[currentPostFontIndex]);
            currentPostFontIndex = (currentPostFontIndex+1)%POST_FONT_FAMILIES.length;
            squareContent.classList.add(POST_FONT_FAMILIES[currentPostFontIndex]);
        }
        
        async function saveProfileChanges() {
            const newUsername = document.getElementById('edit-username-input').value.trim();
            const newBio = document.getElementById('edit-bio-textarea').value.trim();
            const selectedColor = document.querySelector('#edit-color-swatches .selected')?.dataset.color;
            if (!newUsername || newUsername.length < 3) return showMessage("Pseudo trop court.", false);
            const userRef = doc(usersCollectionRef, currentUserId);
            try {
                await updateDoc(userRef, { username: newUsername, bio: newBio, profileColor: selectedColor || usersData[currentUserId].profileColor });
                showMessage("Profil mis √† jour !", true);
                closeEditProfileModal();
            } catch (error) { console.error(error); showMessage("Erreur maj profil.", false); }
        }
        
        async function handlePublish() {
            const message = postTextarea.value.trim();
            if (message.length === 0 || message.length > MAX_CHARS) return;
            publishButton.disabled = true;
            try {
                await addDoc(postsCollectionRef, {
                    message: message,
                    publisherId: isAnonymousPost ? null : currentUserId,
                    isAnon: isAnonymousPost,
                    createdAt: serverTimestamp(),
                    backgroundColor: currentPostColor,
                    fontClass: POST_FONT_FAMILIES[currentPostFontIndex],
                    likedBy: [],
                    dislikedBy: []
                });
                const userRef = doc(usersCollectionRef, currentUserId);
                const userDoc = await getDoc(userRef);
                await updateDoc(userRef, { postsCount: (userDoc.data().postsCount || 0) + 1 });
                postTextarea.value = '';
                isAnonymousPost = false;
                anonymousSwitch.checked = false;
                hideSecondaryView(postCreationView);
                showMessage("Post publi√© !", true);
            } catch (error) { console.error(error); showMessage("Echec publication.", false); } finally { publishButton.disabled = false; }
        }

        async function handlePostAction(e) {
            const button = e.target.closest('.action-button');
            if (!button || !currentUserId) return;
            
            const action = button.dataset.action;
            const postCard = e.target.closest('.post-card');
            const postId = postCard.dataset.postId;
            const post = postsData.find(p => p.id === postId);

            if (action === 'share') {
                generateAndShareImage(post);
                return;
            }

            const otherAction = action === 'like' ? 'dislike' : 'like';
            const postRef = doc(postsCollectionRef, postId);
            const firestoreAction = action === 'like' ? 'likedBy' : 'dislikedBy';
            const firestoreOtherAction = otherAction === 'like' ? 'likedBy' : 'dislikedBy';
            const hasAction = post[firestoreAction]?.includes(currentUserId);
            const hasOtherAction = post[firestoreOtherAction]?.includes(currentUserId);

            const batch = writeBatch(db);
            if (hasAction) batch.update(postRef, { [firestoreAction]: arrayRemove(currentUserId) });
            else {
                batch.update(postRef, { [firestoreAction]: arrayUnion(currentUserId) });
                if (hasOtherAction) batch.update(postRef, { [firestoreOtherAction]: arrayRemove(currentUserId) });
            }
            await batch.commit();
        }

        async function generateAndShareImage(post) {
            showMessage("G√©n√©ration de l'image...", true);
            
            captureContainer.innerHTML = '';
            const pub = post.isAnon ? "Anonyme" : (usersData[post.publisherId]?.username || "...");
            
            const card = document.createElement('div');
            card.className = 'capture-card';
            card.style.backgroundColor = post.backgroundColor;
            
            const text = document.createElement('p');
            text.className = `post-message ${post.fontClass}`;
            text.style.position = 'relative'; 
            text.innerText = post.message;
            
            const publisher = document.createElement('div');
            publisher.className = 'capture-publisher';
            publisher.innerText = pub;
            
            const watermark = document.createElement('div');
            watermark.className = 'capture-watermark';
            watermark.innerText = 'Drop';
            
            card.appendChild(publisher);
            card.appendChild(text);
            card.appendChild(watermark);
            captureContainer.appendChild(card);
            
            try {
                const canvas = await html2canvas(card, { 
                    useCORS: true, 
                    scale: 2 
                });
                
                canvas.toBlob(async (blob) => {
                    if (!blob) { showMessage("Erreur image.", false); return; }
                    
                    const file = new File([blob], 'drop_post.png', { type: 'image/png' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'Drop Post',
                                text: `Regarde ce post de ${pub} sur Drop !`
                            });
                        } catch (err) {
                            if (err.name !== 'AbortError') showMessage("Partage annul√© ou impossible.", false);
                        }
                    } else {
                        const a = document.createElement('a');
                        a.href = canvas.toDataURL();
                        a.download = 'drop_post.png';
                        a.click();
                        showMessage("Image t√©l√©charg√©e (Partage non support√©).", true);
                    }
                    captureContainer.innerHTML = '';
                });
            } catch (e) {
                console.error(e);
                showMessage("Erreur lors de la capture.", false);
            }
        }

        async function shareProfileLink() {
            const link = `${BASE_URL}?uid=${currentUserId}`;
            try {
                await navigator.share({
                    title: 'Rejoins-moi sur Drop !',
                    text: `Ajoute-moi sur Drop !`,
                    url: link
                });
            } catch (err) {
                 if (err.name !== 'AbortError') {
                    navigator.clipboard.writeText(link).then(() => showMessage("Lien copi√© !", true));
                 }
            }
        }
        
        function showMyQrCode() {
            const canvas = document.getElementById('qr-code-canvas');
            if (!currentUserId) return showMessage("Erreur ID.", false);
            
            const link = `${BASE_URL}?uid=${currentUserId}`;
            document.getElementById('qr-user-id').textContent = currentUserId; 
            
            QRCode.toCanvas(canvas, link, { width: 200, margin: 2 }, function (error) {
                if (error) return showMessage("Erreur QR.", false);
                closeFriendOptionsMenu();
                showModal(qrCodeModal);
            });
        }

        function closeQrModal() { hideModal(qrCodeModal); }

    </script>
</body>
</html>
